const E=["food","housing","tech","luxury"],P={food:10,housing:50,tech:30,luxury:80},me={food:.15,housing:.2,tech:.8,luxury:1.5},ye={food:2,housing:10,tech:5,luxury:10},be={food:200,housing:500,tech:300,luxury:800},U={food:15,housing:5,tech:10,luxury:8},j=20,ve=1,we=15,ne=500,ke=-200,Me=.7,Ee=.3,Ie=.15,Y=.3,W=500,ae=300,Se={food:.15,housing:.3,tech:.1,luxury:.05},q=100,G=5e3,A=800,N=600,K=.8,z=.2,Te={incomeTax:.25,corporateTax:.21,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.3,unemploymentBenefit:50,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1,fourDayWeek:!1,robotTax:0,breadAndCircuses:!1,mandatoryProfitShare:0,landValueTax:0,banAdvertising:!1,debtJubilee:!1,lotteryRedistribution:!1,sumptuary:!1,degrowth:!1,algoCentralPlanning:!1,universalBankAccount:!1,helicopterMoney:0,maximumWage:0,wealthConfiscation:0,nationalizeIndustries:!1,punitiveTargiffs:0,guaranteedJobs:!1},_e=2e-4,Ce=200,V=10;function d(s,e,t){return Math.max(e,Math.min(t,s))}function m(s=0,e=1){let t=0,o=0;for(;t===0;)t=Math.random();for(;o===0;)o=Math.random();return s+e*Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*o)}function T(s,e){return Math.random()*(e-s)+s}function Re(s){if(!s||s.length===0)return 0;const e=[...s].sort((r,i)=>r-i),t=e.length,o=e.reduce((r,i)=>r+i,0);if(o===0)return 0;let a=0;for(let r=0;r<t;r++)a+=(2*(r+1)-t-1)*e[r];return d(a/(t*o),0,1)}function J(s){return!s||s.length===0?0:s.reduce((e,t)=>e+t,0)/s.length}function xe(s,e){if(!s||s.length===0)return 0;const t=[...s].sort((a,r)=>a-r),o=Math.floor(e/100*(t.length-1));return t[o]}let re=1;const v={CHILD:"child",WORKING:"working",UNEMPLOYED:"unemployed",RETIRED:"retired",BUSINESS_OWNER:"owner",DEAD:"dead"};class F{constructor(e={}){this.id=e.id??re++,this.alive=!0,this.x=e.x??T(20,A-20),this.y=e.y??T(20,N-20),this.vx=0,this.vy=0,this.targetX=this.x,this.targetY=this.y,this.age=e.age??Math.floor(T(936,3380*.6)),this.gender=Math.random()>.5?"M":"F",this.skill=e.skill??d(m(.5,.2),.1,1),this.health=e.health??d(m(.8,.15),.1,1),this.education=e.education??d(m(.5,.25),0,1),this.wealth=e.wealth??d(m(W,ae),10,1/0),this.income=0,this.expenses=0,this.debt=0,this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this.unemployedTicks=0,this.workHistory=[],this.businessId=null,this.isOwner=!1,this.happiness=.5,this.unrest=0,this.socialClass="middle",this.events=[],this.bornInYear=e.bornInYear??0,this.parentWealth=e.parentWealth??W,this.moveTimer=Math.random()*60,this.homeX=this.x,this.homeY=this.y,this.highlight=!1,this.selected=!1,this.deathFade=1,this._updateState()}_updateState(){this.age<936?this.state=v.CHILD:this.age>=3380?this.state=v.RETIRED:this.isOwner?this.state=v.BUSINESS_OWNER:this.employed?this.state=v.WORKING:this.state=v.UNEMPLOYED,this.wealth<q?this.socialClass="poor":this.wealth>=G?this.socialClass="rich":this.socialClass="middle"}tick(e,t){if(this.alive){if(this.age++,this._shouldDie(t)){this._die(e,"natural causes");return}if(this._updateState(),this._move(e),this.state!==v.CHILD&&(this._consumeGoods(e.prices,t),this._earnIncome(t),this._updateHappiness(e,t),this._considerStartingBusiness(e,t)),this.wealth<-500&&this.state!==v.CHILD){this._die(e,"poverty");return}}}_shouldDie(e){if(this.age>=4420)return!0;const t=e.publicHealthcare?.5:1,a=5e-5*(this.age>3380?3:1)*(1-this.health*.5)*t;return Math.random()<a}_die(e,t){if(this.alive=!1,this.state=v.DEAD,this.employed=!1,this.employerId=null,this.deathFade=1,this.events.push(`Died from ${t} at age ${Math.floor(this.age/52)}`),this.wealth>0&&e.agents){const o=e.agents.filter(a=>a.alive&&a.id!==this.id);if(o.length>0){const a=o[Math.floor(Math.random()*o.length)];a.wealth+=this.wealth*.8,a.events.push(`Inherited ${Math.round(this.wealth*.8)} from agent #${this.id}`)}}}_move(e){if(this.moveTimer--,this.moveTimer<=0)if(this.moveTimer=T(30,120),this.employed&&this.employerId&&e.businesses){const r=e.businesses.find(i=>i.id===this.employerId);r?(this.targetX=r.x+m(0,30),this.targetY=r.y+m(0,30)):this._wanderTarget()}else this._wanderTarget();const t=this.targetX-this.x,o=this.targetY-this.y,a=Math.sqrt(t*t+o*o);a>2?(this.vx=t/a*K,this.vy=o/a*K):(this.vx*=.9,this.vy*=.9),this.vx+=(Math.random()-.5)*z,this.vy+=(Math.random()-.5)*z,this.x=d(this.x+this.vx,5,A-5),this.y=d(this.y+this.vy,5,N-5)}_wanderTarget(){this.targetX=d(this.x+m(0,60),10,A-10),this.targetY=d(this.y+m(0,60),10,N-10)}_consumeGoods(e,t){let o=0;const a=this.wage||0;for(const r of["food","housing","tech","luxury"]){let i=Se[r];t[`priceControl${r.charAt(0).toUpperCase()+r.slice(1)}`]&&(i*=.8),r==="luxury"&&this.wealth<q*2&&(i=0);const n=a*i/(e[r]||1)*e[r];o+=n}this.expenses=o,this.wealth-=o*.1}_earnIncome(e){let t=0;if(this.employed&&this.wage>0){const o=e.incomeTax||0;t=this.wage*(1-o)}else this.state===v.UNEMPLOYED&&(e.unemploymentBenefit>0&&(t=e.unemploymentBenefit*.1),this.unemployedTicks++);e.ubi>0&&this.state!==v.CHILD&&(t+=e.ubi*.01),this.income=t,this.wealth+=t}_updateHappiness(e,t){var r;let o=.5;const a=this.wealth/1e3;o+=d(a*.2,-.3,.3),this.employed?o+=.1:o-=.15,((r=e.metrics)==null?void 0:r.gini)>.6&&(o-=.1),t.publicHealthcare&&(o+=.05),this.happiness=d(o,0,1),this.unrest=d(1-this.happiness-.3,0,1)}_considerStartingBusiness(e,t){this.state===v.UNEMPLOYED&&this.wealth>300&&this.skill>.4&&!this.businessId&&Math.random()<3e-5&&(this._wantsToStartBusiness=!0)}hire(e,t){this.employed=!0,this.employerId=e.id,this.wage=t,this.jobSector=e.sector,this.unemployedTicks=0,this.workHistory.push({businessId:e.id,sector:e.sector,wage:t,startAge:this.age}),this.events.push(`Hired at ${e.name} (age ${Math.floor(this.age/52)})`),this._updateState()}fire(e="layoff"){if(this.workHistory.length>0){const t=this.workHistory[this.workHistory.length-1];t.endAge=this.age,t.reason=e}this.events.push(`Lost job (${e}) at age ${Math.floor(this.age/52)}`),this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this._updateState()}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,state:this.state,wealth:this.wealth,age:this.age,skill:this.skill,health:this.health,education:this.education,happiness:this.happiness,unrest:this.unrest,employed:this.employed,employerId:this.employerId,socialClass:this.socialClass,wage:this.wage,jobSector:this.jobSector,isOwner:this.isOwner,businessId:this.businessId,deathFade:this.deathFade,events:this.events.slice(-10)}}}function $(s,e={}){re=1;const t=[];for(let o=0;o<s;o++){const a=e.wealthInequality||1,r=Math.max(10,m(W*(e.wealthMultiplier||1),ae*a));t.push(new F({wealth:r,skill:d(m(e.avgSkill||.5,.2),.05,1),education:d(m(e.avgEducation||.5,.25),0,1),bornInYear:0}))}return t}const L={freeMarket:{id:"freeMarket",name:"Free Market Utopia",subtitle:"No rules. Pure capitalism.",description:"Zero regulation. No minimum wage, no taxes, no safety net. Watch monopolies form naturally and see who wins â€” and who gets left behind.",icon:"ðŸ¦…",difficulty:"Observe",color:"#3b82f6",isHistorical:!1,policies:{incomeTax:0,corporateTax:0,minWage:0,ubi:0,interestRate:.02,antiMonopoly:!1,educationFunding:0,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1.2,wealthInequality:1.5,avgSkill:.5,lesson:"Natural monopolies emerge quickly. The rich get richer. But GDP grows fast at first."},debtSpiral:{id:"debtSpiral",name:"The Debt Spiral",subtitle:"Borrowed too much. Now what?",description:"The government spent heavily on social programs. Debt is high, deficit is growing. Austerity or default â€” pick your poison.",icon:"ðŸ’¸",difficulty:"Hard",color:"#ef4444",isHistorical:!1,policies:{incomeTax:.45,corporateTax:.35,minWage:15,ubi:200,interestRate:.12,antiMonopoly:!0,educationFunding:.8,unemploymentBenefit:150,priceControlFood:!1,priceControlHousing:!1,printMoney:5,publicHealthcare:!0,wealthTax:.02,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.8,wealthInequality:.8,avgSkill:.55,startGovDebt:5e3,lesson:"Cutting programs causes pain now. Keeping them causes pain later. The political economy of austerity."},techDisruption:{id:"techDisruption",name:"Tech Disruption",subtitle:"Automation is coming for jobs.",description:"A stable, balanced economy. Then a tech breakthrough hits â€” half the jobs can be automated. Will you adapt or collapse?",icon:"ðŸ¤–",difficulty:"Medium",color:"#8b5cf6",isHistorical:!1,policies:{incomeTax:.28,corporateTax:.21,minWage:12,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.5,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1,wealthInequality:1,avgSkill:.5,scheduledEvents:[{type:"techBreakthrough",atTick:200}],lesson:"Automation creates wealth but destroys jobs. UBI or retraining â€” which policy saves more people?"},greatDepression:{id:"greatDepression",name:"The Great Depression",subtitle:"October 1929. The markets have collapsed.",description:'GDP has fallen 30%. Unemployment is climbing toward 25%. Banks are failing daily. Hoover says "be patient." Do you agree?',icon:"ðŸ“‰",difficulty:"Very Hard",color:"#78716c",isHistorical:!0,era:"1929â€“1939 Â· United States",durationYears:15,policies:{incomeTax:.02,corporateTax:.12,minWage:0,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.1,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:12,wealthMultiplier:.35,wealthInequality:2,avgSkill:.4,scheduledEvents:[{type:"recession",atTick:1},{type:"financialBubble",atTick:80}],lesson:"Austerity deepened the Depression. FDR's New Deal proved government spending could restart demand."},weimarHyperinflation:{id:"weimarHyperinflation",name:"Weimar Hyperinflation",subtitle:"A loaf of bread costs a wheelbarrow of cash.",description:"Post-WWI Germany is printing money to pay reparations. Inflation is doubling daily. The middle class is being wiped out. Can you stabilize the currency before society collapses?",icon:"ðŸ’¹",difficulty:"Expert",color:"#dc2626",isHistorical:!0,era:"1921â€“1924 Â· Germany",durationYears:10,policies:{incomeTax:.15,corporateTax:.1,minWage:0,ubi:0,interestRate:.01,antiMonopoly:!1,educationFunding:.2,unemploymentBenefit:0,priceControlFood:!0,priceControlHousing:!1,printMoney:40,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:180,businessCount:15,wealthMultiplier:.5,wealthInequality:1.8,avgSkill:.45,scheduledEvents:[],lesson:"Stopping hyperinflation requires cold turkey: halt money printing, issue new credible currency, accept short-term pain."},stagflation1970s:{id:"stagflation1970s",name:"1970s Stagflation",subtitle:"Inflation up. Unemployment up. Nothing works.",description:"OPEC's oil embargo just hit. Prices are surging but the economy is stagnating. Your standard policy tools are pointing in opposite directions. What do you do?",icon:"â›½",difficulty:"Hard",color:"#d97706",isHistorical:!0,era:"1973â€“1982 Â· United States",durationYears:12,policies:{incomeTax:.3,corporateTax:.48,minWage:8,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:8,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.85,wealthInequality:1.1,avgSkill:.5,scheduledEvents:[{type:"cropFailure",atTick:20},{type:"recession",atTick:150}],lesson:"Stagflation broke Keynesian consensus. Volcker's painful rate hikes eventually worked â€” but cost millions their jobs."},crisisOf2008:{id:"crisisOf2008",name:"2008 Financial Crisis",subtitle:"Lehman just failed. The banks are frozen.",description:"The US housing bubble has burst. Banks are insolvent. Credit is frozen. The global economy is in freefall. Bail out the banks, let them fail, or something else?",icon:"ðŸ¦",difficulty:"Hard",color:"#7c3aed",isHistorical:!0,era:"2008â€“2015 Â· Global",durationYears:10,policies:{incomeTax:.28,corporateTax:.35,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:16,wealthMultiplier:.7,wealthInequality:1.6,avgSkill:.5,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:30}],lesson:"Bailouts prevented a depression but rewarded recklessness. The political consequences lasted a decade."},japanLostDecade:{id:"japanLostDecade",name:"Japan's Lost Decade",subtitle:"Zero rates. Zero growth. Zero inflation.",description:"Japan's asset bubble burst in 1991. Interest rates are near zero. Stimulus packages come and go. Nothing works. Can you escape the deflationary trap that trapped Japan for 20 years?",icon:"ðŸ—¾",difficulty:"Expert",color:"#0891b2",isHistorical:!0,era:"1991â€“2010 Â· Japan",durationYears:15,policies:{incomeTax:.33,corporateTax:.38,minWage:6,ubi:0,interestRate:.005,antiMonopoly:!1,educationFunding:.6,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:2,publicHealthcare:!0,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:.9,wealthInequality:.9,avgSkill:.65,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:10}],lesson:"Half-measures and zombie banks prolonged Japan's stagnation for 20 years. Swift, decisive action matters."},nordicMiracle:{id:"nordicMiracle",name:"Build the Nordic Model",subtitle:"High taxes. High trust. High happiness.",description:"You're building a new nation. Can you achieve the Nordic balance: low inequality, high productivity, strong safety net, and sustained growth? This is what success looks like.",icon:"ðŸŒ",difficulty:"Blueprint",color:"#059669",isHistorical:!0,era:"Reference Model Â· Scandinavia",durationYears:20,policies:{incomeTax:.45,corporateTax:.25,minWage:18,ubi:0,interestRate:.03,antiMonopoly:!0,educationFunding:.9,unemploymentBenefit:200,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!0,wealthTax:.01,openBorders:!1,subsidiesFarming:!0},agentCount:200,businessCount:22,wealthMultiplier:1,wealthInequality:.7,avgSkill:.6,avgEducation:.65,scheduledEvents:[],lesson:"The Nordic model requires high institutional trust, universal services, AND open competitive markets. All three."}};function le(s){return L[s]||L.freeMarket}const ce=Object.values(L);ce.filter(s=>!s.isHistorical);ce.filter(s=>s.isHistorical);let he=1;const Oe={food:["FarmFresh","GrainCo","HarvestHub","OrchardInc","FoodWorks","NourishCo"],housing:["ShelterCo","HomeBase","RoofWorks","DwellCo","AbodeLtd","NestBuilders"],tech:["DataSpark","ByteForge","CodeWorks","TechVault","NeuralCo","SyntaxLtd"],luxury:["GoldEdge","EliteCo","PremiumHub","LuxuryInc","OpalWorks","CrestLtd"]};class de{constructor(e={}){this.id=e.id??he++,this.alive=!0,this.sector=e.sector??E[Math.floor(Math.random()*E.length)];const t=Oe[this.sector];this.name=e.name??t[Math.floor(Math.random()*t.length)]+" #"+this.id,this.x=e.x??T(30,A-30),this.y=e.y??T(30,N-30),this.capital=e.capital??ne,this.revenue=0,this.expenses=0,this.profit=0,this.profitHistory=[],this.productivity=e.productivity??d(m(1,.2),.3,2.5),this.production=0,this.price=P[this.sector],this.inventory=0,this.maxInventory=100,this.employees=[],this.maxEmployees=e.maxEmployees??Math.floor(T(ve,we)),this.wageOffered=e.wageOffered??12,this.hiringCooldown=0,this.firingCooldown=0,this.marketShare=0,this.dominance=0,this.ownerId=e.ownerId??null,this.age=0,this.totalProduced=0,this.totalRevenue=0,this.events=[],this.radius=10,this.pulse=0}tick(e,t){this.alive&&(this.age++,this.hiringCooldown=Math.max(0,this.hiringCooldown-1),this.firingCooldown=Math.max(0,this.firingCooldown-1),this._produce(t),this._sellGoods(e.prices),this._payWages(t),this._adjustPriceStrategy(e),this._adjustWorkforce(e,t),this._checkBankruptcy(e),this._updateVisuals())}_produce(e){const t=this.employees.length;if(t===0){this.production=0;return}let o=U[this.sector]*t*this.productivity;e.subsidiesFarming&&this.sector==="food"&&(o*=1.3),e.educationFunding>.5&&(o*=1+e.educationFunding*.1),this.production=Math.floor(o),this.inventory=Math.min(this.inventory+this.production,this.maxInventory),this.totalProduced+=this.production}_sellGoods(e){const t=e[this.sector]||P[this.sector],o=Math.min(this.inventory,Math.floor(this.production*.9));this.revenue=o*t,this.inventory=Math.max(0,this.inventory-o),this.capital+=this.revenue,this.totalRevenue+=this.revenue}_payWages(e){const t=e.minWage||0,a=Math.max(this.wageOffered,t)*this.employees.length;if(this.expenses=a,this.capital-=a,this.profit=this.revenue-this.expenses,this.profitHistory.push(this.profit),this.profitHistory.length>50&&this.profitHistory.shift(),this.profit>0){const r=e.corporateTax||0,i=this.profit*r;this.capital-=i}this.profit>this.revenue*Ie*2?this.wageOffered=Math.min(this.wageOffered*1.02,100):this.profit<0&&this.employees.length>0&&(this.wageOffered=Math.max(this.wageOffered*.98,t))}_adjustPriceStrategy(e){var a;const t=this.wageOffered;this.employees.length>0&&t*this.employees.length/Math.max(this.production,1);const o=this.inventory/this.maxInventory;o>.8?this.price*=.995:o<.2&&this.production>0&&(this.price*=1.005),(a=e.policies)!=null&&a.antiMonopoly&&this.dominance>.4&&(this.price*=.99)}_adjustWorkforce(e,t){const o=this.production>0?Math.min(this.production/(U[this.sector]*this.maxEmployees*this.productivity),1):0;this.hiringCooldown===0&&this.employees.length<this.maxEmployees&&o>Me&&this.capital>this.wageOffered*20&&this._hire(e),this.firingCooldown===0&&this.employees.length>1&&(o<Ee||this.capital<0)&&this._fire(e)}_hire(e){var r;const t=((r=e.agents)==null?void 0:r.filter(i=>i.alive&&!i.employed&&!i.isOwner&&i.state!=="child"&&i.state!=="retired"))||[];if(t.length===0)return;t.sort((i,n)=>n.skill-i.skill);const o=t[0],a=Math.max(this.wageOffered,policies.minWage||0);o.hire(this,a),this.employees.push(o.id),this.hiringCooldown=10,this.events.push(`Hired agent #${o.id}`)}_fire(e){var a;if(this.employees.length===0)return;const t=this.employees[this.employees.length-1];this.employees=this.employees.filter(r=>r!==t);const o=(a=e.agents)==null?void 0:a.find(r=>r.id===t);o&&o.fire("layoff"),this.firingCooldown=15,this.events.push(`Fired agent #${t}`)}_checkBankruptcy(e){this.capital<ke&&this._close(e,"bankruptcy")}_close(e,t){var o,a,r;this.alive=!1,this.events.push(`Closed due to ${t}`);for(const i of this.employees){const n=(o=e.agents)==null?void 0:o.find(c=>c.id===i);n&&n.fire(t)}if(this.employees=[],this.ownerId){const i=(a=e.agents)==null?void 0:a.find(n=>n.id===this.ownerId);i&&(i.isOwner=!1,i.businessId=null,i.events.push(`Business closed (${t}) at age ${Math.floor(i.age/52)}`),(r=i._updateState)==null||r.call(i))}}_updateVisuals(){this.profit>this.revenue*.2?this.pulse=Math.min(1,this.pulse+.05):this.pulse=Math.max(0,this.pulse-.03),this.radius=8+this.employees.length*.5+this.pulse*3}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,sector:this.sector,name:this.name,capital:this.capital,revenue:this.revenue,profit:this.profit,production:this.production,price:this.price,inventory:this.inventory,employees:[...this.employees],employeeCount:this.employees.length,maxEmployees:this.maxEmployees,wageOffered:this.wageOffered,marketShare:this.marketShare,dominance:this.dominance,productivity:this.productivity,age:this.age,radius:this.radius,pulse:this.pulse,ownerId:this.ownerId}}}function X(s,e,t={}){he=1;const o=[],a=Math.floor(s/E.length);for(const r of E)for(let i=0;i<a;i++){const n=new de({sector:r,capital:ne*(t.startCapitalMultiplier||1),productivity:d(m(t.avgProductivity||1,.2),.3,2.5)}),c=e.filter(l=>l.alive&&!l.employed&&!l.isOwner&&l.state!=="child"&&l.state!=="retired"&&l.skill>.4);if(c.length>0){c.sort((p,u)=>u.skill-p.skill);const l=c[0];n.ownerId=l.id,l.isOwner=!0,l.businessId=n.id,l.employed=!0,l.employerId=n.id,l.wage=20,l.jobSector=r,l.state="owner",n.employees.push(l.id)}o.push(n)}return o}function Z(){return{prices:{...P},supply:{food:0,housing:0,tech:0,luxury:0},demand:{food:0,housing:0,tech:0,luxury:0},inflation:0,cpi:100,basePrices:{...P}}}function Ae(s,e,t){const{agents:o,businesses:a}=e,r=o.filter(l=>l.alive&&l.state!=="child"),i=a.filter(l=>l.alive);let n=0;for(const l of E){const p=i.filter(w=>w.sector===l).reduce((w,R)=>w+R.production,0),u=r.filter(w=>w.employed||w.isOwner),y=u.length>0?u.reduce((w,R)=>w+(R.wage||20),0)/u.length:20,_={food:.15,housing:.25,tech:.1,luxury:.05},f=r.length*y*(_[l]||.1);s.supply[l]=p,s.demand[l]=f;const I=Math.max(p,1),g=(f-I)/I,B=me[l];let C=g*B*.05;l==="food"&&t.priceControlFood&&(C=d(C,-.01,.01)),l==="housing"&&t.priceControlHousing&&(C=d(C,-.01,.01)),t.printMoney>0&&(C+=t.printMoney*1e-4);const D=s.prices[l],H=d(D*(1+d(C,-.08,.08)),ye[l],be[l]);s.prices[l]=H;for(const w of i.filter(R=>R.sector===l))w.price=H;n+=(H-D)/D}const c={food:.35,housing:.35,tech:.15,luxury:.15};return s.cpi=E.reduce((l,p)=>l+s.prices[p]/s.basePrices[p]*c[p]*100,0),s.inflation=n/E.length,Ne(i),s}function Ne(s){for(const e of E){const t=s.filter(a=>a.sector===e),o=t.reduce((a,r)=>a+r.production,0);if(o!==0)for(const a of t)a.marketShare=a.production/o,a.dominance=a.marketShare}}function Pe(s,e){return s.businesses.filter(o=>o.alive).reduce((o,a)=>o+a.production*e.prices[a.sector],0)}function Be(s){const e=s.filter(o=>o.alive&&o.state!=="child"&&o.state!=="retired"&&o.state!=="dead");return e.length===0?0:e.filter(o=>o.state==="unemployed").length/e.length}function De(s){const e=s.filter(o=>o.alive&&o.state!=="dead"&&o.state!=="child");return e.length===0?0:e.filter(o=>o.wealth<100).length/e.length}function He(s,e){const{agents:t,businesses:o}=s,a=t.filter(i=>i.alive&&i.state==="unemployed"&&i.age>18*52),r=o.filter(i=>i.alive&&i.employees.length<i.maxEmployees&&i.capital>i.wageOffered*10);if(!(a.length===0||r.length===0))for(const i of r){if(a.length===0)break;let n=0,c=-1/0;for(let u=0;u<a.length;u++){const y=a[u],_=y.x-i.x,f=y.y-i.y,I=Math.sqrt(_*_+f*f),g=y.skill*.7+y.education*.3-I*.001;g>c&&(c=g,n=u)}const l=a[n],p=We(i,l,e);i.capital>p*5&&(l.hire(i,p),i.employees.push(l.id),i.hiringCooldown=10,a.splice(n,1))}}function We(s,e,t){const o=t.minWage||0,a=s.wageOffered,r=e.skill*10+e.education*5,i=a*(1-Y)+r*Y;return Math.max(i,o)}function Q(s={}){return{...Te,...s}}function Ge(s,e,t){var r;const{agents:o,businesses:a}=s;if(e.minWage>0)for(const i of a.filter(n=>n.alive))i.wageOffered<e.minWage&&(i.wageOffered=e.minWage,i.capital<e.minWage*i.employees.length*20);if(e.antiMonopoly)for(const i of a.filter(n=>n.alive&&n.dominance>.5))i.maxEmployees=Math.max(5,Math.floor(i.maxEmployees*.9));if(e.interestRate>.1)for(const i of a.filter(n=>n.alive))i.capital-=i.capital*e.interestRate*.001;if(e.printMoney>0){const i=e.printMoney,n=o.filter(c=>c.alive&&c.state!=="dead");for(const c of n)c.wealth+=i*.01}if(e.educationFunding>.3){const i=o.filter(n=>n.alive&&n.age<1560&&n.state!=="dead");for(const n of i)Math.random()<e.educationFunding*1e-4&&(n.skill=d(n.skill+.001,0,1),n.education=d(n.education+.001,0,1))}if(e.publicHealthcare&&Math.random()<.001){const i=o.filter(n=>n.alive&&n.health<.5);for(const n of i.slice(0,5))n.health=d(n.health+.01,0,1)}if(e.fourDayWeek){for(const i of a.filter(n=>n.alive))i.production=(i.production||1)*.82;if(Math.random()<.01)for(const i of o.filter(n=>n.alive))i.health=d(i.health+5e-4,0,1)}if(e.robotTax>0)for(const i of a.filter(n=>n.alive&&n.sector==="tech")){const n=i.capital*e.robotTax*5e-4;i.capital-=n,s.govBudget=(s.govBudget||0)+n}if(e.breadAndCircuses){if(s.govBudget=(s.govBudget||0)-.5,Math.random()<.02)for(const i of o.filter(n=>n.alive))i.happiness=d((i.happiness||.5)+.002,0,1);s.unrestLevel=Math.max(0,(s.unrestLevel||0)-.001)}if(e.mandatoryProfitShare>0)for(const i of a.filter(n=>{var c;return n.alive&&((c=n.employees)==null?void 0:c.length)>0})){const n=Math.max(0,i.capital*e.mandatoryProfitShare*.001),c=n/i.employees.length;i.capital-=n;for(const l of i.employees){const p=o.find(u=>u.id===l);p&&(p.wealth+=c)}}if(e.landValueTax>0)for(const i of o.filter(n=>n.alive&&n.wealth>100)){const n=i.wealth*e.landValueTax*2e-4;i.wealth-=n,s.govBudget=(s.govBudget||0)+n}if(e.banAdvertising)for(const i of a.filter(n=>n.alive&&n.sector==="luxury"))i.maxEmployees=Math.max(3,Math.floor((i.maxEmployees||10)*.999));if(e.debtJubilee){for(const i of o.filter(n=>n.alive&&n.wealth<0))i.wealth=0;s._jubileeApplied=!0}if(e.lotteryRedistribution&&Math.random()<.05){const i=o.filter(c=>c.alive&&c.wealth>200).sort((c,l)=>l.wealth-c.wealth),n=o.filter(c=>c.alive&&c.wealth<50);if(i.length&&n.length){const c=i[Math.floor(Math.random()*Math.min(10,i.length))],l=n[Math.floor(Math.random()*n.length)],p=c.wealth*.05;c.wealth-=p,l.wealth+=p}}if(e.sumptuary)for(const i of o.filter(n=>n.alive&&n.wealth>300))i._sumptuaryLimited=!0;else for(const i of o.filter(n=>n._sumptuaryLimited))i._sumptuaryLimited=!1;if(e.degrowth&&Math.random()<.005){for(const i of a.filter(n=>n.alive))i.production=(i.production||1)*.999;for(const i of o.filter(n=>n.alive))i.health=d(i.health+1e-4,0,1)}if(e.algoCentralPlanning&&t)for(const i of Object.keys(t.prices||{})){const n=t.prices[i];t.prices[i]=n*.995+(((r=t._algoTarget)==null?void 0:r[i])||n)*.005}if(e.universalBankAccount&&Math.random()<.002)for(const i of o.filter(n=>n.alive&&n.wealth<20))i.wealth=d(i.wealth+.5,0,20);if(e.helicopterMoney>0){const i=e.helicopterMoney*.01;for(const n of o.filter(c=>c.alive))n.wealth+=i;s.govBudget=(s.govBudget||0)-i*o.filter(n=>n.alive).length*.1}if(e.maximumWage>0){for(const i of a.filter(n=>n.alive))i.wageOffered>e.maximumWage&&(i.wageOffered=e.maximumWage);if(Math.random()<.002)for(const i of o.filter(n=>n.alive&&n.skill>.7))i.skill=d(i.skill-.001,0,1)}if(e.wealthConfiscation>0)for(const i of o.filter(n=>n.alive&&n.wealth>1e3)){const n=(i.wealth-1e3)*e.wealthConfiscation*.01;i.wealth-=n,s.govBudget=(s.govBudget||0)+n}if(e.nationalizeIndustries)for(const i of a.filter(n=>n.alive)){i._nationalized=!0;const n=Math.max(e.minWage||10,15);i.wageOffered=n,i.production=(i.production||1)*.92,s.govBudget=(s.govBudget||0)-i.employees.length*n*.001}else for(const i of a.filter(n=>n._nationalized))delete i._nationalized;if(e.punitiveTargiffs>0&&(t!=null&&t.prices))for(const i of Object.keys(t.prices))t.prices[i]*=1+e.punitiveTargiffs*2e-4;if(e.guaranteedJobs){const i=o.filter(n=>n.alive&&!n.employed&&n.age>936);for(const n of i)n.employed=!0,n._govJob=!0,n.wage=Math.max(e.minWage||10,12),n.wealth+=n.wage*.001;s.govBudget=(s.govBudget||0)-i.length*(e.minWage||12)*.001}else for(const i of o.filter(n=>n._govJob))delete i._govJob}function ee(){return{tick:0,year:0,gdp:0,gdpGrowth:0,gini:0,unemployment:0,povertyRate:0,cpi:100,inflation:0,avgWage:0,avgWealth:0,medianWealth:0,socialUnrest:0,population:0,businessCount:0,bankruptcies:0,totalTaxRevenue:0,govBudget:0,govDebt:0,history:{gdp:[],gini:[],unemployment:[],cpi:[],inflation:[],population:[],unrest:[],wages:[],poverty:[],govBudget:[],businessCount:[],medianWealth:[],sectorPrices:{food:[],housing:[],tech:[],luxury:[]}}}}function Fe(s,e,t,o){var I;const{agents:a,businesses:r}=e,i=a.filter(g=>g.alive&&g.state!=="dead"),n=r.filter(g=>g.alive);s.tick++,s.year=Math.floor(s.tick/52),s.population=i.length,s.businessCount=n.length;const c=i.map(g=>Math.max(0,g.wealth));s.gini=Re(c),s.avgWealth=J(c),s.medianWealth=xe(c,50);const l=s.gdp;s.gdp=Pe(e,t),s.gdpGrowth=l>0?(s.gdp-l)/l:0,s.unemployment=Be(i),s.povertyRate=De(i);const p=i.filter(g=>g.employed&&g.wage>0);s.avgWage=p.length>0?p.reduce((g,B)=>g+B.wage,0)/p.length:0,s.cpi=t.cpi,s.inflation=t.inflation*100;const u=i.map(g=>g.unrest);s.socialUnrest=J(u);const y=Le(i,n,o),_=Ue(i,o);s.totalTaxRevenue=y,s.govBudget=y-_,s.govDebt+=-s.govBudget*.1;const f=s.history;b(f.gdp,s.gdp),b(f.gini,s.gini),b(f.unemployment,s.unemployment*100),b(f.cpi,s.cpi),b(f.inflation,s.inflation),b(f.population,s.population),b(f.unrest,s.socialUnrest*100),b(f.wages,s.avgWage),b(f.poverty,s.povertyRate*100),b(f.govBudget,s.govBudget),b(f.businessCount,s.businessCount),b(f.medianWealth,s.medianWealth),f.sectorPrices||(f.sectorPrices={food:[],housing:[],tech:[],luxury:[]});for(const g of["food","housing","tech","luxury"])b(f.sectorPrices[g],((I=t.prices)==null?void 0:I[g])||0);return s}function b(s,e){s.push(Math.round(e*100)/100),s.length>Ce&&s.shift()}function Le(s,e,t){const o=s.filter(i=>i.employed&&i.wage>0).reduce((i,n)=>i+n.wage*(t.incomeTax||0),0),a=e.filter(i=>i.profit>0).reduce((i,n)=>i+n.profit*(t.corporateTax||0),0),r=s.filter(i=>i.wealth>G).reduce((i,n)=>i+(n.wealth-G)*(t.wealthTax||0),0);return o+a+r}function Ue(s,e){const o=s.filter(n=>n.state==="unemployed").length*(e.unemploymentBenefit||0)*.1,a=s.filter(n=>n.state!=="child").length*(e.ubi||0)*.01,r=e.publicHealthcare?s.length*.5:0,i=s.length*(e.educationFunding||0)*.2;return o+a+r+i}function O(s){return{tick:s.tick,year:s.year,gdp:s.gdp,gdpGrowth:s.gdpGrowth,gini:s.gini,unemployment:s.unemployment,povertyRate:s.povertyRate,cpi:s.cpi,inflation:s.inflation,avgWage:s.avgWage,avgWealth:s.avgWealth,medianWealth:s.medianWealth,socialUnrest:s.socialUnrest,population:s.population,businessCount:s.businessCount,govDebt:s.govDebt,totalTaxRevenue:s.totalTaxRevenue,history:s.history}}const h={PANDEMIC:"pandemic",CROP_FAILURE:"cropFailure",TECH_BREAKTHROUGH:"techBreakthrough",FINANCIAL_BUBBLE:"financialBubble",CORRUPTION:"corruption",IMMIGRATION_WAVE:"immigrationWave",RECESSION:"recession",BOOM:"boom",HYPERINFLATION:"hyperinflation",GENERAL_STRIKE:"generalStrike",BANK_RUN:"bankRun",BRAIN_DRAIN:"brainDrain"},ue={[h.PANDEMIC]:{name:"Pandemic",description:"A disease is spreading fast. How do you respond?",duration:200,icon:"ðŸ¦ ",effects:{healthMultiplier:.7,productionMultiplier:.6,deathRateMultiplier:3,consumerSpendingMultiplier:.5},choices:[{id:"lockdown",label:"Lockdown",emoji:"ðŸ ",description:"Shut down non-essential businesses. Mandate isolation.",tradeoff:"Saves lives, fewer deaths. GDP falls sharply. Unemployment spikes short-term.",historicalNote:"COVID lockdowns (2020) saved millions but triggered the sharpest recession since WWII.",effectOverride:{healthMultiplier:.95,productionMultiplier:.4,deathRateMultiplier:1.2,duration:150}},{id:"herd_immunity",label:"Herd Immunity",emoji:"ðŸ§¬",description:"Keep the economy open. Let the disease spread to build immunity.",tradeoff:"Economy keeps running. Much higher death toll. Healthcare system may collapse.",historicalNote:"Sweden's initial COVID approach â€” lower short-term GDP hit but higher deaths.",effectOverride:{healthMultiplier:.5,productionMultiplier:.8,deathRateMultiplier:5,duration:250}},{id:"targeted_support",label:"Targeted Support",emoji:"ðŸ’‰",description:"Protect vulnerable groups. Support businesses. Invest in healthcare.",tradeoff:"Balanced outcome. Costs significant government spending.",historicalNote:"Germany's Kurzarbeit (short-work) scheme kept unemployment low during COVID.",effectOverride:{healthMultiplier:.8,productionMultiplier:.65,deathRateMultiplier:1.8,duration:180},govDebtPenalty:1e3}]},[h.CROP_FAILURE]:{name:"Crop Failure",description:"Severe drought has decimated harvests. Food prices are spiking. The poor can't eat. What do you do?",duration:150,icon:"ðŸŒ¾",effects:{foodSupplyMultiplier:.3,foodPriceMultiplier:2.5},choices:[{id:"food_aid",label:"Emergency Food Aid",emoji:"ðŸž",description:"Government distributes food and subsidizes prices for low-income households.",tradeoff:"Prevents starvation and unrest. Costs government significantly. Doesn't fix supply.",historicalNote:"US food stamps (1939, expanded 1961) prevented widespread malnutrition during agricultural crises.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.4,duration:120},govDebtPenalty:600},{id:"price_controls_food",label:"Cap Food Prices",emoji:"ðŸ·ï¸",description:"Legally limit how much food can cost. Sellers cannot raise prices above the cap.",tradeoff:"Keeps food accessible short-term. Reduces farmer incentives â€” may worsen next harvest.",historicalNote:"USSR price controls kept bread cheap but caused chronic shortages and black markets.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.1,duration:200},policyOverrides:{priceControlFood:!0}},{id:"import_food",label:"Open Food Imports",emoji:"ðŸš¢",description:"Remove trade barriers on food. International supply fills the gap.",tradeoff:"Quickly stabilizes prices. Hurts domestic farmers long-term. Adds trade dependency.",historicalNote:"Ireland's famine (1845) was worsened by British refusal to halt food exports. Open imports could have saved millions.",effectOverride:{foodSupplyMultiplier:.8,foodPriceMultiplier:1.3,duration:100},policyOverrides:{openBorders:!0}}]},[h.TECH_BREAKTHROUGH]:{name:"Tech Breakthrough",description:"A new technology could double productivity â€” but automate 20% of jobs. How do you respond to this disruption?",duration:300,icon:"ðŸš€",effects:{techProductivityMultiplier:2,techWorkerWageMultiplier:1.5,otherJobsAutomatedRate:.1},choices:[{id:"embrace_tech",label:"Embrace It Fully",emoji:"ðŸ¤–",description:"Let the market adopt technology at full speed. No restrictions.",tradeoff:"Maximum GDP growth. Rapid job displacement. High inequality surge.",historicalNote:"Industrial Revolution (1760s+): enormous long-term gains, but decades of worker misery before adaptation.",effectOverride:{techProductivityMultiplier:2.5,techWorkerWageMultiplier:2,otherJobsAutomatedRate:.25,duration:300}},{id:"managed_transition",label:"Managed Transition",emoji:"ðŸŽ“",description:"Tax tech gains, fund retraining programs and transition support for displaced workers.",tradeoff:"Slower adoption but smoother adjustment. Higher government cost. Better long-term stability.",historicalNote:`Germany's "Kurzarbeit" and Denmark's "flexicurity" â€” managed disruption with strong safety nets.`,effectOverride:{techProductivityMultiplier:1.7,techWorkerWageMultiplier:1.3,otherJobsAutomatedRate:.08,duration:250},govDebtPenalty:800,policyOverrides:{educationFunding:.8,unemploymentBenefit:150}},{id:"restrict_automation",label:"Regulate Automation",emoji:"â›”",description:"Limit how quickly companies can replace workers with machines. Robot tax.",tradeoff:"Protects jobs short-term. Slows GDP growth. May fall behind globally.",historicalNote:"Luddites (1811) destroyed textile machinery. Short-term protection, but technology won eventually.",effectOverride:{techProductivityMultiplier:1.2,techWorkerWageMultiplier:1.1,otherJobsAutomatedRate:.03,duration:350}}]},[h.FINANCIAL_BUBBLE]:{name:"Financial Bubble",description:"Asset prices are wildly inflated. A crash appears imminent. How do you respond?",duration:250,icon:"ðŸ’¥",effects:{wealthInflationPhase:1.5,wealthCrashPhase:.4},choices:[{id:"let_it_burn",label:"Let It Burn",emoji:"ðŸ”¥",description:"No intervention. Let markets correct naturally.",tradeoff:"Short, sharp crash. High unemployment spike. Faster long-term recovery.",historicalNote:"Hoover's approach in 1929 â€” worsened the Depression when banks also failed.",effectOverride:{wealthCrashPhase:.25,duration:150}},{id:"bailout",label:"Bail Out Banks",emoji:"ðŸ¦",description:"Government buys toxic assets. Prevent bank collapse.",tradeoff:"Softer crash, but adds massive debt and rewards recklessness. Slow recovery.",historicalNote:"TARP (2008) â€” prevented depression but caused lasting public anger.",effectOverride:{wealthCrashPhase:.6,duration:350},govDebtPenalty:2e3},{id:"regulate",label:"Emergency Controls",emoji:"âš–ï¸",description:"Freeze credit, impose capital controls, force write-downs.",tradeoff:"Medium crash severity. Suppresses growth for years but prevents another bubble.",historicalNote:"Sweden 1992: nationalized banks, forced writedowns, recovered fully in 3 years.",effectOverride:{wealthCrashPhase:.45,duration:200},policyOverrides:{antiMonopoly:!0,interestRate:.08}}]},[h.CORRUPTION]:{name:"Corruption Scandal",description:"Government corruption diverts tax revenue. Public services collapse.",duration:180,icon:"ðŸ’°",effects:{taxRevenueLeakage:.5,publicTrustMultiplier:.6}},[h.IMMIGRATION_WAVE]:{name:"Immigration Wave",description:"Skilled workers arrive, boosting productivity but increasing competition for jobs.",duration:0,icon:"ðŸŒ",effects:{newAgentCount:30,newAgentSkillBonus:.3}},[h.RECESSION]:{name:"Recession",description:"The economy is contracting. Businesses are cutting, unemployment is rising. What's your response?",duration:200,icon:"ðŸ“‰",effects:{demandMultiplier:.6,businessCapitalDrain:.02,hiringSuppression:!0},choices:[{id:"stimulus",label:"Stimulus Package",emoji:"ðŸ’µ",description:"Government spending on infrastructure, public jobs, and direct payments.",tradeoff:"Kickstarts demand. Adds to government debt. May cause mild inflation.",historicalNote:"FDR's New Deal (1933), Obama's ARRA (2009), Biden's ARP (2021) â€” all used stimulus to end recessions.",effectOverride:{demandMultiplier:.85,businessCapitalDrain:.01,hiringSuppression:!1,duration:130},govDebtPenalty:1500},{id:"austerity",label:"Austerity",emoji:"âœ‚ï¸",description:"Cut government spending. Reduce deficit. Let weak firms fail.",tradeoff:"Improves budget balance. Deepens recession short-term. May extend recovery by years.",historicalNote:"UK and EU austerity (2010-2015) extended the recession and caused a lost generation of unemployment.",effectOverride:{demandMultiplier:.45,businessCapitalDrain:.04,hiringSuppression:!0,duration:280},policyOverrides:{unemploymentBenefit:0,educationFunding:.1}},{id:"rate_cut",label:"Cut Interest Rates",emoji:"ðŸ¦",description:"Lower borrowing costs to encourage investment and spending.",tradeoff:"Helps businesses invest. Limited effect if rates are already near zero.",historicalNote:"Fed cut rates to near-zero in 2008 and 2020 â€” effective, but creates risk of asset bubbles.",effectOverride:{demandMultiplier:.72,businessCapitalDrain:.01,hiringSuppression:!1,duration:160},policyOverrides:{interestRate:.005}}]},[h.BOOM]:{name:"Economic Boom",description:"Consumer confidence surges. Spending rises, businesses thrive.",duration:150,icon:"ðŸ“ˆ",effects:{demandMultiplier:1.4,hiringBoost:!0,wageGrowthRate:1.02}},[h.HYPERINFLATION]:{name:"Hyperinflation Spiral",description:"Prices are doubling every few weeks. Currency is losing value faster than anyone can spend it. People are using wheelbarrows of cash to buy bread. What do you do?",duration:300,icon:"ðŸ’¸",effects:{priceMultiplierPerTick:1.008,wageErosionRate:.005,savingsDestructionRate:.01},choices:[{id:"currency_reform",label:"Currency Reform",emoji:"ðŸª™",description:"Issue a new currency. Peg it to gold or a foreign reserve. Immediately restore confidence â€” if anyone believes you.",tradeoff:"Stops inflation fast. Requires credibility and foreign reserves. Painful one-time wealth reset.",historicalNote:"Germany's 1923 Rentenmark replaced the worthless Mark overnight. Inflation stopped within weeks â€” but required complete institutional trust.",effectOverride:{priceMultiplierPerTick:1,wageErosionRate:0,savingsDestructionRate:0,duration:50},govDebtPenalty:500},{id:"interest_rate_shock",label:"Shock Interest Rates",emoji:"ðŸ¦",description:"Raise interest rates to 20%+. Crush demand. Stop the money printing. It will cause a severe recession.",tradeoff:"Kills inflation but triggers mass unemployment and recession. Volcker shock medicine.",historicalNote:"Paul Volcker (1980-82) raised US rates to 20% to kill stagflation. Inflation died. So did 2 years of growth.",effectOverride:{priceMultiplierPerTick:1.001,wageErosionRate:.002,savingsDestructionRate:.003,duration:150},policyOverrides:{interestRate:.2,printMoney:0}},{id:"price_freeze",label:"Emergency Price Freeze",emoji:"ðŸ§Š",description:"Legally freeze all prices where they are. Sounds good. Historically causes shortages, black markets, and collapse within months.",tradeoff:"Appears to stop inflation on paper. Creates chronic shortages and black markets.",historicalNote:"Nixon's 1971 price controls temporarily stopped inflation â€” then it came back worse. Venezuela's price controls in 2010s caused empty supermarkets.",effectOverride:{priceMultiplierPerTick:1,wageErosionRate:.003,savingsDestructionRate:.008,duration:400},policyOverrides:{priceControlFood:!0,priceControlHousing:!0}}]},[h.GENERAL_STRIKE]:{name:"General Strike",description:"Workers across every sector have walked off the job. Production has stopped. Shelves are emptying. The labor movement is demanding radical change. How do you respond?",duration:180,icon:"âœŠ",effects:{productionMultiplier:.1,businessCapitalDrain:.03,unrestLevel:.8},choices:[{id:"negotiate",label:"Negotiate with Workers",emoji:"ðŸ¤",description:"Meet with union leaders. Accept major wage increases and worker protections. End the strike through concessions.",tradeoff:"Strike ends quickly. Wages rise significantly. Businesses face higher costs. May trigger inflation.",historicalNote:"UK 1926 General Strike ended after 9 days. Government conceded little. Workers returned defeated. France 1968 â€” de Gaulle negotiated wage increases of 35%.",effectOverride:{productionMultiplier:.9,businessCapitalDrain:.005,unrestLevel:.2,duration:80},policyOverrides:{minWage:18}},{id:"crack_down",label:"Call In the Military",emoji:"ðŸª–",description:"Declare the strike illegal. Deploy security forces to reopen businesses. Arrest strike leaders.",tradeoff:"Strike ends by force. Short-term production resumes. Generates massive unrest. Long-term labor relations destroyed.",historicalNote:"Tsar Nicholas II cracked down on 1905 strikes. Workers returned, resentment grew, revolution followed 12 years later.",effectOverride:{productionMultiplier:.7,businessCapitalDrain:.01,unrestLevel:.95,duration:100}},{id:"meet_demands",label:"Meet All Demands",emoji:"ðŸ“‹",description:"Full capitulation. Massive wage increases, worker ownership rights, reduced hours. Businesses will struggle to absorb the costs.",tradeoff:"Strike ends immediately. Workers are ecstatic. Many businesses go bankrupt within months.",historicalNote:"Bolivia's 1952 revolution saw workers seize mines. Production collapsed 40% initially before new management stabilized.",effectOverride:{productionMultiplier:.95,businessCapitalDrain:.02,unrestLevel:.05,duration:50},policyOverrides:{minWage:25,mandatoryProfitShare:.2}}]},[h.BANK_RUN]:{name:"Bank Run",description:"Citizens are lining up to withdraw everything from the banks. The financial system has 48 hours before it collapses completely. Businesses cannot make payroll. What do you do?",duration:200,icon:"ðŸ¦",effects:{wealthDestructionRate:.04,businessCapitalCrash:.5,hiringSuppression:!0},choices:[{id:"deposit_guarantee",label:"Guarantee All Deposits",emoji:"ðŸ›¡ï¸",description:"Government guarantees every citizen's deposits are safe. Panic stops immediately. Costs are enormous.",tradeoff:"Stops the run instantly. Restores confidence. Massive contingent liability on the government.",historicalNote:"FDR's FDIC (1933) deposit guarantee ended the Great Depression bank runs overnight. Still the gold standard.",effectOverride:{wealthDestructionRate:.002,businessCapitalCrash:.9,hiringSuppression:!1,duration:50},govDebtPenalty:3e3},{id:"bank_holiday",label:"Declare a Bank Holiday",emoji:"ðŸšª",description:"Close all banks for a week. Force a pause. Use the time to audit, restructure, or recapitalize.",tradeoff:"Buys time but deepens the panic. Economic activity freezes completely during the holiday.",historicalNote:"FDR declared a bank holiday in March 1933. When banks reopened 4 days later, the runs had stopped â€” but the pause was painful.",effectOverride:{wealthDestructionRate:.01,businessCapitalCrash:.3,hiringSuppression:!0,duration:150},govDebtPenalty:1e3},{id:"let_banks_fail",label:"Let Them Fail",emoji:"ðŸ’€",description:"No bailouts. Insolvent banks deserve to collapse. Creative destruction will rebuild stronger institutions.",tradeoff:"Short-term economic catastrophe. Possibly long-term healthy reset. Historically devastating.",historicalNote:'Hoover let 4,000 US banks fail 1930-33. GDP fell 30%. Unemployment hit 25%. "Creative destruction" was not creative.',effectOverride:{wealthDestructionRate:.06,businessCapitalCrash:.15,hiringSuppression:!0,duration:350}}]},[h.BRAIN_DRAIN]:{name:"Brain Drain",description:"Your most skilled workers are leaving. High taxes, low opportunity, political instability â€” whatever the reason, talent is exiting fast. Businesses are struggling to fill key roles.",duration:250,icon:"ðŸ§ ",effects:{skillErosionRate:.002,highSkillExitProbability:.01,productivityDecay:.998},choices:[{id:"talent_incentives",label:"Talent Retention Package",emoji:"ðŸ’°",description:"Tax breaks and bonuses for high-skill workers. Make staying worth their while.",tradeoff:"Slows emigration. Costs revenue. Creates a two-tier tax system that others resent.",historicalNote:"Ireland's special artist tax exemption attracted many creatives. Singapore's talent visa system draws global elites.",effectOverride:{skillErosionRate:3e-4,highSkillExitProbability:.001,productivityDecay:.9995,duration:150},govDebtPenalty:600},{id:"open_immigration",label:"Open Skilled Immigration",emoji:"ðŸŒ",description:"Replace departing talent with immigrants. Fast-track visas for skilled workers globally.",tradeoff:"Partially offsets the drain. Different skills may not perfectly match. Cultural adjustment takes time.",historicalNote:"Canada's points-based immigration system and the US H-1B visa program replace brain drain with brain gain.",effectOverride:{skillErosionRate:.001,highSkillExitProbability:.005,productivityDecay:.999,duration:200},policyOverrides:{openBorders:!0}},{id:"ignore_it",label:"Let Them Leave",emoji:"ðŸ‘‹",description:"Good riddance to elites. The working class will step up. Skills can be rebuilt from within.",tradeoff:"No cost. Significant long-term productivity collapse as expertise exits permanently.",historicalNote:"Zimbabwe's post-2000 land reform drove out skilled farmers and professionals. GDP fell 50%. 3 million skilled workers fled.",effectOverride:{skillErosionRate:.004,highSkillExitProbability:.02,productivityDecay:.993,duration:400}}]}};function te(){return{activeEvents:[],eventHistory:[],lastEventTick:0}}function ie(s,e,t,o,a=null){s.activeEvents=s.activeEvents.filter(i=>i.definition.duration===0?!0:o-i.startTick<i.definition.duration);let r=null;if(a)r=Ye(s,e,t,o,a);else{const i=_e*(1-s.activeEvents.length*.3);Math.random()<i&&o>s.lastEventTick+100&&(r=qe(s,e,t,o))}if(r!=null&&r.requiresChoice)return r;for(const i of s.activeEvents)ze(i,e,t,o);return r}function je(s,e,t,o){var i;const a=s.pendingChoiceEvent;if(!a||a.id!==e)return;const r=(i=a.definition.choices)==null?void 0:i.find(n=>n.id===t);r&&(r.effectOverride&&(Object.assign(a.definition.effects,r.effectOverride),r.effectOverride.duration!==void 0&&(a.definition.duration=r.effectOverride.duration)),r.policyOverrides&&Object.assign(o.policies,r.policyOverrides),r.govDebtPenalty&&o.metrics&&(o.metrics.govDebt=(o.metrics.govDebt||0)+r.govDebtPenalty),a.choiceMade=t,a.requiresChoice=!1,fe(a,o),s.activeEvents.push(a),s.pendingChoiceEvent=null)}function Ye(s,e,t,o,a){const r=ue[a];return r?pe(s,e,o,a,r):null}function qe(s,e,t,o){const a=e.metrics||{},r={[h.PANDEMIC]:1,[h.CROP_FAILURE]:1,[h.TECH_BREAKTHROUGH]:1.5,[h.FINANCIAL_BUBBLE]:a.gini>.5?2:.5,[h.CORRUPTION]:a.govDebt>1e3?2:.5,[h.IMMIGRATION_WAVE]:t.openBorders?3:.5,[h.RECESSION]:a.inflation>5?2:.3,[h.BOOM]:a.unemployment<.05?2:.5,[h.HYPERINFLATION]:t.printMoney>20||a.inflation>10?3:.3,[h.GENERAL_STRIKE]:a.gini>.55?2:a.unemployment>.15?1.5:.3,[h.BANK_RUN]:a.govDebt>3e3||a.inflation>8?2:.3,[h.BRAIN_DRAIN]:t.wealthConfiscation>.1||t.maximumWage>0?2:.4},i=Object.keys(r),n=i.map(u=>r[u]),c=n.reduce((u,y)=>u+y,0);let l=Math.random()*c,p=i[0];for(let u=0;u<i.length;u++)if(l-=n[u],l<=0){p=i[u];break}return pe(s,e,o,p,ue[p])}const Ke={id:"do_nothing",label:"Do Nothing",emoji:"ðŸ¤·",description:"No intervention. Let the situation play out without government action.",tradeoff:"Preserves budget and avoids unintended consequences â€” but cedes control to market forces.",historicalNote:"Doing nothing is itself a policy choice. Hoover (1929), ECB (2010-12), and many others chose inaction with lasting consequences.",effectOverride:null};function pe(s,e,t,o,a){var i;const r={id:`${o}_${t}`,type:o,definition:{...a,effects:{...a.effects}},startTick:t,name:a.name,description:a.description,icon:a.icon};return s.lastEventTick=t,s.eventHistory.push({id:r.id,name:a.name,icon:a.icon,tick:t}),((i=a.choices)==null?void 0:i.length)>0?(a.choices.some(c=>c.id==="do_nothing")||(r.definition={...r.definition,choices:[...a.choices,Ke]}),r.requiresChoice=!0,s.pendingChoiceEvent=r,r):(s.activeEvents.push(r),fe(r,e),r)}function fe(s,e){const{effects:t}=s.definition,o=e.agents.filter(r=>r.alive),a=e.businesses.filter(r=>r.alive);switch(s.type){case h.PANDEMIC:for(const r of o)r.health*=.8+Math.random()*.2,r.health=d(r.health,.1,1);break;case h.IMMIGRATION_WAVE:s._spawnAgents=t.newAgentCount,s._spawnSkillBonus=t.newAgentSkillBonus;break;case h.FINANCIAL_BUBBLE:s.phase="inflate",s.phaseStartTick=s.startTick;break;case h.TECH_BREAKTHROUGH:for(const r of a.filter(i=>i.sector==="tech"))r.productivity*=t.techProductivityMultiplier;break;case h.BANK_RUN:for(const r of a)r.capital*=t.businessCapitalCrash;for(const r of o)r.wealth*=1-t.wealthDestructionRate*5,r.wealth=Math.max(0,r.wealth);break;case h.GENERAL_STRIKE:for(const r of a)r.production=(r.production||1)*.15;break;case h.BRAIN_DRAIN:{const r=o.filter(n=>n.skill>.75).sort((n,c)=>c.skill-n.skill),i=Math.floor(r.length*.15);for(const n of r.slice(0,i))n.alive=!1}break}}function ze(s,e,t,o){var n;const{effects:a}=s.definition,r=o-s.startTick,i=s.definition.duration>0?r/s.definition.duration:0;switch(s.type){case h.PANDEMIC:if(Math.random()<.01)for(const c of e.businesses.filter(l=>l.alive))c.capital-=c.capital*.005;break;case h.FINANCIAL_BUBBLE:if(i<.5){if(Math.random()<.05)for(const c of e.agents.filter(l=>l.alive&&l.wealth>500))c.wealth*=1.01}else if(s.phase==="inflate"){s.phase="crash";for(const c of e.agents.filter(l=>l.alive))c.wealth*=a.wealthCrashPhase+Math.random()*.3}break;case h.RECESSION:if(Math.random()<.1)for(const c of e.businesses.filter(l=>l.alive))c.capital-=c.capital*a.businessCapitalDrain;break;case h.BOOM:if(Math.random()<.05)for(const c of e.businesses.filter(l=>l.alive))c.wageOffered*=a.wageGrowthRate;break;case h.HYPERINFLATION:if((n=e.market)!=null&&n.prices)for(const c of Object.keys(e.market.prices))e.market.prices[c]*=a.priceMultiplierPerTick;if(Math.random()<.1)for(const c of e.agents.filter(l=>l.alive&&l.wealth>0))c.wealth*=1-a.savingsDestructionRate;break;case h.GENERAL_STRIKE:if(Math.random()<.15)for(const c of e.businesses.filter(l=>l.alive))c.capital-=c.capital*a.businessCapitalDrain;break;case h.BANK_RUN:if(Math.random()<.05)for(const c of e.agents.filter(l=>l.alive))c.wealth*=1-a.wealthDestructionRate,c.wealth=Math.max(0,c.wealth);break;case h.BRAIN_DRAIN:if(Math.random()<.02){const c=e.agents.filter(l=>l.alive&&l.skill>.6);for(const l of c)l.skill=d(l.skill-a.skillErosionRate,0,1),Math.random()<a.highSkillExitProbability&&(l.alive=!1)}break}}const se={greatDepression:[{id:"restore_employment",label:"Restore Employment",description:"Bring unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:52*2,weight:.4,icon:"ðŸ‘·",tip:"Government work programs, public investment, and lower interest rates historically helped."},{id:"gdp_recovery",label:"GDP Recovery",description:"Grow GDP back to starting level",metric:"gdp",operator:"gt_initial",threshold:1,sustainTicks:0,weight:.4,icon:"ðŸ“ˆ",tip:"Demand-side stimulus: UBI, public spending, and low interest rates can restart growth."},{id:"prevent_deflation",label:"Stop Deflation",description:"Keep CPI above 90 (avoid deflationary spiral)",metric:"cpi",operator:"gt",threshold:90,sustainTicks:52,weight:.2,icon:"ðŸ¦",tip:"Deflation is self-reinforcing â€” people delay spending, worsening the cycle. QE can help."}],weimarHyperinflation:[{id:"tame_inflation",label:"Tame Hyperinflation",description:"Bring inflation below 5% and hold for 3 years",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*3,weight:.5,icon:"ðŸ”¥",tip:"Stop money printing immediately. High interest rates are painful but necessary."},{id:"restore_trust",label:"Restore Public Trust",description:"Reduce social unrest below 30%",metric:"socialUnrest",operator:"lt",threshold:.3,sustainTicks:52,weight:.3,icon:"ðŸ¤",tip:"People need to believe the currency holds value. Actions speak louder than promises."},{id:"employment_stability",label:"Employment Stability",description:"Hold unemployment below 15%",metric:"unemployment",operator:"lt",threshold:.15,sustainTicks:0,weight:.2,icon:"âš–ï¸",tip:"Stabilizing the currency will disrupt employment â€” the question is how much."}],stagflation1970s:[{id:"tame_inflation_s",label:"Control Inflation",description:"Bring inflation below 5%",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*2,weight:.4,icon:"ðŸ”¥",tip:"High interest rates cure inflation â€” but cause a recession. Timing matters."},{id:"limit_unemployment_s",label:"Limit Unemployment",description:"Keep unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:0,weight:.35,icon:"ðŸ‘·",tip:"The classic dilemma: fixing inflation worsens unemployment and vice versa."},{id:"gdp_positive",label:"Avoid Recession",description:"Keep GDP growth positive",metric:"gdpGrowth",operator:"gt",threshold:0,sustainTicks:52,weight:.25,icon:"ðŸ“Š",tip:"Near impossible to avoid entirely â€” the question is how deep the recession goes."}],crisisOf2008:[{id:"prevent_depression",label:"Prevent Depression",description:"Keep unemployment below 12%",metric:"unemployment",operator:"lt",threshold:.12,sustainTicks:0,weight:.35,icon:"ðŸ¦",tip:"Bank bailouts and fiscal stimulus are expensive but prevent cascading failures."},{id:"restore_growth_08",label:"Restore Growth",description:"Return GDP to pre-crisis level within 10 years",metric:"gdp",operator:"gt_initial",threshold:.95,sustainTicks:0,weight:.35,icon:"ðŸ“ˆ",tip:"Austerity prolongs recessions. Targeted stimulus accelerates recovery."},{id:"inequality_check",label:"Prevent Inequality Surge",description:"Keep Gini below 0.55",metric:"gini",operator:"lt",threshold:.55,sustainTicks:0,weight:.3,icon:"âš–ï¸",tip:"Bailouts that save banks but not homeowners cause lasting inequality damage."}],japanLostDecade:[{id:"escape_deflation",label:"Escape Deflation",description:"Keep CPI above 95 for 5 years",metric:"cpi",operator:"gt",threshold:95,sustainTicks:52*5,weight:.4,icon:"ðŸ“‰",tip:"Zero interest rates alone aren't enough. QE, fiscal spending, and structural reform all needed."},{id:"growth_japan",label:"Restart Growth",description:"Achieve positive GDP growth for 3 consecutive years",metric:"gdpGrowth",operator:"gt",threshold:.01,sustainTicks:52*3,weight:.35,icon:"ðŸŒ±",tip:"Japan's half-measures dragged the slump out for 20 years. Bold action earlier helps."},{id:"low_unemployment_jp",label:"Maintain Employment",description:"Keep unemployment below 6%",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:0,weight:.25,icon:"ðŸ’¼",tip:"Japan kept employment through corporate welfare (zombie firms). Productive or not?"}],nordicMiracle:[{id:"equality_nordic",label:"Achieve Equality",description:"Bring Gini below 0.30",metric:"gini",operator:"lt",threshold:.3,sustainTicks:52*3,weight:.35,icon:"âš–ï¸",tip:"Universal services + progressive taxation + strong unions. All three matter."},{id:"prosperity_nordic",label:"Maintain Prosperity",description:"Keep unemployment below 6% AND GDP growing",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:52*2,weight:.35,icon:"ðŸŒŸ",tip:"High taxes don't kill growth if trust, education, and institutions are strong."},{id:"poverty_nordic",label:"Eliminate Poverty",description:"Bring poverty rate below 10%",metric:"povertyRate",operator:"lt",threshold:.1,sustainTicks:52,weight:.3,icon:"ðŸ ",tip:"Universal basic services (healthcare, education, housing support) matter more than cash transfers alone."}]};function Ve(s,e,t){const o=e[s.metric];if(o==null)return!1;switch(s.operator){case"lt":return o<s.threshold;case"gt":return o>s.threshold;case"gt_initial":return o>((t==null?void 0:t[s.metric])||0)*s.threshold;default:return!1}}function Je(s,e,t){const o=e[s.metric];if(o==null)return 0;switch(s.operator){case"lt":return Math.min(1,Math.max(0,1-o/(s.threshold*1.5)));case"gt":return Math.min(1,Math.max(0,o/(s.threshold*1.2)));case"gt_initial":{const a=((t==null?void 0:t[s.metric])||1)*s.threshold;return Math.min(1,Math.max(0,o/(a*1.2)))}default:return 0}}class $e{constructor(e={}){this.tick=0,this.running=!1,this.speed=1,this.scenario=e,this.policies=Q(e.policies||{}),this.market=Z(),this.metrics=ee(),this.eventsState=te(),this.agents=$(e.agentCount||200,e),this.businesses=X(e.businessCount||j,this.agents,e),this.objectives=se[e.id]||[],this.objectiveProgress=this.objectives.map(t=>({...t,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scheduledEvents=e.scheduledEvents||[],e.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,e.scheduledEvent]),this._pendingMessages=[]}applyMessage(e){switch(e.type){case"SET_POLICY":this.policies[e.policy]=e.value;break;case"SET_SPEED":this.speed=e.speed;break;case"RESET":this._reset(e.scenario);break;case"PAUSE":this.running=!1;break;case"RESUME":this.running=!0;break;case"RESOLVE_CHOICE":je(this.eventsState,e.eventId,e.choiceId,this._buildState());break}}_reset(e){const t=le(e)||{};this.scenario=t,this.tick=0,this.policies=Q(t.policies||{}),this.market=Z(),this.metrics=ee(),this.eventsState=te(),this.agents=$(t.agentCount||200,t),this.businesses=X(t.businessCount||j,this.agents,t),this.objectives=se[t.id]||[],this.objectiveProgress=this.objectives.map(o=>({...o,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scheduledEvents=t.scheduledEvents||[],t.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,t.scheduledEvent]),this._firedInsights=null,this._lastInsightTick=null}step(){this.tick++;const e=this._buildState();for(const r of this.agents)r.alive&&r.tick(e,this.policies);for(const r of this.businesses)r.alive&&r.tick(e,this.policies);this.tick%5===0&&He(e,this.policies),Ae(this.market,e,this.policies),Ge(e,this.policies,this.market),e._jubileeApplied&&(this.policies.debtJubilee=!1,delete e._jubileeApplied);for(const r of this.scheduledEvents)this.tick===r.atTick&&ie(this.eventsState,e,this.policies,this.tick,r.type);const t=ie(this.eventsState,e,this.policies,this.tick);t&&t._spawnAgents&&this._spawnImmigrants(t._spawnAgents,t._spawnSkillBonus),this.tick%52===0&&this._processBirths(),this._cleanup(),this._processNewBusinesses(e),this.tick%V===0&&(Fe(this.metrics,e,this.market,this.policies),this.initialMetrics||(this.initialMetrics={...O(this.metrics)}),this._updateObjectives());const o=this._checkInsights();let a=null;return!this.scenarioComplete&&this.scenario.durationYears&&Math.floor(this.tick/52)>=this.scenario.durationYears&&(this.scenarioComplete=!0,a=this._buildReport()),{shouldUpdate:this.tick%3===0,event:t,insight:o,scenarioComplete:a}}_buildState(){return{agents:this.agents,businesses:this.businesses,policies:this.policies,market:this.market,metrics:this.metrics}}_updateObjectives(){const e=O(this.metrics);for(const t of this.objectiveProgress){const o=Ve(t,e,this.initialMetrics);if(t.met=o,t.progress=Je(t,e,this.initialMetrics),o){t.sustainCount=(t.sustainCount||0)+V;const a=t.sustainTicks||0;t.sustainProgress=a>0?Math.min(1,t.sustainCount/a):1,t.sustainCount>=a&&!t.completed&&(t.completed=!0)}else t.sustainCount=0,t.sustainProgress=0}}_buildObjectivesSnapshot(){return this.objectiveProgress.map(e=>({id:e.id,label:e.label,description:e.description,icon:e.icon,tip:e.tip,met:e.met,completed:e.completed,progress:e.progress,sustainProgress:e.sustainProgress,weight:e.weight}))}_buildReport(){const e=O(this.metrics),t=this._buildObjectivesSnapshot(),o=t.reduce((p,u)=>p+(u.weight||0),0)||1,a=t.reduce((p,u)=>{const y=u.completed?100:u.met?50:Math.round(u.progress*40);return p+y*(u.weight||0)},0)/o,r=Math.round(a),i=r>=90?"A+":r>=80?"A":r>=70?"B":r>=60?"C":r>=45?"D":"F",n=Math.round(Math.max(0,(1-this.metrics.gini/.7)*100)),c=Math.round(Math.min(100,Math.max(0,(e.gdpGrowth+.02)*2e3))),l=Math.round(Math.max(0,100-Math.abs(e.inflation)*5-e.socialUnrest*100));return{scenarioId:this.scenario.id,scenarioName:this.scenario.name,finalScore:r,grade:i,domains:{equality:{score:n,label:"Equality"},growth:{score:c,label:"Growth"},stability:{score:l,label:"Stability"}},objectives:t,playerOutcome:{gdpChangePercent:this.initialMetrics?Math.round((e.gdp-this.initialMetrics.gdp)/(this.initialMetrics.gdp||1)*100):0,peakUnemployment:Math.round(e.unemployment*100),inflationAvg:Math.round(e.inflation*10)/10,gini:Math.round(e.gini*100)/100,povertyRate:Math.round(e.povertyRate*100)},finalPolicies:{...this.policies},year:Math.floor(this.tick/52)}}_processBirths(){const e=this.agents.filter(t=>t.alive&&t.age>1040&&t.age<2340);for(const t of e)if(Math.random()<.02&&this.agents.filter(o=>o.alive).length<500){const o=new F({x:t.x+(Math.random()-.5)*20,y:t.y+(Math.random()-.5)*20,age:0,skill:d(m(t.skill,.15),.1,1),education:0,wealth:10,parentWealth:t.wealth,bornInYear:Math.floor(this.tick/52)});this.agents.push(o)}}_spawnImmigrants(e,t){for(let o=0;o<e;o++){const a=new F({skill:d(m(.6+t,.15),.3,1),education:d(m(.6,.2),.2,1),wealth:d(m(300,100),50,800),bornInYear:Math.floor(this.tick/52)});this.agents.push(a)}}_processNewBusinesses(e){const t=this.agents.filter(o=>o._wantsToStartBusiness);for(const o of t){if(delete o._wantsToStartBusiness,this.businesses.filter(n=>n.alive).length>=80||o.wealth<300)continue;const{SECTORS:a}={SECTORS:["food","housing","tech","luxury"]},r=a[Math.floor(Math.random()*a.length)],i=new de({sector:r,capital:o.wealth*.5,ownerId:o.id,productivity:d(m(o.skill,.2),.3,2)});o.wealth*=.5,o.isOwner=!0,o.businessId=i.id,o.employed=!0,o.employerId=i.id,o.wage=20,o.jobSector=r,i.employees.push(o.id),this.businesses.push(i),o.events.push(`Started ${i.name} at age ${Math.floor(o.age/52)}`)}}_cleanup(){this.agents=this.agents.filter(e=>e.alive),this.businesses=this.businesses.filter(e=>e.alive)}_checkInsights(){var o;const e=this.metrics;if(this._lastInsightTick&&this.tick-this._lastInsightTick<100)return null;const t=[{id:"monopoly_forming",condition:()=>this.businesses.some(a=>a.dominance>.6),title:"Monopoly Forming",body:"One business controls over 60% of a market. Competition disappears, prices rise, and innovation stalls.",realWorld:"This mirrors Standard Oil in 1911 or modern big tech. Anti-monopoly policy can break this up â€” but at what cost to efficiency?"},{id:"high_inequality",condition:()=>e.gini>.55,title:"Extreme Inequality",body:`Gini coefficient hit ${(e.gini*100).toFixed(0)}. The top 10% own most of the wealth. Social unrest is rising.`,realWorld:"Research shows high inequality reduces social mobility, increases crime, and can destabilize democracies. Nordic countries maintain ~0.28 Gini through redistribution."},{id:"high_unemployment",condition:()=>e.unemployment>.2,title:"Mass Unemployment",body:`${(e.unemployment*100).toFixed(0)}% unemployment. Businesses can't afford wages; workers can't find jobs.`,realWorld:"The Great Depression peaked at 25% US unemployment. Keynes argued government spending could break the cycle."},{id:"inflation_spiral",condition:()=>e.inflation>8,title:"Inflation Spiral",body:"Prices are rising fast. Your money buys less each tick. Real wages are falling.",realWorld:"Zimbabwe (2008) and Venezuela (2018) experienced hyperinflation from excessive money printing. Central banks fight this with higher interest rates."},{id:"min_wage_tradeoff",condition:()=>this.policies.minWage>15&&e.unemployment>.15,title:"Minimum Wage Tradeoff",body:"Minimum wage is high AND unemployment is rising. Small businesses can't afford to hire.",realWorld:"The minimum wage debate: living wages vs. employment effects. Studies show it depends heavily on local cost of living and business type."},{id:"budget_surplus",condition:()=>e.govBudget>500&&e.govDebt<0,title:"Fiscal Surplus",body:"The government is running a surplus! Tax revenue exceeds spending. Debt is falling.",realWorld:"Budget surpluses allow debt reduction and investment in public goods â€” but may slow demand if taxes are too high."},{id:"stagnation",condition:()=>e.gdpGrowth<0&&e.unemployment>.12,title:"Stagflation Risk",body:"GDP is shrinking and unemployment is rising simultaneously. The classic policy dilemma.",realWorld:"The 1970s oil crisis created stagflation. Cutting interest rates helps unemployment but worsens inflation. Raising them helps inflation but worsens unemployment."}];for(const a of t)if(a.condition()&&((o=this._firedInsights)==null?void 0:o.has(a.id))!==!0)return this._firedInsights||(this._firedInsights=new Set),this._firedInsights.add(a.id),this._lastInsightTick=this.tick,{id:a.id,title:a.title,body:a.body,realWorld:a.realWorld,tick:this.tick,year:Math.floor(this.tick/52)};return null}getSnapshot(){return{tick:this.tick,year:Math.floor(this.tick/52),agents:this.agents.map(e=>e.toSnapshot()),businesses:this.businesses.map(e=>e.toSnapshot()),metrics:O(this.metrics),market:{prices:{...this.market.prices},supply:{...this.market.supply},demand:{...this.market.demand},cpi:this.market.cpi,inflation:this.market.inflation},policies:{...this.policies},activeEvents:this.eventsState.activeEvents.map(e=>({id:e.id,name:e.name,icon:e.icon,description:e.description,startTick:e.startTick})),pendingChoice:this.eventsState.pendingChoiceEvent?{id:this.eventsState.pendingChoiceEvent.id,type:this.eventsState.pendingChoiceEvent.type,name:this.eventsState.pendingChoiceEvent.name,description:this.eventsState.pendingChoiceEvent.description,icon:this.eventsState.pendingChoiceEvent.icon,choices:this.eventsState.pendingChoiceEvent.definition.choices}:null,objectives:this._buildObjectivesSnapshot(),scenarioDurationYears:this.scenario.durationYears||null,isHistorical:this.scenario.isHistorical||!1}}}let k=null,M=!1,ge=1,S=null;function oe(s="freeMarket"){const e=le(s);k=new $e(e),M=!0}function x(s){if(!M||!k)return;const e=ge;let t=null,o=null,a=null;for(let i=0;i<e;i++){const n=k.step();if(n.event&&(t=n.event),n.insight&&(o=n.insight),n.scenarioComplete&&(a=n.scenarioComplete),t!=null&&t.requiresChoice)break}const r=k.getSnapshot();self.postMessage({type:"STATE_UPDATE",state:r}),t&&(self.postMessage({type:"EVENT",event:t}),t.requiresChoice&&(M=!1,self.postMessage({type:"CHOICE_REQUIRED",event:r.pendingChoice}))),o&&self.postMessage({type:"INSIGHT",insight:o}),a&&(M=!1,self.postMessage({type:"SCENARIO_COMPLETE",report:a})),S=setTimeout(x,1e3/60)}self.addEventListener("message",s=>{const e=s.data;switch(e.type){case"INIT":oe(e.scenarioId||"freeMarket"),x();break;case"SET_POLICY":k&&k.applyMessage(e);break;case"SET_SPEED":ge=e.speed;break;case"PAUSE":M=!1,S&&(clearTimeout(S),S=null);break;case"RESUME":M||(M=!0,x());break;case"RESET":M=!1,S&&(clearTimeout(S),S=null),oe(e.scenarioId||"freeMarket"),x();break;case"RESOLVE_CHOICE":k&&(k.applyMessage(e),M=!0,x());break;case"GET_SNAPSHOT":k&&self.postMessage({type:"STATE_UPDATE",state:k.getSnapshot()});break}});

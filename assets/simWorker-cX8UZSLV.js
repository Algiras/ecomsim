const B=["food","housing","tech","luxury"],Y={food:10,housing:50,tech:30,luxury:80},Ue={food:.15,housing:.2,tech:.8,luxury:1.5},je={food:2,housing:10,tech:5,luxury:10},qe={food:200,housing:500,tech:300,luxury:800},ae={food:15,housing:5,tech:10,luxury:8},re=20,Ye=1,ze=15,Se=350,le=-100,Ve=.7,Ke=.3,$e=.12,ce=.3,te=250,xe=200,Je={food:.15,housing:.3,tech:.1,luxury:.05},ee=100,J=5e3,V=800,K=600,Xe=.35,he=.06,Ze={incomeTax:.25,corporateTax:.21,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.3,unemploymentBenefit:50,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1,fourDayWeek:!1,robotTax:0,breadAndCircuses:!1,mandatoryProfitShare:0,landValueTax:0,banAdvertising:!1,reserveRequirement:.1,depositInsurance:!0,maxLoanToValue:.8,debtJubilee:!1,lotteryRedistribution:!1,sumptuary:!1,degrowth:!1,algoCentralPlanning:!1,universalBankAccount:!1,policeFunding:.3,financialOversight:.3,prisonReform:!1,helicopterMoney:0,maximumWage:0,wealthConfiscation:0,nationalizeIndustries:!1,punitiveTargiffs:0,guaranteedJobs:!1,capitalGainsTax:.15,exportSubsidies:0,foreignReserveIntervention:!1},Qe=.002,et=1.05,tt=.95,it=1e-4,st=500,ot=5e-4,nt=3e-4,de=.3,ue=3,at=4e-4,rt=200,j=10,lt={interestRate:150,printMoney:30,helicopterMoney:20,incomeTax:80,corporateTax:100,minWage:60,ubi:50,educationFunding:200,wealthTax:80,reserveRequirement:100,maxLoanToValue:80,policeFunding:40,financialOversight:60,robotTax:80,mandatoryProfitShare:60,landValueTax:80,wealthConfiscation:40,maximumWage:60,punitiveTargiffs:50,unemploymentBenefit:40,capitalGainsTax:80,exportSubsidies:60};function g(i,e,t){return Math.max(e,Math.min(t,i))}function _(i=0,e=1){let t=0,s=0;for(;t===0;)t=Math.random();for(;s===0;)s=Math.random();return i+e*Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*s)}function R(i,e){return Math.random()*(e-i)+i}function ct(i){if(!i||i.length===0)return 0;const e=[...i].sort((r,l)=>r-l),t=e.length,s=e.reduce((r,l)=>r+l,0);if(s===0)return 0;let a=0;for(let r=0;r<t;r++)a+=(2*(r+1)-t-1)*e[r];return g(a/(t*s),0,1)}function pe(i){return!i||i.length===0?0:i.reduce((e,t)=>e+t,0)/i.length}function ht(i,e){if(!i||i.length===0)return 0;const t=[...i].sort((a,r)=>a-r),s=Math.floor(e/100*(t.length-1));return t[s]}let Pe=1;const I={CHILD:"child",WORKING:"working",UNEMPLOYED:"unemployed",RETIRED:"retired",BUSINESS_OWNER:"owner",DEAD:"dead"};class ie{constructor(e={}){this.id=e.id??Pe++,this.alive=!0,this.x=e.x??R(20,V-20),this.y=e.y??R(20,K-20),this.vx=0,this.vy=0,this.targetX=this.x,this.targetY=this.y,this.age=e.age??Math.floor(R(936,3380*.6)),this.gender=Math.random()>.5?"M":"F",this.skill=e.skill??g(_(.5,.2),.1,1),this.health=e.health??g(_(.8,.15),.1,1),this.education=e.education??g(_(.5,.25),0,1),this.wealth=e.wealth??g(_(te,xe),10,1/0),this.income=0,this.expenses=0,this.debt=0,this.creditScore=e.creditScore??500,this.deposits=0,this.loans=[],this.monthlyLoanPayment=0,this.hasMortgage=!1,this._bankId=null,this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this.unemployedTicks=0,this.workHistory=[],this.businessId=null,this.isOwner=!1,this.happiness=.5,this.unrest=0,this.socialClass="middle",this.consecutiveMissedPayments=0,this.inDebtSpiral=!1,this.wageGarnishmentRate=0,this.inflationExpectation=.02,this.portfolio=[],this.investmentIncome=0,this.criminalRecord=[],this.incarcerated=!1,this.prisonTicks=0,this.reoffendRisk=0,this.victimTick=0,this.events=[],this.bornInYear=e.bornInYear??0,this.parentWealth=e.parentWealth??te,this.homeX=this.x,this.homeY=this.y,this.routinePhase="home",this.routineTimer=Math.floor(Math.random()*80),this.highlight=!1,this.selected=!1,this.deathFade=1,this._updateState()}_updateState(){this.age<936?this.state=I.CHILD:this.age>=3380?this.state=I.RETIRED:this.isOwner?this.state=I.BUSINESS_OWNER:this.employed?this.state=I.WORKING:this.state=I.UNEMPLOYED,this.wealth<ee?this.socialClass="poor":this.wealth>=J?this.socialClass="rich":this.socialClass="middle"}tick(e,t){if(this.alive){if(this.age++,this._shouldDie(t)){this._die(e,"natural causes");return}if(this._updateState(),this._move(e),this.incarcerated){this._serveSentence(e,t);return}if(this.state!==I.CHILD&&(this._updateInflationExpectation(e),this._consumeGoods(e,t),this._earnIncome(t),this._updateHappiness(e,t),this._considerCrime(e,t),this._considerStartingBusiness(e,t),this._considerInvesting(e,t)),this.wealth<-500&&this.state!==I.CHILD){this._die(e,"poverty");return}}}_shouldDie(e){if(this.age>=4420)return!0;const t=e.publicHealthcare?.5:1,a=5e-5*(this.age>3380?3:1)*(1-this.health*.5)*t;return Math.random()<a}_die(e,t){if(this.alive=!1,this.state=I.DEAD,this.employed=!1,this.employerId=null,this.deathFade=1,this.events.push(`Died from ${t} at age ${Math.floor(this.age/52)}`),this.isOwner&&this.businessId&&e.businesses){const s=e.businesses.find(a=>a.id===this.businessId);s&&s.alive&&s._close(e,"owner died")}if(this.isOwner=!1,this.businessId=null,e.businesses)for(const s of e.businesses)s.employees=s.employees.filter(a=>a!==this.id);if(this.deposits=0,this._bankId=null,this.hasMortgage=!1,this.monthlyLoanPayment=0,this.wealth>0&&e.agents){const s=e.agents.filter(a=>a.alive&&a.id!==this.id);if(s.length>0){const a=s[Math.floor(Math.random()*s.length)];if(a.wealth+=this.wealth*.8,this.portfolio.length>0){for(const r of this.portfolio){const l=a.portfolio.find(o=>o.businessId===r.businessId);l?l.shares+=r.shares:a.portfolio.push({...r})}this.portfolio=[]}a.events.push(`Inherited ${Math.round(this.wealth*.8)} from agent #${this.id}`)}}}_move(e){this.routineTimer--;const t=this.targetX-this.x,s=this.targetY-this.y,a=Math.sqrt(t*t+s*s),r=a<=8;if(this.routineTimer<=0&&(r||this.routineTimer<-120)&&this._advanceRoutine(e),a>2){const l=Math.max(this.routineTimer,1),o=Math.max(Xe,a/(l*.6)),n=t/a*o,c=s/a*o;this.vx+=(n-this.vx)*.3,this.vy+=(c-this.vy)*.3}else this.vx*=.85,this.vy*=.85,this.vx+=(Math.random()-.5)*he,this.vy+=(Math.random()-.5)*he,this.routineTimer>16&&(this.routineTimer=16);this.x=g(this.x+this.vx,5,V-5),this.y=g(this.y+this.vy,5,K-5)}_advanceRoutine(e){var s;const t=((s=e.businesses)==null?void 0:s.filter(a=>a.alive))||[];if(this.state===I.CHILD){this.targetX=g(this.homeX+_(0,25),10,V-10),this.targetY=g(this.homeY+_(0,25),10,K-10),this.routineTimer=R(40,100),this.routinePhase="leisure";return}switch(this.routinePhase){case"home":{if(this.employed&&this.employerId){const a=t.find(r=>r.id===this.employerId);a?(this.targetX=a.x+_(0,18),this.targetY=a.y+_(0,18),this.routinePhase="working",this.routineTimer=R(50,110)):(this._setLeisureTarget(),this.routinePhase="leisure",this.routineTimer=R(30,60))}else Math.random()<.45?this._setShoppingTarget(t):(this._setLeisureTarget(),this.routinePhase="leisure"),this.routineTimer=R(40,90);break}case"working":{Math.random()<.55?(this._setShoppingTarget(t),this.routineTimer=R(24,56)):(this._goHome(),this.routineTimer=R(40,80));break}case"shopping":{Math.random()<.35?(this._setLeisureTarget(),this.routinePhase="leisure",this.routineTimer=R(20,50)):(this._goHome(),this.routineTimer=R(40,90));break}case"leisure":{this._goHome(),this.routineTimer=R(40,100);break}default:this._goHome(),this.routineTimer=R(40,80)}}_goHome(){this.targetX=this.homeX+_(0,18),this.targetY=this.homeY+_(0,18),this.routinePhase="home"}_setLeisureTarget(){this.targetX=g(this.x+_(0,30),10,V-10),this.targetY=g(this.y+_(0,30),10,K-10),this.routinePhase="leisure"}_setShoppingTarget(e){const t=e.filter(r=>r.sector==="food"||r.sector==="housing");if(t.length===0){this._setLeisureTarget();return}const s=t.map(r=>({b:r,d:(r.x-this.x)**2+(r.y-this.y)**2})).sort((r,l)=>r.d-l.d),a=s[Math.floor(Math.random()*Math.min(4,s.length))].b;this.targetX=a.x+_(0,18),this.targetY=a.y+_(0,18),this.routinePhase="shopping"}_consumeGoods(e,t){const s=e.prices||e;if(!s)return;let a=0;const r=this.wage||0;for(const n of["food","housing","tech","luxury"]){let c=Je[n];if(n==="housing"&&this.hasMortgage)continue;t[`priceControl${n.charAt(0).toUpperCase()+n.slice(1)}`]&&(c*=.8),n==="luxury"&&this.wealth<ee*2&&(c=0);const h=r*c/(s[n]||1)*s[n];a+=h}if(this.inflationExpectation>.03){const n=1+Math.min(1,(this.inflationExpectation-.03)*5);a*=n}if(this.wealth>1e3){const n=(this.wealth-1e3)*.002;a+=n}if(Math.random()<.001){const n=this.wealth*(.05+Math.random()*.1);a+=Math.max(0,n)}this.expenses=a,this.wealth-=a*.65,!this.hasMortgage&&this.creditScore>=500&&this.wealth>100&&e.banks&&this._tryGetMortgage(e,t);const l=e.businesses,o=s.food||10;l&&(l.filter(c=>c.alive&&c.sector==="food").length===0?this.health=Math.max(0,this.health-.01):o>50?this.health=Math.max(0,this.health-.002):o>30&&this.wealth<ee&&(this.health=Math.max(0,this.health-.005)))}_tryGetMortgage(e,t){var n;if(Math.random()>.001)return;const s=(e.banks||[]).filter(c=>c.alive);if(s.length===0)return;const a=(((n=e.prices)==null?void 0:n.housing)||50)*100,r=t.maxLoanToValue??.8,l=a*r,o=a-l;if(!(this.wealth<o)){for(const c of s)if(c.canIssueLoan(this,"mortgage",l,t).approved){this.wealth-=o,c.issueLoan(this,"mortgage",l,t),this.hasMortgage=!0,this.events.push(`Took mortgage ($${Math.round(l)}) at age ${Math.floor(this.age/52)}`);break}}}_earnIncome(e){let t=0;if(this.employed&&this.wage>0){const s=e.incomeTax||0;t=this.wage*(1-s),this.wageGarnishmentRate>0&&(t-=t*this.wageGarnishmentRate)}else this.state===I.UNEMPLOYED&&(e.unemploymentBenefit>0&&(t=e.unemploymentBenefit*.1),this.unemployedTicks++);e.ubi>0&&this.state!==I.CHILD&&(t+=e.ubi*.01),this.income=t,this.wealth+=t,this.employed&&(this.creditScore=g(this.creditScore+.5,300,850))}_updateHappiness(e,t){var r,l;let s=.5;const a=this.wealth/1e3;s+=g(a*.2,-.3,.3),this.employed?s+=.1:s-=.15,s-=(1-this.health)*.15,e.businesses&&e.businesses.filter(n=>n.alive&&n.sector==="housing").length===0&&(s-=.1),((r=e.metrics)==null?void 0:r.gini)>.6&&(s-=.1),t.publicHealthcare&&(s+=.05),this.victimTick>0&&(((l=e.metrics)==null?void 0:l.tick)||0)-this.victimTick<200&&(s-=.15),this.inDebtSpiral&&(s-=.25),this.happiness=g(s,0,1),this.unrest=g(1-this.happiness-.3,0,1)}_considerStartingBusiness(e,t){if(this.state===I.UNEMPLOYED&&this.skill>.4&&!this.businessId&&Math.random()<3e-5){const s=this.wealth>300,a=this.creditScore>=600&&(e.banks||[]).some(r=>r.alive);(s||a)&&(this._wantsToStartBusiness=!0,this._needsBusinessLoan=!s&&a)}}_considerCrime(e,t){var s;if(!(this.state===I.CHILD||this.state===I.RETIRED)){if(!this.isOwner){const r=this.wealth<100?.5:0,l=this.employed?0:.3,o=this.unrest*.3,n=this.age>18*52&&this.age<35*52?.2:0,c=this.reoffendRisk*.3,h=-(t.policeFunding||0)*.5,d=2e-5*(1+r+l+o+n+c+h);if(Math.random()<d){this._commitStreetCrime(e,t);return}}if(this.isOwner&&this.businessId){const r=t.antiMonopoly?0:.3,l=(((s=e.metrics)==null?void 0:s.gini)||0)>.5?.3:0,o=this.wealth>2e3?.2:0,n=(t.reserveRequirement||.1)<.1?.2:0,c=-(t.financialOversight||0)*.5,h=1e-5*(1+r+l+o+n+c);Math.random()<h&&this._commitCorporateCrime(e,t)}}}_commitStreetCrime(e,t){var c,h;const s=((c=e.agents)==null?void 0:c.filter(d=>d.alive&&d.id!==this.id&&!d.incarcerated))||[];if(s.length===0)return;const a=s[Math.floor(Math.random()*s.length)],r=((h=e.metrics)==null?void 0:h.tick)||0,l=Math.random();let o;if(l<.5){o="theft";const d=Math.min(a.wealth*.1,50);d>0&&(a.wealth-=d,this.wealth+=d,a.victimTick=r)}else if(l<.8){o="robbery";const d=Math.min(a.wealth*.15,80);d>0&&(a.wealth-=d,this.wealth+=d),a.health=g(a.health-.05,.1,1),a.victimTick=r}else o="assault",a.health=g(a.health-.1,.1,1),a.victimTick=r;e._crimeLog||(e._crimeLog=[]),e._crimeLog.push({type:o,category:"street",tick:r});const n=.1+(t.policeFunding||0)*.4;Math.random()<n&&this._getArrested(e,t,o)}_commitCorporateCrime(e,t){var n,c,h;const s=((n=e.metrics)==null?void 0:n.tick)||0,a=(c=e.businesses)==null?void 0:c.find(d=>d.id===this.businessId);if(!a||!a.alive)return;const r=Math.random();let l;if(r<.5){l="embezzlement";const d=a.capital*.1;a.capital-=d,this.wealth+=d}else{l="fraud";const d=((h=e.agents)==null?void 0:h.filter(v=>v.alive&&v.id!==this.id))||[],p=Math.min(this.wealth*.2,200);this.wealth+=p;const m=Math.min(5,d.length);for(let v=0;v<m;v++){const b=d[Math.floor(Math.random()*d.length)];b.wealth-=p/m,b.victimTick=s}}e._crimeLog||(e._crimeLog=[]),e._crimeLog.push({type:l,category:"corporate",tick:s});const o=.05+(t.financialOversight||0)*.35;Math.random()<o&&this._getArrested(e,t,l)}_getArrested(e,t,s){var r;this.incarcerated=!0;const a=s==="fraud"||s==="embezzlement"?200:100;if(this.prisonTicks=a+Math.floor(Math.random()*100),this.criminalRecord.push({type:s,tick:((r=e.metrics)==null?void 0:r.tick)||0}),this.reoffendRisk=g(this.reoffendRisk+.15,0,1),this.creditScore=g(this.creditScore-100,300,850),this.employed&&!this.isOwner&&this.fire("arrested"),this.isOwner&&this.businessId&&e.businesses){const l=e.businesses.find(o=>o.id===this.businessId);l&&l.alive&&l._close(e,"owner arrested"),this.isOwner=!1,this.businessId=null}this.events.push(`Arrested for ${s} at age ${Math.floor(this.age/52)}`),this._updateState()}_serveSentence(e,t){this.prisonTicks--,t.prisonReform&&Math.random()<.001&&(this.reoffendRisk=g(this.reoffendRisk-.01,0,1)),this.prisonTicks<=0&&(this.incarcerated=!1,this.prisonTicks=0,this.events.push(`Released from prison at age ${Math.floor(this.age/52)}`),this._updateState())}_updateInflationExpectation(e){var r,l,o;const t=((r=e.market)==null?void 0:r.inflation)||0;this.inflationExpectation=this.inflationExpectation*.9+t*.1;const s=((l=e.policies)==null?void 0:l.interestRate)||.05;if(s>.05){const n=(s-.05)*.3;this.inflationExpectation-=n*.1}const a=((o=e.market)==null?void 0:o.centralBankCredibility)??1;if(a<.5){const n=1+(.5-a)*.5;this.inflationExpectation*=n}this.inflationExpectation=g(this.inflationExpectation,-.1,2)}_considerInvesting(e,t){var c;if(this.state===I.CHILD)return;if(this.portfolio.length>0)for(const h of[...this.portfolio]){const d=(e.businesses||[]).find(v=>v.id===h.businessId);if(!d||!d.alive){this.portfolio=this.portfolio.filter(v=>v.businessId!==h.businessId);continue}const p=(h.avgCostBasis-d.sharePrice)/Math.max(h.avgCostBasis,.01),m=this.inDebtSpiral||this.wealth<100;(p>.2&&Math.random()<.1||m&&Math.random()<.05)&&(this.wealth+=h.shares*d.sharePrice,d.sharesAvailable+=h.shares,this.portfolio=this.portfolio.filter(v=>v.businessId!==h.businessId))}if(this.wealth<200||Math.random()>.005)return;const s=(e.businesses||[]).filter(h=>h.alive&&h.isPublic&&h.sharesAvailable>0);if(s.length===0)return;s.sort((h,d)=>{var v,b;const p=((v=h.profitHistory)==null?void 0:v.length)>0?h.profitHistory.reduce((C,u)=>C+u,0)/h.profitHistory.length:0;return(((b=d.profitHistory)==null?void 0:b.length)>0?d.profitHistory.reduce((C,u)=>C+u,0)/d.profitHistory.length:0)-p});const a=s[0],r=Math.min(this.wealth*.1,a.sharesAvailable*a.sharePrice);if(r<=0||a.sharePrice<=0)return;const l=Math.min(Math.floor(r/a.sharePrice),a.sharesAvailable);if(l<=0)return;const o=l*a.sharePrice;this.wealth-=o,a.sharesAvailable-=l;const n=this.portfolio.find(h=>h.businessId===a.id);if(n){const h=n.shares+l;n.avgCostBasis=(n.avgCostBasis*n.shares+o)/h,n.shares=h}else this.portfolio.push({businessId:a.id,shares:l,avgCostBasis:a.sharePrice});this.wealth>5e3&&a.sharePrice<1&&a.capital<100&&!this.isOwner&&(((c=this.portfolio.find(d=>d.businessId===a.id))==null?void 0:c.shares)||0)>a.sharesOutstanding*.5&&(a.ownerId=this.id,this.isOwner=!0,this.businessId=a.id,this.events.push(`Acquired ${a.name} via M&A`))}hire(e,t){this.employed=!0,this.employerId=e.id,this.wage=t,this.jobSector=e.sector,this.unemployedTicks=0,this.workHistory.push({businessId:e.id,sector:e.sector,wage:t,startAge:this.age}),this.events.push(`Hired at ${e.name} (age ${Math.floor(this.age/52)})`),this._updateState()}fire(e="layoff"){if(this.workHistory.length>0){const t=this.workHistory[this.workHistory.length-1];t.endAge=this.age,t.reason=e}this.events.push(`Lost job (${e}) at age ${Math.floor(this.age/52)}`),this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this._updateState()}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,state:this.state,wealth:this.wealth,age:this.age,skill:this.skill,health:this.health,education:this.education,happiness:this.happiness,unrest:this.unrest,employed:this.employed,employerId:this.employerId,socialClass:this.socialClass,wage:this.wage,jobSector:this.jobSector,isOwner:this.isOwner,businessId:this.businessId,creditScore:this.creditScore,deposits:this.deposits,hasMortgage:this.hasMortgage,loanCount:this.loans.length,monthlyLoanPayment:this.monthlyLoanPayment,incarcerated:this.incarcerated,criminalRecordCount:this.criminalRecord.length,inDebtSpiral:this.inDebtSpiral,inflationExpectation:this.inflationExpectation,portfolioValue:this.portfolio.reduce((e,t)=>e+t.shares*(t.avgCostBasis||0),0),investmentIncome:this.investmentIncome,deathFade:this.deathFade,events:this.events.slice(-10)}}}function fe(i,e={}){Pe=1;const t=[];for(let s=0;s<i;s++){const a=e.wealthInequality||1,r=Math.max(10,_(te*(e.wealthMultiplier||1),xe*a));t.push(new ie({wealth:r,skill:g(_(e.avgSkill||.5,.2),.05,1),education:g(_(e.avgEducation||.5,.25),0,1),bornInYear:0}))}return t}const Be=[{id:"story_ch1",number:1,title:"The Industrial Revolution",era:"1850 â€“ 1880",tagline:"Harness the power of industry â€” without breaking the people who build it.",icon:"ðŸ­",color:"#f59e0b",durationYears:30,openingNarrative:`The year is 1850. Steam engines thunder. Factories rise where fields once stretched.

Your small nation stands at the threshold of the industrial age. Entrepreneurs are building mills and mines. Workers are flooding in from the countryside â€” hungry, desperate, and ready to work for almost nothing.

You control the levers of power. How you shape this transformation will echo for generations.

Industrialise too fast and brutal inequality will tear your society apart. Go too slow and you'll fall behind competing nations. History rarely rewards caution â€” but it punishes cruelty.

What kind of industrial nation will you build?`,kokoroNarration:"The year is 1850. Steam engines thunder. Factories rise where fields once stretched. Your nation stands at the threshold of the industrial age. Workers are flooding in from the countryside â€” hungry, desperate, and ready to work for almost nothing. How you shape this transformation will echo for generations.",closingNarrative:{excellent:"Your industrial revolution was a model of managed progress. Workers were protected. Productivity soared. You proved that growth and dignity are not opposites. History will remember this era as a turning point for human welfare.",good:"Your industrial revolution delivered real growth â€” but left scars. Inequality rose faster than wages. Some workers lived better; many did not. The foundations you built are strong, but the cracks will show in time.",poor:"The factories ran. The profits flowed â€” to the few. Workers labored in brutal conditions, children among them. You fed the machine of progress with human suffering. The resentment has only begun to fester."},scenarioConfig:{agentCount:150,businessCount:12,wealthMultiplier:.8,wealthInequality:1.2,avgSkill:.35,policies:{incomeTax:.05,corporateTax:.05,minWage:0,ubi:0,interestRate:.08,antiMonopoly:!1,educationFunding:.1,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!0}},scheduledEvents:[{atTick:100,type:"techBreakthrough"},{atTick:350,type:"generalStrike"},{atTick:600,type:"immigrationWave"}],objectives:[{id:"industrialize",label:"Industrialise",icon:"âš™ï¸",description:"Grow GDP to 3Ã— starting value",metric:"gdp",operator:"gt_initial",threshold:3,sustainTicks:0,weight:.3,tip:"Reduce interest rates to encourage business investment"},{id:"contain_inequality",label:"Contain Inequality",icon:"âš–ï¸",description:"Keep Gini coefficient below 0.65",metric:"gini",operator:"lt",threshold:.65,sustainTicks:52,weight:.35,tip:"Education funding and minimum wage slow inequality accumulation"},{id:"prevent_unrest",label:"Prevent Revolution",icon:"ðŸ”¥",description:"Keep social unrest below 60%",metric:"socialUnrest",operator:"lt",threshold:.6,sustainTicks:52,weight:.35,tip:"Workers strike when inequality is extreme. Early labour protections help."}]},{id:"story_ch2",number:2,title:"The Great Depression",era:"1929 â€“ 1939",tagline:"The bubble has burst. The banks are failing. Can you stop the collapse?",icon:"ðŸ“‰",color:"#ef4444",durationYears:10,openingNarrative:`October 1929. The stock market has just crashed. Overnight, millions lost their savings.

Banks are failing. Factories are shutting. Unemployment lines stretch around the block. The industrial prosperity you inherited now threatens to become the greatest catastrophe in economic history.

Herbert Hoover is doing nothing. The markets will correct themselves, they say. They have not corrected. They are freefall.

You have a decade to stop the collapse, prevent total social breakdown, and set the stage for recovery. Every decision will be second-guessed by historians for the next hundred years.

What do you do?`,kokoroNarration:"October 1929. The stock market has just crashed. Banks are failing. Factories are shutting. Unemployment lines stretch around the block. You have one decade to stop the collapse. Every decision you make will be second-guessed by historians for the next hundred years.",closingNarrative:{excellent:"You navigated the Depression better than history did. The New Deal worked â€” or something like it. Workers were put back to work, banks were stabilised, and the social contract held. Future generations will look back at this as the moment government proved its worth.",good:"Recovery came, but slowly and unevenly. Unemployment fell but never fully resolved. You avoided total collapse â€” which is more than Hoover managed. The scars remain, but the patient survived.",poor:"The Depression deepened on your watch. Unemployment exceeded 30%. Hunger marches turned violent. The social fabric frayed. You've created the conditions for something dangerous to fill the vacuum."},scenarioConfig:{agentCount:200,businessCount:25,wealthMultiplier:1.5,wealthInequality:2.5,avgSkill:.45,startingGovDebt:2e3,policies:{incomeTax:.25,corporateTax:.15,minWage:0,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.2,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1}},scheduledEvents:[{atTick:10,type:"financialBubble"},{atTick:80,type:"bankRun"},{atTick:200,type:"recession"},{atTick:350,type:"cropFailure"}],objectives:[{id:"employment",label:"Reduce Unemployment",icon:"ðŸ‘·",description:"Get unemployment below 15%",metric:"unemployment",operator:"lt",threshold:.15,sustainTicks:104,weight:.4,tip:"Stimulus spending, guaranteed jobs, or UBI can absorb the unemployed"},{id:"no_collapse",label:"Prevent Social Collapse",icon:"ðŸ›ï¸",description:"Keep social unrest below 70%",metric:"socialUnrest",operator:"lt",threshold:.7,sustainTicks:0,weight:.35,tip:"Hungry, unemployed people revolt. Food aid and benefits are not luxuries here."},{id:"gdp_recovery",label:"Stabilise GDP",icon:"ðŸ“ˆ",description:"Stop GDP from falling below 50% of starting value",metric:"gdp",operator:"gt_initial",threshold:.5,sustainTicks:52,weight:.25,tip:"Austerity deepens depressions. Keynes said so. Try stimulus."}]},{id:"story_ch3",number:3,title:"The Golden Age",era:"1950 â€“ 1975",tagline:"Postwar prosperity. Build the welfare state â€” before stagflation ends it.",icon:"âœ¨",color:"#22c55e",durationYears:25,openingNarrative:`The war is over. Soldiers have come home. Baby carriages fill the streets.

The economy is booming. Factories, infrastructure, education â€” everything needs to be built. There is broad political consensus that government should provide education, healthcare, and a safety net. This is your window.

But the prosperity won't last forever. By the mid-1970s, oil shocks will trigger stagflation â€” high inflation and high unemployment at the same time, the nightmare scenario that breaks every economic model.

Your task: build a welfare state that is both generous and resilient enough to survive when the oil runs out.`,kokoroNarration:"The war is over. Soldiers have come home. The economy is booming. This is your window to build the welfare state. But the prosperity won't last forever. By the mid-seventies, oil shocks will trigger stagflation â€” the nightmare scenario that breaks every economic model. Build something resilient.",closingNarrative:{excellent:"You built the most successful welfare state in history. Education, healthcare, housing â€” all delivered. When stagflation hit, your economy had the resilience to absorb the shock. This will be remembered as the Golden Age it promised to be.",good:"You built a reasonable welfare state and survived stagflation with manageable damage. Not Sweden, but not collapse either. The middle class is large. Inequality is moderate. The foundations are solid.",poor:"The Golden Age became the Age of Stagflation on your watch. Inflation spiralled, unemployment spiked, and the welfare programs you couldn't afford to maintain were cut. The social contract is fraying."},scenarioConfig:{agentCount:220,businessCount:28,wealthMultiplier:1.2,wealthInequality:1.3,avgSkill:.55,policies:{incomeTax:.35,corporateTax:.28,minWage:8,ubi:0,interestRate:.04,antiMonopoly:!0,educationFunding:.5,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!0,wealthTax:0,openBorders:!1,subsidiesFarming:!0}},scheduledEvents:[{atTick:50,type:"boom"},{atTick:200,type:"techBreakthrough"},{atTick:600,type:"recession"},{atTick:750,type:"hyperinflation"}],objectives:[{id:"welfare",label:"Build Welfare State",icon:"ðŸ¥",description:"Keep poverty rate below 15%",metric:"povertyRate",operator:"lt",threshold:.15,sustainTicks:104,weight:.35,tip:"Healthcare, education, unemployment benefits â€” all reduce poverty"},{id:"growth",label:"Sustained Growth",icon:"ðŸ“ˆ",description:"Maintain positive GDP growth for 5 years",metric:"gdpGrowth",operator:"gt",threshold:0,sustainTicks:260,weight:.35,tip:"The postwar boom is yours to manage. Don't break it."},{id:"survive_stagflation",label:"Survive Stagflation",icon:"ðŸ›¡ï¸",description:"Keep inflation below 15% when it hits",metric:"inflation",operator:"lt",threshold:15,sustainTicks:52,weight:.3,tip:"Tight monetary policy can fight inflation â€” but it triggers recession"}]},{id:"story_ch4",number:4,title:"The Neoliberal Turn",era:"1980 â€“ 2000",tagline:"Deregulate everything. But who gets left behind?",icon:"ðŸ¦",color:"#8b5cf6",durationYears:20,openingNarrative:`Reagan is in the White House. Thatcher is at 10 Downing Street. The message is clear: government is the problem. Markets are the solution.

Inflation has been crushed â€” but at the cost of brutal unemployment. The industrial heartland is hollowing out. Financialisation is replacing manufacturing. Inequality is rising faster than at any time since the Gilded Age.

The tech revolution is beginning. This could be a tremendous era of growth â€” or the beginning of a 40-year inequality explosion.

The choice is yours. Deregulate and grow fast, or manage the transition and protect those left behind?`,kokoroNarration:"Reagan is in the White House. Thatcher is at Downing Street. The message is clear â€” government is the problem. Markets are the solution. Inflation has been crushed. The tech revolution is beginning. This could be tremendous growth â€” or the beginning of a 40-year inequality explosion. The choice is yours.",closingNarrative:{excellent:"You managed the neoliberal era with rare wisdom â€” capturing the growth benefits of deregulation while protecting workers from its worst effects. Inequality rose modestly. The middle class survived. The tech revolution was distributed, not just captured by the elite.",good:"Growth was real. So was the inequality. The 1990s produced genuine prosperity for many, but the gap between the top and bottom widened considerably. The seeds of future discontent were planted, but the economy is functional.",poor:"Trickle-down didn't trickle. Deregulation unleashed a financial sector that captured all the gains. Workers who lost manufacturing jobs never found equivalent work. The economy is a casino â€” and the house always wins."},scenarioConfig:{agentCount:240,businessCount:30,wealthMultiplier:1.4,wealthInequality:1.8,avgSkill:.5,policies:{incomeTax:.28,corporateTax:.35,minWage:5,ubi:0,interestRate:.15,antiMonopoly:!1,educationFunding:.3,unemploymentBenefit:60,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!0,subsidiesFarming:!1}},scheduledEvents:[{atTick:80,type:"techBreakthrough"},{atTick:250,type:"financialBubble"},{atTick:400,type:"brainDrain"},{atTick:600,type:"boom"}],objectives:[{id:"growth_neo",label:"Deliver Growth",icon:"ðŸ“ˆ",description:"Grow GDP to 2Ã— starting value",metric:"gdp",operator:"gt_initial",threshold:2,sustainTicks:0,weight:.3,tip:"Low rates and deregulation stimulate growth â€” short-term"},{id:"inequality_neo",label:"Contain Inequality",icon:"âš–ï¸",description:"Keep Gini below 0.55",metric:"gini",operator:"lt",threshold:.55,sustainTicks:104,weight:.4,tip:"The hardest challenge of this era. Redistribution fights against market forces."},{id:"employment_neo",label:"Full Employment",icon:"ðŸ‘·",description:"Keep unemployment below 8%",metric:"unemployment",operator:"lt",threshold:.08,sustainTicks:104,weight:.3,tip:"Technology displaces workers. Education and retraining are your best tools."}]},{id:"story_ch5",number:5,title:"The Age of Crises",era:"2008 â€“ Now",tagline:"Financial crash. Pandemic. Inequality explosion. Can you hold it together?",icon:"ðŸŒ",color:"#6366f1",durationYears:20,openingNarrative:`September 2008. Lehman Brothers has just filed for bankruptcy. The global financial system is in cardiac arrest.

Everything you built over the previous decades is now being tested. The debt is enormous. The inequality is extreme. The financial sector is insolvent. And in a decade, a pandemic will arrive that shuts down the entire world economy.

This is the final chapter. The cumulative weight of every previous decision â€” industrial exploitation, Depression policy, welfare choices, neoliberal inequality â€” comes due now.

Can you hold civilisation together? Or will this be where it finally breaks?`,kokoroNarration:"September 2008. Lehman Brothers has just filed for bankruptcy. The global financial system is in cardiac arrest. Everything you built over decades is being tested. And in a decade, a pandemic will arrive. This is the final chapter. Can you hold it together?",closingNarrative:{excellent:"Against extraordinary odds, you navigated the Age of Crises. The 2008 crash was contained. The pandemic was managed. Inequality, while still high, was brought back to manageable levels. This is what competent governance looks like in the hardest times.",good:"The crises were severe but not fatal. Recovery was slow and uneven. The wealthy recovered faster than the workers â€” as always. But the system held. Democracy survived. This is the realistic best-case outcome.",poor:"The crises broke what the previous decades had strained. Unemployment, inequality, social unrest â€” all reached historic highs. The social contract you inherited lies in ruins. Whatever comes next won't look like what came before."},scenarioConfig:{agentCount:250,businessCount:35,wealthMultiplier:2,wealthInequality:3,avgSkill:.6,startingGovDebt:3500,policies:{incomeTax:.3,corporateTax:.25,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1}},scheduledEvents:[{atTick:10,type:"financialBubble"},{atTick:100,type:"bankRun"},{atTick:250,type:"recession"},{atTick:500,type:"pandemic"},{atTick:650,type:"hyperinflation"}],objectives:[{id:"survive_crash",label:"Survive the Crash",icon:"ðŸ¦",description:"Keep GDP above 60% of starting value",metric:"gdp",operator:"gt_initial",threshold:.6,sustainTicks:52,weight:.3,tip:"Stimulus, QE, and deposit guarantees are your tools for the crash"},{id:"inequality_final",label:"Reduce Inequality",icon:"âš–ï¸",description:"Bring Gini below 0.5",metric:"gini",operator:"lt",threshold:.5,sustainTicks:104,weight:.35,tip:"This is the defining challenge of the 21st century. Wealth taxes, UBI, education."},{id:"stability_final",label:"Social Stability",icon:"ðŸ•Šï¸",description:"Keep social unrest below 50%",metric:"socialUnrest",operator:"lt",threshold:.5,sustainTicks:52,weight:.35,tip:"People who have nothing to lose are dangerous. Safety nets buy stability."}]}],Q={default:{id:"default",name:"Balanced Start",subtitle:"US-inspired defaults. Tweak as you go.",description:"A mixed economy with moderate taxes, basic safety nets, and room to experiment. Good starting point for learning.",icon:"âš–ï¸",difficulty:"Easy",color:"#6366f1",isHistorical:!1,policies:{},agentCount:200,businessCount:20,wealthMultiplier:1,wealthInequality:1,avgSkill:.5,lesson:"Every policy has tradeoffs. Start here and learn what each lever does."},freeMarket:{id:"freeMarket",name:"Free Market Utopia",subtitle:"No rules. Pure capitalism.",description:"Zero regulation. No minimum wage, no taxes, no safety net. Watch monopolies form naturally and see who wins â€” and who gets left behind.",icon:"ðŸ¦…",difficulty:"Observe",color:"#3b82f6",isHistorical:!1,policies:{incomeTax:0,corporateTax:0,minWage:0,ubi:0,interestRate:.02,antiMonopoly:!1,educationFunding:0,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1.2,wealthInequality:1.5,avgSkill:.5,lesson:"Natural monopolies emerge quickly. The rich get richer. But GDP grows fast at first."},debtSpiral:{id:"debtSpiral",name:"The Debt Spiral",subtitle:"Borrowed too much. Now what?",description:"The government spent heavily on social programs. Debt is high, deficit is growing. Austerity or default â€” pick your poison.",icon:"ðŸ’¸",difficulty:"Hard",color:"#ef4444",isHistorical:!1,policies:{incomeTax:.45,corporateTax:.35,minWage:15,ubi:200,interestRate:.12,antiMonopoly:!0,educationFunding:.8,unemploymentBenefit:150,priceControlFood:!1,priceControlHousing:!1,printMoney:5,publicHealthcare:!0,wealthTax:.02,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.8,wealthInequality:.8,avgSkill:.55,startGovDebt:5e3,lesson:"Cutting programs causes pain now. Keeping them causes pain later. The political economy of austerity."},techDisruption:{id:"techDisruption",name:"Tech Disruption",subtitle:"Automation is coming for jobs.",description:"A stable, balanced economy. Then a tech breakthrough hits â€” half the jobs can be automated. Will you adapt or collapse?",icon:"ðŸ¤–",difficulty:"Medium",color:"#8b5cf6",isHistorical:!1,policies:{incomeTax:.28,corporateTax:.21,minWage:12,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.5,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1,wealthInequality:1,avgSkill:.5,scheduledEvents:[{type:"techBreakthrough",atTick:200}],lesson:"Automation creates wealth but destroys jobs. UBI or retraining â€” which policy saves more people?"},weimarHyperinflation:{id:"weimarHyperinflation",name:"Weimar Hyperinflation",subtitle:"A loaf of bread costs a wheelbarrow of cash.",description:"Post-WWI Germany is printing money to pay reparations. Inflation is doubling daily. The middle class is being wiped out. Can you stabilize the currency before society collapses?",icon:"ðŸ’¹",difficulty:"Expert",color:"#dc2626",isHistorical:!0,era:"1921â€“1924 Â· Germany",durationYears:10,policies:{incomeTax:.15,corporateTax:.1,minWage:0,ubi:0,interestRate:.01,antiMonopoly:!1,educationFunding:.2,unemploymentBenefit:0,priceControlFood:!0,priceControlHousing:!1,printMoney:40,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:180,businessCount:15,wealthMultiplier:.5,wealthInequality:1.8,avgSkill:.45,scheduledEvents:[],lesson:"Stopping hyperinflation requires cold turkey: halt money printing, issue new credible currency, accept short-term pain."},greatDepression:{id:"greatDepression",name:"The Great Depression",subtitle:"October 1929. The markets have collapsed.",description:'GDP has fallen 30%. Unemployment is climbing toward 25%. Banks are failing daily. Hoover says "be patient." Do you agree?',icon:"ðŸ“‰",difficulty:"Very Hard",color:"#78716c",isHistorical:!0,era:"1929â€“1939 Â· United States",durationYears:15,policies:{incomeTax:.02,corporateTax:.12,minWage:0,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.1,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:12,wealthMultiplier:.35,wealthInequality:2,avgSkill:.4,scheduledEvents:[{type:"recession",atTick:1},{type:"financialBubble",atTick:80}],lesson:"Austerity deepened the Depression. FDR's New Deal proved government spending could restart demand."},stagflation1970s:{id:"stagflation1970s",name:"1970s Stagflation",subtitle:"Inflation up. Unemployment up. Nothing works.",description:"OPEC's oil embargo just hit. Prices are surging but the economy is stagnating. Your standard policy tools are pointing in opposite directions. What do you do?",icon:"â›½",difficulty:"Hard",color:"#d97706",isHistorical:!0,era:"1973â€“1982 Â· United States",durationYears:12,policies:{incomeTax:.3,corporateTax:.48,minWage:8,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:8,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.85,wealthInequality:1.1,avgSkill:.5,scheduledEvents:[{type:"cropFailure",atTick:20},{type:"recession",atTick:150}],lesson:"Stagflation broke Keynesian consensus. Volcker's painful rate hikes eventually worked â€” but cost millions their jobs."},japanLostDecade:{id:"japanLostDecade",name:"Japan's Lost Decade",subtitle:"Zero rates. Zero growth. Zero inflation.",description:"Japan's asset bubble burst in 1991. Interest rates are near zero. Stimulus packages come and go. Nothing works. Can you escape the deflationary trap that trapped Japan for 20 years?",icon:"ðŸ—¾",difficulty:"Expert",color:"#0891b2",isHistorical:!0,era:"1991â€“2010 Â· Japan",durationYears:15,policies:{incomeTax:.33,corporateTax:.38,minWage:6,ubi:0,interestRate:.005,antiMonopoly:!1,educationFunding:.6,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:2,publicHealthcare:!0,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:.9,wealthInequality:.9,avgSkill:.65,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:10}],lesson:"Half-measures and zombie banks prolonged Japan's stagnation for 20 years. Swift, decisive action matters."},crisisOf2008:{id:"crisisOf2008",name:"2008 Financial Crisis",subtitle:"Lehman just failed. The banks are frozen.",description:"The US housing bubble has burst. Banks are insolvent. Credit is frozen. The global economy is in freefall. Bail out the banks, let them fail, or something else?",icon:"ðŸ¦",difficulty:"Hard",color:"#7c3aed",isHistorical:!0,era:"2008â€“2015 Â· Global",durationYears:10,policies:{incomeTax:.28,corporateTax:.35,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:16,wealthMultiplier:.7,wealthInequality:1.6,avgSkill:.5,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:30}],lesson:"Bailouts prevented a depression but rewarded recklessness. The political consequences lasted a decade."},nordicMiracle:{id:"nordicMiracle",name:"Build the Nordic Model",subtitle:"High taxes. High trust. High happiness.",description:"You're building a new nation. Can you achieve the Nordic balance: low inequality, high productivity, strong safety net, and sustained growth? This is what success looks like.",icon:"ðŸŒ",difficulty:"Blueprint",color:"#059669",isHistorical:!0,era:"Reference Model Â· Scandinavia",durationYears:20,policies:{incomeTax:.45,corporateTax:.25,minWage:18,ubi:0,interestRate:.03,antiMonopoly:!0,educationFunding:.9,unemploymentBenefit:200,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!0,wealthTax:.01,openBorders:!1,subsidiesFarming:!0},agentCount:200,businessCount:22,wealthMultiplier:1,wealthInequality:.7,avgSkill:.6,avgEducation:.65,scheduledEvents:[],lesson:"The Nordic model requires high institutional trust, universal services, AND open competitive markets. All three."}};for(const i of Be)Q[i.id]={id:i.id,name:i.title,subtitle:i.era,description:i.tagline,icon:i.icon,difficulty:`Chapter ${i.number}`,color:i.color,isHistorical:!1,isStory:!0,storyChapterNumber:i.number,durationYears:i.durationYears,era:i.era,lesson:i.tagline,scheduledEvents:i.scheduledEvents||[],...i.scenarioConfig,policies:i.scenarioConfig.policies};function De(i){return Q[i]||Q.freeMarket}const ne=Object.values(Q);ne.filter(i=>!i.isHistorical&&!i.isStory);ne.filter(i=>i.isHistorical);ne.filter(i=>i.isStory);let Oe=1;const dt={food:["FarmFresh","GrainCo","HarvestHub","OrchardInc","FoodWorks","NourishCo"],housing:["ShelterCo","HomeBase","RoofWorks","DwellCo","AbodeLtd","NestBuilders"],tech:["DataSpark","ByteForge","CodeWorks","TechVault","NeuralCo","SyntaxLtd"],luxury:["GoldEdge","EliteCo","PremiumHub","LuxuryInc","OpalWorks","CrestLtd"]};class Ae{constructor(e={}){this.id=e.id??Oe++,this.alive=!0,this.sector=e.sector??B[Math.floor(Math.random()*B.length)];const t=dt[this.sector];this.name=e.name??t[Math.floor(Math.random()*t.length)]+" #"+this.id,this.x=e.x??R(30,V-30),this.y=e.y??R(30,K-30),this.capital=e.capital??Se,this.revenue=0,this.expenses=0,this.profit=0,this.profitHistory=[],this.productivity=e.productivity??g(_(1,.2),.3,2.5),this.production=0,this.price=Y[this.sector],this.inventory=0,this.maxInventory=100,this.employees=[],this.maxEmployees=e.maxEmployees??Math.floor(R(Ye,ze)),this.wageOffered=e.wageOffered??12,this.hiringCooldown=0,this.firingCooldown=0,this.marketShare=0,this.dominance=0,this.ownerId=e.ownerId??null,this.sharesOutstanding=100,this.sharesAvailable=100,this.sharePrice=0,this.isPublic=!1,this.dividendRate=0,this.age=0,this.totalProduced=0,this.totalRevenue=0,this.events=[],this.radius=10,this.pulse=0}tick(e,t){this.alive&&(this.age++,this.hiringCooldown=Math.max(0,this.hiringCooldown-1),this.firingCooldown=Math.max(0,this.firingCooldown-1),this._produce(t),this._sellGoods(e.prices),this._payWages(t),this._applySecurityCosts(e),this._applyDepreciation(),this._adjustPriceStrategy(e),this._adjustWorkforce(e,t),this._checkBankruptcy(e),this._checkIPO(),this._updateSharePrice(e),this._payDividends(e),this._updateVisuals())}_produce(e){const t=this.employees.length;if(t===0){this.production=0;return}let s=ae[this.sector]*t*this.productivity;e.subsidiesFarming&&this.sector==="food"&&(s*=1.3),e.educationFunding>.5&&(s*=1+e.educationFunding*.1),this.production=Math.floor(s),this.inventory=Math.min(this.inventory+this.production,this.maxInventory),this.totalProduced+=this.production}_sellGoods(e){const t=e[this.sector]||Y[this.sector],s=Math.min(this.inventory,Math.floor(this.production*.9));this.revenue=s*t,this.inventory=Math.max(0,this.inventory-s),this.capital+=this.revenue,this.totalRevenue+=this.revenue}_payWages(e){const t=e.minWage||0,a=Math.max(this.wageOffered,t)*this.employees.length;if(this.expenses=a,this.capital-=a,this.profit=this.revenue-this.expenses,this.profitHistory.push(this.profit),this.profitHistory.length>50&&this.profitHistory.shift(),this.profit>0){const r=e.corporateTax||0,l=this.profit*r;this.capital-=l}this.profit>this.revenue*$e*2?this.wageOffered=Math.min(this.wageOffered*1.02,100):this.profit<0&&this.employees.length>0&&(this.capital<le/2?this.wageOffered=Math.max(this.wageOffered*.92,t):this.wageOffered=Math.max(this.wageOffered*.95,t))}_applySecurityCosts(e){var s;const t=((s=e.metrics)==null?void 0:s.crimeRate)||0;if(t>0){const a=t*this.employees.length*.1;this.capital-=a}}_applyDepreciation(){this.capital>500&&(this.capital-=(this.capital-500)*.003),this.capital-=this.employees.length*.5}_adjustPriceStrategy(e){var r,l,o;const t=this.wageOffered,s=this.employees.length>0?t*this.employees.length/Math.max(this.production,1):1;this._prevCostPerUnit&&s>this._prevCostPerUnit*1.02&&(this.price*=1+(s/this._prevCostPerUnit-1)*.3),this._prevCostPerUnit=s;const a=this.inventory/this.maxInventory;a>.8?this.price*=.995:a<.2&&this.production>0&&(this.price*=1.005),(r=e.policies)!=null&&r.antiMonopoly&&this.dominance>.4&&(this.price*=.99),!((l=e.policies)!=null&&l.antiMonopoly)&&this.dominance>.7?this.price*=1.035:!((o=e.policies)!=null&&o.antiMonopoly)&&this.dominance>.5&&(this.price*=1.02)}_adjustWorkforce(e,t){const s=this.production>0?Math.min(this.production/(ae[this.sector]*this.maxEmployees*this.productivity),1):0;this.hiringCooldown===0&&this.employees.length<this.maxEmployees&&s>Ve&&this.capital>this.wageOffered*20&&this._hire(e),this.firingCooldown===0&&this.employees.length>1&&(s<Ke||this.capital<0)&&this._fire(e)}_hire(e){var r,l;const t=((r=e.agents)==null?void 0:r.filter(o=>o.alive&&!o.employed&&!o.isOwner&&o.state!=="child"&&o.state!=="retired"))||[];if(t.length===0)return;t.sort((o,n)=>n.skill-o.skill);const s=t[0],a=Math.max(this.wageOffered,((l=e.policies)==null?void 0:l.minWage)||0);s.hire(this,a),this.employees.push(s.id),this.hiringCooldown=10,this.events.push(`Hired agent #${s.id}`)}_fire(e){var a;if(this.employees.length===0)return;const t=this.employees[this.employees.length-1];this.employees=this.employees.filter(r=>r!==t);const s=(a=e.agents)==null?void 0:a.find(r=>r.id===t);s&&s.fire("layoff"),this.firingCooldown=15,this.events.push(`Fired agent #${t}`)}_checkBankruptcy(e){this.capital<le&&this._close(e,"bankruptcy")}_close(e,t){var s,a,r;this.alive=!1,this.events.push(`Closed due to ${t}`);for(const l of this.employees){const o=(s=e.agents)==null?void 0:s.find(n=>n.id===l);o&&o.fire(t)}if(this.employees=[],this.isPublic&&this.capital>0&&e.agents){const l=Math.max(0,this.capital/this.sharesOutstanding);for(const o of e.agents){if(!o.alive||!o.portfolio)continue;const n=o.portfolio.findIndex(c=>c.businessId===this.id);n!==-1&&(o.wealth+=o.portfolio[n].shares*l,o.portfolio.splice(n,1))}}if(this.ownerId){const l=(a=e.agents)==null?void 0:a.find(o=>o.id===this.ownerId);l&&(l.isOwner=!1,l.businessId=null,l.events.push(`Business closed (${t}) at age ${Math.floor(l.age/52)}`),(r=l._updateState)==null||r.call(l))}}_checkIPO(){this.isPublic||this.age>100&&this.capital>1e3&&this.profit>0&&(this.isPublic=!0,this.sharesAvailable=60,this.events.push("Went public via IPO"))}_updateSharePrice(e){var l,o;if(!this.isPublic)return;const t=this.profitHistory.length>0?this.profitHistory.reduce((n,c)=>n+c,0)/this.profitHistory.length:0,s=Math.max(0,.05-(((l=e.policies)==null?void 0:l.interestRate)||.05))*100,a=10+(this.marketShare||0)*20+s;this.sharePrice=Math.max(0,t*a/this.sharesOutstanding);const r=((o=e.market)==null?void 0:o.avgExpectedInflation)||.02;r>.05&&(this.sharePrice*=1-Math.max(0,(r-.05)*2),this.sharePrice=Math.max(0,this.sharePrice))}_payDividends(e){var r;if(!this.isPublic||this.profit<=0||this.age%10!==0)return;this.dividendRate=g(.1+Math.random()*.2,.1,.3);const t=this.profit*this.dividendRate,s=((r=e.policies)==null?void 0:r.capitalGainsTax)||.15,a=e.agents||[];for(const l of a){if(!l.alive||!l.portfolio)continue;const o=l.portfolio.find(d=>d.businessId===this.id);if(!o||o.shares<=0)continue;const n=o.shares/this.sharesOutstanding,h=t*n*(1-s);l.wealth+=h,l.investmentIncome+=h}e.metrics&&(e.metrics.govBudget=(e.metrics.govBudget||0)+t*s*.1),this.capital-=t}_updateVisuals(){this.profit>this.revenue*.2?this.pulse=Math.min(1,this.pulse+.05):this.pulse=Math.max(0,this.pulse-.03),this.radius=8+this.employees.length*.5+this.pulse*3}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,sector:this.sector,name:this.name,capital:this.capital,revenue:this.revenue,profit:this.profit,production:this.production,price:this.price,inventory:this.inventory,employees:[...this.employees],employeeCount:this.employees.length,maxEmployees:this.maxEmployees,wageOffered:this.wageOffered,marketShare:this.marketShare,dominance:this.dominance,productivity:this.productivity,age:this.age,radius:this.radius,pulse:this.pulse,ownerId:this.ownerId,isPublic:this.isPublic,sharePrice:this.sharePrice,sharesOutstanding:this.sharesOutstanding,sharesAvailable:this.sharesAvailable,dividendRate:this.dividendRate}}}function ge(i,e,t={}){Oe=1;const s=[],a=Math.floor(i/B.length);for(const r of B)for(let l=0;l<a;l++){const o=new Ae({sector:r,capital:Se*(t.startCapitalMultiplier||1)*(.5+Math.random()),productivity:g(_(t.avgProductivity||1,.2),.3,2.5)*(.7+Math.random()*.6)}),n=e.filter(c=>c.alive&&!c.employed&&!c.isOwner&&c.state!=="child"&&c.state!=="retired"&&c.skill>.4);if(n.length>0){n.sort((h,d)=>d.skill-h.skill);const c=n[0];o.ownerId=c.id,c.isOwner=!0,c.businessId=o.id,c.employed=!0,c.employerId=o.id,c.wage=20,c.jobSector=r,c.state="owner",o.employees.push(c.id)}s.push(o)}return s}let Ne=1;const ut={mortgage:{termTicks:500,baseSpread:.01,label:"Mortgage"},business:{termTicks:200,baseSpread:.03,label:"Business Loan"},personal:{termTicks:100,baseSpread:.05,label:"Personal Loan"}},me=["First National Bank","Citizens Trust","Federal Reserve Bank","Commerce Bank","Merchant Bank","People's Savings Bank","Capital One Corp","Heritage Bank"];class He{constructor(e={}){this.id=e.id??Ne++,this.alive=!0,this.name=e.name??me[(this.id-1)%me.length],this.reserves=e.reserves??5e3,this.totalDeposits=0,this.loanBook=[],this.interestSpread=e.interestSpread??.02,this.nonPerformingRate=0,this._nextLoanId=1,this._writeOffs=0}tick(e,t){if(!this.alive)return;const s=t.reserveRequirement??.1;for(const n of this.loanBook){if(!n.active)continue;const c=e.agents.find(h=>h.id===n.agentId);if(!c||!c.alive){this._writeOff(n);continue}this._collectPayment(n,c,e,t)}const a=Math.max(0,(t.interestRate||.05)*.3),r=this.totalDeposits*a*.001;this.reserves-=r;for(const n of e.agents){if(!n.alive||n.deposits<=0||n._bankId!==this.id)continue;const c=n.deposits*a*.001;n.deposits+=c}this.totalDeposits=e.agents.filter(n=>n.alive&&n._bankId===this.id).reduce((n,c)=>n+(c.deposits||0),0);const l=this.loanBook.filter(n=>n.active),o=l.filter(n=>n.ticksOverdue>0);this.nonPerformingRate=l.length>0?o.length/l.length:0,this.loanBook=this.loanBook.filter(n=>n.active),this.reserves<this.totalDeposits*s&&this.totalDeposits>0&&this._fail(e,t)}_collectPayment(e,t,s,a){const r=e.monthlyPayment;if(t.wealth>=r)t.wealth-=r,e.remaining-=r,e.ticksOverdue=0,t.consecutiveMissedPayments=0,this.reserves+=r,t.creditScore=g(t.creditScore+1,300,850),e.remaining<=0&&(e.active=!1,t.loans=t.loans.filter(l=>l.id!==e.id),t.monthlyLoanPayment-=r,t.creditScore=g(t.creditScore+10,300,850),t.loans.length===0&&(t.inDebtSpiral=!1,t.wageGarnishmentRate=0,t.consecutiveMissedPayments=0));else{e.ticksOverdue++,t.consecutiveMissedPayments++,t.creditScore=g(t.creditScore-5,300,850),t.consecutiveMissedPayments>5&&(t.inDebtSpiral=!0);const l=(t.loans||[]).filter(o=>o.ticksOverdue>0);if(l.length>=3&&(t.wageGarnishmentRate=g(.1*l.length,0,.5)),e.ticksOverdue>=10&&e.ticksOverdue<=50&&Math.random()<.05){const o=r*3;s&&a&&this.canIssueLoan(t,"personal",o,a).approved&&(this.issueLoan(t,"personal",o,a),t.events.push(`Took desperation loan ($${Math.round(o)})`))}e.ticksOverdue>50&&(this._writeOff(e),t.creditScore=g(t.creditScore-50,300,850),t.loans=t.loans.filter(o=>o.id!==e.id),t.monthlyLoanPayment-=r)}}_writeOff(e){e.active=!1,this.reserves-=e.remaining*.5,this._writeOffs+=e.remaining}canIssueLoan(e,t,s,a){if(!this.alive)return{approved:!1,reason:"bank closed"};const r=a.reserveRequirement??.1,l=(this.totalDeposits+s)*r;if(this.reserves<l)return{approved:!1,reason:"insufficient reserves"};if(this.nonPerformingRate>.25)return{approved:!1,reason:"credit crunch â€” lending frozen"};let n={mortgage:500,business:550,personal:400}[t]||400;if(this.nonPerformingRate>.15&&(n+=100),e.creditScore<n)return{approved:!1,reason:"credit score too low"};if(t==="mortgage"){const d=a.maxLoanToValue??.8,p=50*100;if(s>p*d)return{approved:!1,reason:"exceeds max LTV"}}const c=e.loans.reduce((d,p)=>d+p.remaining,0)+s,h=Math.max(e.wage||e.income||1,1);return c/h>20?{approved:!1,reason:"debt-to-income too high"}:{approved:!0}}issueLoan(e,t,s,a){const r=ut[t];if(!r)return null;const l=a.interestRate||.05,o=Math.max(0,(700-e.creditScore)/1e3),n=l+r.baseSpread+o,c=r.termTicks,h=s*(1+n)/c,d={id:this._nextLoanId++,bankId:this.id,agentId:e.id,type:t,principal:s,remaining:s*(1+n),rate:n,monthlyPayment:h,ticksOverdue:0,active:!0};return this.loanBook.push(d),this.totalDeposits+=s,e.deposits+=s,e.loans.push(d),e.monthlyLoanPayment+=h,e.wealth+=s,d}_fail(e,t){var l;this.alive=!1;const s=t.depositInsurance??!0,a=1e3;for(const o of e.agents)!o.alive||o._bankId!==this.id||(s?(o.wealth+=Math.min(o.deposits,a),o.deposits>a&&o.events.push(`Lost $${Math.round(o.deposits-a)} in bank failure`)):o.events.push(`Lost $${Math.round(o.deposits)} in bank failure (no insurance)`),o.deposits=0,o._bankId=null);const r=((l=e.banks)==null?void 0:l.filter(o=>o.alive&&o.id!==this.id))||[];if(r.length>0)for(const o of this.loanBook.filter(n=>n.active)){const n=r[Math.floor(Math.random()*r.length)];o.bankId=n.id,n.loanBook.push(o)}else for(const o of this.loanBook.filter(n=>n.active)){o.active=!1;const n=e.agents.find(c=>c.id===o.agentId);n&&(n.loans=n.loans.filter(c=>c.id!==o.id),n.monthlyLoanPayment-=o.monthlyPayment,n.events.push("Loan forgiven â€” all banks failed"))}this.loanBook=[]}toSnapshot(){const e=this.loanBook.filter(t=>t.active);return{id:this.id,name:this.name,alive:this.alive,reserves:this.reserves,totalDeposits:this.totalDeposits,activeLoans:e.length,totalLoanValue:e.reduce((t,s)=>t+s.remaining,0),nonPerformingRate:this.nonPerformingRate,interestSpread:this.interestSpread}}}function ye(i=3){Ne=1;const e=[];for(let t=0;t<i;t++)e.push(new He({reserves:1500+Math.random()*2e3,interestSpread:.015+Math.random()*.01}));return e}function ve(i,e){for(const t of i){if(!t.alive)continue;const s=e[Math.floor(Math.random()*e.length)];t._bankId=s.id;const a=.3+Math.random()*.4,r=Math.max(0,t.wealth*a);t.deposits=r,t.wealth-=r}}function be(){return{prices:{...Y},supply:{food:0,housing:0,tech:0,luxury:0},demand:{food:0,housing:0,tech:0,luxury:0},inflation:0,cpi:100,basePrices:{...Y},inflationHistory:[],avgExpectedInflation:.02,centralBankCredibility:1,deflationDrag:0}}function pt(i,e,t,s={}){const{agents:a,businesses:r}=e,l=a.filter(p=>p.alive&&p.state!=="child"),o=r.filter(p=>p.alive);let n=0;for(const p of B){let m=o.filter(M=>M.sector===p).reduce((M,N)=>M+N.production,0);const v=s[p];v&&(m+=v.imports||0,m-=v.exports||0,m=Math.max(0,m));const b=l.filter(M=>M.employed||M.isOwner),C=b.length>0?b.reduce((M,N)=>M+(N.wage||20),0)/b.length:20,u={food:.15,housing:.25,tech:.1,luxury:.05};let w=l.length*C*(u[p]||.1);w*=.9+Math.random()*.2,w*=1-(i.deflationDrag||0);const D=.05-(t.interestRate||.05),E=p==="housing"?1+D*25:1+D*8;w*=Math.max(.5,E),t.helicopterMoney>0&&(w+=l.length*t.helicopterMoney*(u[p]||.1)*.8);const A=i.avgExpectedInflation||.02;w*=1+Math.max(0,A-.02)*5,i.supply[p]=m,i.demand[p]=w;const H=Math.max(m,1),U=(w-H)/H,G=Ue[p];let x=U*G*.05;p==="food"&&t.priceControlFood&&(x=g(x,-.01,.01)),p==="housing"&&t.priceControlHousing&&(x=g(x,-.01,.01)),t.printMoney>0&&(x+=t.printMoney*.001);const F=15;if(C>F){const M=(C-F)/F;x+=M*.003}const z=i.prices.food||10;z>30?x+=.003:z>20&&(x+=.001),t.punitiveTargiffs>0&&(x+=t.punitiveTargiffs*.002);const f=i.prices[p],k=g(f*(1+g(x,-.08,.08)),je[p],qe[p]);i.prices[p]=k;for(const M of o.filter(N=>N.sector===p))M.price=k;n+=(k-f)/f}const c=n/B.length;if(c<0){const p=Math.abs(c);for(const m of l)if(!(!m.loans||m.loans.length===0))for(const v of m.loans)v.active&&(v.remaining*=1+p*.5);i.deflationDrag=g(p*2,0,.3)}else i.deflationDrag=Math.max(0,(i.deflationDrag||0)*.9);const h={food:.35,housing:.35,tech:.15,luxury:.15};return i.cpi=B.reduce((p,m)=>p+i.prices[m]/i.basePrices[m]*h[m]*100,0),i.inflation=n/B.length*52,ft(o),i.inflationHistory.push(i.inflation),i.inflationHistory.length>200&&i.inflationHistory.shift(),l.length>0&&(i.avgExpectedInflation=l.reduce((p,m)=>p+(m.inflationExpectation||.02),0)/l.length),Math.abs(i.inflation*100-2)>5?i.centralBankCredibility=g(i.centralBankCredibility-.002,0,1):i.centralBankCredibility=g(i.centralBankCredibility+.001,0,1),i}function ft(i){for(const e of B){const t=i.filter(a=>a.sector===e),s=t.reduce((a,r)=>a+r.production,0);if(s!==0)for(const a of t)a.marketShare=a.production/s,a.dominance=a.marketShare}}function gt(i,e){return i.businesses.filter(s=>s.alive).reduce((s,a)=>s+a.production*e.prices[a.sector],0)}function mt(i){const e=i.filter(s=>s.alive&&s.state!=="child"&&s.state!=="retired"&&s.state!=="dead");return e.length===0?0:e.filter(s=>s.state==="unemployed").length/e.length}function yt(i){const e=i.filter(s=>s.alive&&s.state!=="dead"&&s.state!=="child");return e.length===0?0:e.filter(s=>s.wealth<100).length/e.length}function vt(i,e){var l,o;const{agents:t,businesses:s}=i,a=t.filter(n=>n.alive&&n.state==="unemployed"&&n.age>18*52&&!n.incarcerated),r=s.filter(n=>n.alive&&n.employees.length<n.maxEmployees&&n.capital>n.wageOffered*10);if(!(a.length===0||r.length===0))for(const n of r){if(a.length===0)break;let c=0,h=-1/0;for(let m=0;m<a.length;m++){const v=a[m],b=v.x-n.x,C=v.y-n.y,u=Math.sqrt(b*b+C*C),w=(((l=v.criminalRecord)==null?void 0:l.length)||0)>2?.5:(((o=v.criminalRecord)==null?void 0:o.length)||0)*.1,S=v.skill*.7+v.education*.3-u*.001-w;S>h&&(h=S,c=m)}const d=a[c],p=bt(n,d,e,i);n.capital>p*5&&(d.hire(n,p),n.employees.push(d.id),n.hiringCooldown=10,a.splice(c,1))}}function bt(i,e,t,s){var d;const a=t.minWage||0,r=i.wageOffered,l=e.skill*10+e.education*5;let o=r*(1-ce)+l*ce;const c=1-(((d=s==null?void 0:s.metrics)==null?void 0:d.unemployment)??.1),h=Math.pow(c,3)*.3;return o*=1+h,Math.max(o,a)}function we(i={}){return{...Ze,...i}}function wt(i,e,t){var l;const{agents:s,businesses:a}=i;if(e.minWage>0)for(const o of a.filter(n=>n.alive))o.wageOffered<e.minWage&&(o.wageOffered=e.minWage,o.capital<e.minWage*o.employees.length*20);if(e.antiMonopoly)for(const o of a.filter(n=>n.alive&&n.dominance>.5))o.maxEmployees=Math.max(5,Math.floor(o.maxEmployees*.9));const r=Math.max(0,e.interestRate-.05);if(r>0)for(const o of a.filter(n=>n.alive))o.capital-=o.capital*r*2e-4;if(e.printMoney>0){const o=e.printMoney,n=s.filter(c=>c.alive&&c.state!=="dead");for(const c of n)c.wealth+=o*.01}if(e.educationFunding>.3){const o=s.filter(n=>n.alive&&n.age<1560&&n.state!=="dead");for(const n of o)Math.random()<e.educationFunding*1e-4&&(n.skill=g(n.skill+.001,0,1),n.education=g(n.education+.001,0,1))}if(e.publicHealthcare&&Math.random()<.001){const o=s.filter(n=>n.alive&&n.health<.5);for(const n of o.slice(0,5))n.health=g(n.health+.01,0,1)}if(e.fourDayWeek){for(const o of a.filter(n=>n.alive))o.production=(o.production||1)*.82;if(Math.random()<.01)for(const o of s.filter(n=>n.alive))o.health=g(o.health+5e-4,0,1)}if(e.robotTax>0)for(const o of a.filter(n=>n.alive&&n.sector==="tech")){const n=o.capital*e.robotTax*5e-4;o.capital-=n,i.govBudget=(i.govBudget||0)+n}if(e.breadAndCircuses){if(i.govBudget=(i.govBudget||0)-.5,Math.random()<.02)for(const o of s.filter(n=>n.alive))o.happiness=g((o.happiness||.5)+.002,0,1);i.unrestLevel=Math.max(0,(i.unrestLevel||0)-.001)}if(e.mandatoryProfitShare>0)for(const o of a.filter(n=>{var c;return n.alive&&((c=n.employees)==null?void 0:c.length)>0})){const n=Math.max(0,o.capital*e.mandatoryProfitShare*.001),c=n/o.employees.length;o.capital-=n;for(const h of o.employees){const d=s.find(p=>p.id===h);d&&(d.wealth+=c)}}if(e.landValueTax>0)for(const o of s.filter(n=>n.alive&&n.wealth>100)){const n=o.wealth*e.landValueTax*2e-4;o.wealth-=n,i.govBudget=(i.govBudget||0)+n}if(e.banAdvertising)for(const o of a.filter(n=>n.alive&&n.sector==="luxury"))o.maxEmployees=Math.max(3,Math.floor((o.maxEmployees||10)*.999));if(e.debtJubilee){for(const o of s.filter(n=>n.alive&&n.wealth<0))o.wealth=0;for(const o of s.filter(n=>{var c;return n.alive&&((c=n.loans)==null?void 0:c.length)>0})){for(const n of o.loans){const h=(i.banks||[]).find(d=>d.id===n.bankId);h&&(h.reserves-=n.remaining*.5,h.loanBook=h.loanBook.filter(d=>d.id!==n.id)),n.active=!1}o.loans=[],o.monthlyLoanPayment=0,o.hasMortgage=!1}i._jubileeApplied=!0}if(e.lotteryRedistribution&&Math.random()<.05){const o=s.filter(c=>c.alive&&c.wealth>200).sort((c,h)=>h.wealth-c.wealth),n=s.filter(c=>c.alive&&c.wealth<50);if(o.length&&n.length){const c=o[Math.floor(Math.random()*Math.min(10,o.length))],h=n[Math.floor(Math.random()*n.length)],d=c.wealth*.05;c.wealth-=d,h.wealth+=d}}if(e.sumptuary)for(const o of s.filter(n=>n.alive&&n.wealth>300))o._sumptuaryLimited=!0;else for(const o of s.filter(n=>n._sumptuaryLimited))o._sumptuaryLimited=!1;if(e.degrowth&&Math.random()<.005){for(const o of a.filter(n=>n.alive))o.production=(o.production||1)*.999;for(const o of s.filter(n=>n.alive))o.health=g(o.health+1e-4,0,1)}if(e.algoCentralPlanning&&t)for(const o of Object.keys(t.prices||{})){const n=t.prices[o];t.prices[o]=n*.995+(((l=t._algoTarget)==null?void 0:l[o])||n)*.005}if(e.universalBankAccount&&Math.random()<.002)for(const o of s.filter(n=>n.alive&&n.wealth<20))o.wealth=g(o.wealth+.5,0,20);if(e.policeFunding>0){const o=s.filter(n=>n.alive).length*e.policeFunding*.05;i.govBudget=(i.govBudget||0)-o}if(e.financialOversight>0){const o=a.filter(n=>n.alive).length*e.financialOversight*.03;i.govBudget=(i.govBudget||0)-o}if(e.prisonReform){const o=s.filter(n=>n.alive&&n.incarcerated);i.govBudget=(i.govBudget||0)-o.length*.02}if(e.helicopterMoney>0){const o=e.helicopterMoney*.01;for(const n of s.filter(c=>c.alive))n.wealth+=o;i.govBudget=(i.govBudget||0)-o*s.filter(n=>n.alive).length*.1}if(e.maximumWage>0){for(const o of a.filter(n=>n.alive))o.wageOffered>e.maximumWage&&(o.wageOffered=e.maximumWage);if(Math.random()<.002)for(const o of s.filter(n=>n.alive&&n.skill>.7))o.skill=g(o.skill-.001,0,1)}if(e.wealthConfiscation>0)for(const o of s.filter(n=>n.alive&&n.wealth>1e3)){const n=(o.wealth-1e3)*e.wealthConfiscation*.01;o.wealth-=n,i.govBudget=(i.govBudget||0)+n}if(e.nationalizeIndustries)for(const o of a.filter(n=>n.alive)){o._nationalized=!0;const n=Math.max(e.minWage||10,15);o.wageOffered=n,o.production=(o.production||1)*.92,i.govBudget=(i.govBudget||0)-o.employees.length*n*.001}else for(const o of a.filter(n=>n._nationalized))delete o._nationalized;if(e.punitiveTargiffs>0&&(t!=null&&t.prices))for(const o of Object.keys(t.prices))t.prices[o]*=1+e.punitiveTargiffs*2e-4;if(e.guaranteedJobs){const o=s.filter(n=>n.alive&&!n.employed&&n.age>936);for(const n of o)n.employed=!0,n._govJob=!0,n.wage=Math.max(e.minWage||10,12),n.wealth+=n.wage*.001;i.govBudget=(i.govBudget||0)-o.length*(e.minWage||12)*.001}else for(const o of s.filter(n=>n._govJob))delete o._govJob}function ke(){return{tick:0,year:0,gdp:0,gdpGrowth:0,gini:0,unemployment:0,povertyRate:0,cpi:100,inflation:0,avgWage:0,avgWealth:0,medianWealth:0,socialUnrest:0,population:0,businessCount:0,bankruptcies:0,totalTaxRevenue:0,govBudget:0,govDebt:0,govInterestPayments:0,crimeRate:0,streetCrimeCount:0,corporateCrimeCount:0,prisonPopulation:0,totalPrivateDebt:0,nonPerformingLoans:0,avgCreditScore:0,bankCount:0,mortgageRate:0,agentsInDebtSpiral:0,avgDebtToIncome:0,inflationExpectations:.02,centralBankCredibility:1,totalMarketCap:0,publicCompanies:0,avgDividendYield:0,tradeBalance:0,fxRate:1,foreignReserves:500,exports:0,imports:0,pendingPolicyCount:0,history:{gdp:[],gini:[],unemployment:[],cpi:[],inflation:[],population:[],unrest:[],wages:[],poverty:[],govBudget:[],businessCount:[],medianWealth:[],privateDebt:[],creditScore:[],crime:[],prisonPop:[],sectorPrices:{food:[],housing:[],tech:[],luxury:[]},debtSpiral:[],inflationExp:[],cbCredibility:[],marketCap:[],fxRate:[],tradeBalance:[]}}}function Me(i,e,t,s){var z;const{agents:a,businesses:r}=e,l=a.filter(f=>f.alive&&f.state!=="dead"),o=r.filter(f=>f.alive);i.tick++,i.year=Math.floor(i.tick/52),i.population=l.length,i.businessCount=o.length;const n=l.map(f=>Math.max(0,f.wealth));i.gini=ct(n),i.avgWealth=pe(n),i.medianWealth=ht(n,50);const c=i.gdp;i.gdp=gt(e,t),i.gdpGrowth=c>0?(i.gdp-c)/c:0,i.unemployment=mt(l),i.povertyRate=yt(l);const h=l.filter(f=>f.employed&&f.wage>0);i.avgWage=h.length>0?h.reduce((f,k)=>f+k.wage,0)/h.length:0,i.cpi=t.cpi,i.inflation=t.inflation*100;const d=l.map(f=>f.unrest);i.socialUnrest=pe(d);const p=kt(l,o,s),m=Mt(l,s);i.totalTaxRevenue=p,i.govBudget=p-m,i.govDebt+=-i.govBudget*.1;const v=Math.abs(i.govDebt)/Math.max(i.gdp,1),b=v>1?(v-1)*.02:0,C=(s.interestRate||.05)+b;if(i.govDebt>0){const f=i.govDebt*C*.01;i.govDebt+=f,i.govInterestPayments=f}else i.govInterestPayments=0;i.govDebt=Math.max(-5e4,Math.min(5e4,i.govDebt));const u=i.history;T(u.gdp,i.gdp),T(u.gini,i.gini),T(u.unemployment,i.unemployment*100),T(u.cpi,i.cpi),T(u.inflation,i.inflation),T(u.population,i.population),T(u.unrest,i.socialUnrest*100),T(u.wages,i.avgWage),T(u.poverty,i.povertyRate*100),T(u.govBudget,i.govBudget),T(u.businessCount,i.businessCount),T(u.medianWealth,i.medianWealth),u.sectorPrices||(u.sectorPrices={food:[],housing:[],tech:[],luxury:[]});for(const f of["food","housing","tech","luxury"])T(u.sectorPrices[f],((z=t.prices)==null?void 0:z[f])||0);const w=e._crimeLog||[];i.streetCrimeCount=w.filter(f=>f.category==="street").length,i.corporateCrimeCount=w.filter(f=>f.category==="corporate").length;const S=i.streetCrimeCount+i.corporateCrimeCount;i.crimeRate=i.population>0?S/i.population*1e3:0,i.prisonPopulation=l.filter(f=>f.incarcerated).length,e._crimeLog&&(e._crimeLog.length=0),u.crime||(u.crime=[]),u.prisonPop||(u.prisonPop=[]),T(u.crime,i.crimeRate),T(u.prisonPop,i.prisonPopulation);const E=(e.banks||[]).filter(f=>f.alive);i.bankCount=E.length,i.totalPrivateDebt=l.reduce((f,k)=>f+(k.loans||[]).reduce((M,N)=>M+(N.remaining||0),0),0),i.nonPerformingLoans=E.reduce((f,k)=>f+(k.loanBook||[]).filter(M=>M.active&&M.ticksOverdue>0).length,0);const A=l.map(f=>f.creditScore||500);i.avgCreditScore=A.length>0?A.reduce((f,k)=>f+k,0)/A.length:500;const H=s.interestRate||.05,U=E.length>0?E.reduce((f,k)=>f+k.interestSpread,0)/E.length:.02;i.mortgageRate=H+U,u.privateDebt||(u.privateDebt=[]),u.creditScore||(u.creditScore=[]),T(u.privateDebt,i.totalPrivateDebt),T(u.creditScore,i.avgCreditScore),i.agentsInDebtSpiral=l.filter(f=>f.inDebtSpiral).length;const G=l.filter(f=>f.income>0);i.avgDebtToIncome=G.length>0?G.reduce((f,k)=>{const M=(k.loans||[]).reduce((N,We)=>N+(We.remaining||0),0);return f+M/Math.max(k.income,1)},0)/G.length:0,u.debtSpiral||(u.debtSpiral=[]),T(u.debtSpiral,i.agentsInDebtSpiral),i.inflationExpectations=t.avgExpectedInflation||.02,i.centralBankCredibility=t.centralBankCredibility||1,u.inflationExp||(u.inflationExp=[]),u.cbCredibility||(u.cbCredibility=[]),T(u.inflationExp,i.inflationExpectations*100),T(u.cbCredibility,i.centralBankCredibility*100),i.publicCompanies=o.filter(f=>f.isPublic).length,i.totalMarketCap=o.filter(f=>f.isPublic).reduce((f,k)=>f+(k.sharePrice||0)*(k.sharesOutstanding||0),0);const x=o.filter(f=>f.isPublic&&f.sharePrice>0);i.avgDividendYield=x.length>0?x.reduce((f,k)=>f+(k.dividendRate||0),0)/x.length:0,u.marketCap||(u.marketCap=[]),T(u.marketCap,i.totalMarketCap);const F=e.globalEconomy;if(F){i.fxRate=F.fxRate,i.foreignReserves=F.foreignReserves;const f=F.tradeBalance;i.tradeBalance=Object.values(f).reduce((k,M)=>k+M,0),i.exports=Object.values(f).reduce((k,M)=>k+Math.max(0,M),0),i.imports=Object.values(f).reduce((k,M)=>k+Math.abs(Math.min(0,M)),0)}return u.fxRate||(u.fxRate=[]),u.tradeBalance||(u.tradeBalance=[]),T(u.fxRate,i.fxRate),T(u.tradeBalance,i.tradeBalance),i}function T(i,e){i.push(Math.round(e*100)/100),i.length>rt&&i.shift()}function kt(i,e,t){const s=i.filter(l=>l.employed&&l.wage>0).reduce((l,o)=>l+o.wage*(t.incomeTax||0),0),a=e.filter(l=>l.profit>0).reduce((l,o)=>l+o.profit*(t.corporateTax||0),0),r=i.filter(l=>l.wealth>J).reduce((l,o)=>l+(o.wealth-J)*(t.wealthTax||0),0);return s+a+r}function Mt(i,e){const s=i.filter(d=>d.state==="unemployed").length*(e.unemploymentBenefit||0)*.1,a=i.filter(d=>d.state!=="child").length*(e.ubi||0)*.01,r=e.publicHealthcare?i.length*.5:0,l=i.length*(e.educationFunding||0)*.2,o=i.length*(e.policeFunding||0)*.05,n=i.length*(e.financialOversight||0)*.03,c=e.prisonReform?i.filter(d=>d.incarcerated).length*.02:0,h=i.length*(e.exportSubsidies||0)*.1;return s+a+r+l+o+n+c+h}function q(i){return{tick:i.tick,year:i.year,gdp:i.gdp,gdpGrowth:i.gdpGrowth,gini:i.gini,unemployment:i.unemployment,povertyRate:i.povertyRate,cpi:i.cpi,inflation:i.inflation,avgWage:i.avgWage,avgWealth:i.avgWealth,medianWealth:i.medianWealth,socialUnrest:i.socialUnrest,population:i.population,businessCount:i.businessCount,govDebt:i.govDebt,govInterestPayments:i.govInterestPayments,totalTaxRevenue:i.totalTaxRevenue,crimeRate:i.crimeRate,streetCrimeCount:i.streetCrimeCount,corporateCrimeCount:i.corporateCrimeCount,prisonPopulation:i.prisonPopulation,totalPrivateDebt:i.totalPrivateDebt,nonPerformingLoans:i.nonPerformingLoans,avgCreditScore:i.avgCreditScore,bankCount:i.bankCount,mortgageRate:i.mortgageRate,agentsInDebtSpiral:i.agentsInDebtSpiral,avgDebtToIncome:i.avgDebtToIncome,inflationExpectations:i.inflationExpectations,centralBankCredibility:i.centralBankCredibility,totalMarketCap:i.totalMarketCap,publicCompanies:i.publicCompanies,avgDividendYield:i.avgDividendYield,pendingPolicyCount:i.pendingPolicyCount,tradeBalance:i.tradeBalance,fxRate:i.fxRate,foreignReserves:i.foreignReserves,exports:i.exports,imports:i.imports,history:i.history}}const y={PANDEMIC:"pandemic",CROP_FAILURE:"cropFailure",TECH_BREAKTHROUGH:"techBreakthrough",FINANCIAL_BUBBLE:"financialBubble",CORRUPTION:"corruption",IMMIGRATION_WAVE:"immigrationWave",RECESSION:"recession",BOOM:"boom",HYPERINFLATION:"hyperinflation",GENERAL_STRIKE:"generalStrike",BANK_RUN:"bankRun",BRAIN_DRAIN:"brainDrain",REVOLUTION:"revolution",CRIME_WAVE:"crimeWave",VOTE_OF_NO_CONFIDENCE:"voteOfNoConfidence"},Fe={[y.PANDEMIC]:{name:"Pandemic",description:"A disease is spreading fast. How do you respond?",duration:200,icon:"ðŸ¦ ",hint:"After choosing, consider raising Interest Rate to cool any inflation from stimulus spending, or boost Education Funding to rebuild productivity faster. If you chose lockdown, UBI can keep citizens afloat while businesses are shut.",effects:{healthMultiplier:.7,productionMultiplier:.6,deathRateMultiplier:3,consumerSpendingMultiplier:.5},choices:[{id:"lockdown",label:"Lockdown",emoji:"ðŸ ",description:"Shut down non-essential businesses. Mandate isolation.",tradeoff:"Saves lives, fewer deaths. GDP falls sharply. Unemployment spikes short-term.",historicalNote:"COVID lockdowns (2020) saved millions but triggered the sharpest recession since WWII.",effectOverride:{healthMultiplier:.95,productionMultiplier:.4,deathRateMultiplier:1.2,duration:150},followUpEvents:[{type:"recession",delay:80}]},{id:"herd_immunity",label:"Herd Immunity",emoji:"ðŸ§¬",description:"Keep the economy open. Let the disease spread to build immunity.",tradeoff:"Economy keeps running. Much higher death toll. Healthcare system may collapse.",historicalNote:"Sweden's initial COVID approach â€” lower short-term GDP hit but higher deaths.",effectOverride:{healthMultiplier:.5,productionMultiplier:.8,deathRateMultiplier:5,duration:250}},{id:"targeted_support",label:"Targeted Support",emoji:"ðŸ’‰",description:"Protect vulnerable groups. Support businesses. Invest in healthcare.",tradeoff:"Balanced outcome. Costs significant government spending.",historicalNote:"Germany's Kurzarbeit (short-work) scheme kept unemployment low during COVID.",effectOverride:{healthMultiplier:.8,productionMultiplier:.65,deathRateMultiplier:1.8,duration:180},govDebtPenalty:1e3}]},[y.CROP_FAILURE]:{name:"Crop Failure",description:"Severe drought has decimated harvests. Food prices are spiking. The poor can't eat. What do you do?",duration:150,icon:"ðŸŒ¾",hint:"Food prices hit the poor hardest. Consider raising UBI or Unemployment Benefits to keep people fed. If you chose price controls, watch for a Crime Wave from black markets. Farming Subsidies can help prevent the next crisis.",effects:{foodSupplyMultiplier:.3,foodPriceMultiplier:2.5},choices:[{id:"food_aid",label:"Emergency Food Aid",emoji:"ðŸž",description:"Government distributes food and subsidizes prices for low-income households.",tradeoff:"Prevents starvation and unrest. Costs government significantly. Doesn't fix supply.",historicalNote:"US food stamps (1939, expanded 1961) prevented widespread malnutrition during agricultural crises.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.4,duration:120},govDebtPenalty:600},{id:"price_controls_food",label:"Cap Food Prices",emoji:"ðŸ·ï¸",description:"Legally limit how much food can cost. Sellers cannot raise prices above the cap.",tradeoff:"Keeps food accessible short-term. Reduces farmer incentives â€” may worsen next harvest.",historicalNote:"USSR price controls kept bread cheap but caused chronic shortages and black markets.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.1,duration:200},policyOverrides:{priceControlFood:!0},followUpEvents:[{type:"crimeWave",delay:100}]},{id:"import_food",label:"Open Food Imports",emoji:"ðŸš¢",description:"Remove trade barriers on food. International supply fills the gap.",tradeoff:"Quickly stabilizes prices. Hurts domestic farmers long-term. Adds trade dependency.",historicalNote:"Ireland's famine (1845) was worsened by British refusal to halt food exports. Open imports could have saved millions.",effectOverride:{foodSupplyMultiplier:.8,foodPriceMultiplier:1.3,duration:100},policyOverrides:{openBorders:!0}}]},[y.TECH_BREAKTHROUGH]:{name:"Tech Breakthrough",description:"A new technology could double productivity â€” but automate 20% of jobs. How do you respond to this disruption?",duration:300,icon:"ðŸš€",hint:"Automation destroys jobs. Boost Education Funding to retrain workers, or enable UBI to support the displaced. If inequality spikes, a Wealth Tax on tech winners can redistribute gains. Raising Min Wage protects remaining workers from a race to the bottom.",effects:{techProductivityMultiplier:2,techWorkerWageMultiplier:1.5,otherJobsAutomatedRate:.1},choices:[{id:"embrace_tech",label:"Embrace It Fully",emoji:"ðŸ¤–",description:"Let the market adopt technology at full speed. No restrictions.",tradeoff:"Maximum GDP growth. Rapid job displacement. High inequality surge.",historicalNote:"Industrial Revolution (1760s+): enormous long-term gains, but decades of worker misery before adaptation.",effectOverride:{techProductivityMultiplier:2.5,techWorkerWageMultiplier:2,otherJobsAutomatedRate:.25,duration:300},followUpEvents:[{type:"generalStrike",delay:200}]},{id:"managed_transition",label:"Managed Transition",emoji:"ðŸŽ“",description:"Tax tech gains, fund retraining programs and transition support for displaced workers.",tradeoff:"Slower adoption but smoother adjustment. Higher government cost. Better long-term stability.",historicalNote:`Germany's "Kurzarbeit" and Denmark's "flexicurity" â€” managed disruption with strong safety nets.`,effectOverride:{techProductivityMultiplier:1.7,techWorkerWageMultiplier:1.3,otherJobsAutomatedRate:.08,duration:250},govDebtPenalty:800,policyOverrides:{educationFunding:.8,unemploymentBenefit:150}},{id:"restrict_automation",label:"Regulate Automation",emoji:"â›”",description:"Limit how quickly companies can replace workers with machines. Robot tax.",tradeoff:"Protects jobs short-term. Slows GDP growth. May fall behind globally.",historicalNote:"Luddites (1811) destroyed textile machinery. Short-term protection, but technology won eventually.",effectOverride:{techProductivityMultiplier:1.2,techWorkerWageMultiplier:1.1,otherJobsAutomatedRate:.03,duration:350}}]},[y.FINANCIAL_BUBBLE]:{name:"Financial Bubble",description:"Asset prices are wildly inflated. A crash appears imminent. How do you respond?",duration:250,icon:"ðŸ’¥",hint:"After the crash, raise the Reserve Requirement and Financial Oversight to prevent reckless lending from happening again. Lower Interest Rate to stimulate recovery. If unemployment spikes, UBI or Unemployment Benefits can soften the blow.",effects:{wealthInflationPhase:1.5,wealthCrashPhase:.4},choices:[{id:"let_it_burn",label:"Let It Burn",emoji:"ðŸ”¥",description:"No intervention. Let markets correct naturally.",tradeoff:"Short, sharp crash. High unemployment spike. Faster long-term recovery.",historicalNote:"Hoover's approach in 1929 â€” worsened the Depression when banks also failed.",effectOverride:{wealthCrashPhase:.25,duration:150},followUpEvents:[{type:"bankRun",delay:80}]},{id:"bailout",label:"Bail Out Banks",emoji:"ðŸ¦",description:"Government buys toxic assets. Prevent bank collapse.",tradeoff:"Softer crash, but adds massive debt and rewards recklessness. Slow recovery.",historicalNote:"TARP (2008) â€” prevented depression but caused lasting public anger.",effectOverride:{wealthCrashPhase:.6,duration:350},govDebtPenalty:2e3,followUpEvents:[{type:"voteOfNoConfidence",delay:200}]},{id:"regulate",label:"Emergency Controls",emoji:"âš–ï¸",description:"Freeze credit, impose capital controls, force write-downs.",tradeoff:"Medium crash severity. Suppresses growth for years but prevents another bubble.",historicalNote:"Sweden 1992: nationalized banks, forced writedowns, recovered fully in 3 years.",effectOverride:{wealthCrashPhase:.45,duration:200},policyOverrides:{antiMonopoly:!0,interestRate:.08}}]},[y.CORRUPTION]:{name:"Corruption Scandal",description:"Government corruption diverts tax revenue. Public services collapse.",duration:180,icon:"ðŸ’°",effects:{taxRevenueLeakage:.5,publicTrustMultiplier:.6}},[y.IMMIGRATION_WAVE]:{name:"Immigration Wave",description:"Skilled workers arrive, boosting productivity but increasing competition for jobs.",duration:0,icon:"ðŸŒ",effects:{newAgentCount:30,newAgentSkillBonus:.3}},[y.RECESSION]:{name:"Recession",description:"The economy is contracting. Businesses are cutting, unemployment is rising. What's your response?",duration:200,icon:"ðŸ“‰",hint:"Lower the Interest Rate to make borrowing cheaper and stimulate growth. Increase UBI or Unemployment Benefits to support laid-off workers. If government debt is already high, raise Income Tax or Corporate Tax to fund the recovery without printing money.",effects:{demandMultiplier:.6,businessCapitalDrain:.02,hiringSuppression:!0},choices:[{id:"stimulus",label:"Stimulus Package",emoji:"ðŸ’µ",description:"Government spending on infrastructure, public jobs, and direct payments.",tradeoff:"Kickstarts demand. Adds to government debt. May cause mild inflation.",historicalNote:"FDR's New Deal (1933), Obama's ARRA (2009), Biden's ARP (2021) â€” all used stimulus to end recessions.",effectOverride:{demandMultiplier:.85,businessCapitalDrain:.01,hiringSuppression:!1,duration:130},govDebtPenalty:1500,followUpEvents:[{type:"boom",delay:150}]},{id:"austerity",label:"Austerity",emoji:"âœ‚ï¸",description:"Cut government spending. Reduce deficit. Let weak firms fail.",tradeoff:"Improves budget balance. Deepens recession short-term. May extend recovery by years.",historicalNote:"UK and EU austerity (2010-2015) extended the recession and caused a lost generation of unemployment.",effectOverride:{demandMultiplier:.45,businessCapitalDrain:.04,hiringSuppression:!0,duration:280},policyOverrides:{unemploymentBenefit:0,educationFunding:.1},followUpEvents:[{type:"generalStrike",delay:120}]},{id:"rate_cut",label:"Cut Interest Rates",emoji:"ðŸ¦",description:"Lower borrowing costs to encourage investment and spending.",tradeoff:"Helps businesses invest. Limited effect if rates are already near zero.",historicalNote:"Fed cut rates to near-zero in 2008 and 2020 â€” effective, but creates risk of asset bubbles.",effectOverride:{demandMultiplier:.72,businessCapitalDrain:.01,hiringSuppression:!1,duration:160},policyOverrides:{interestRate:.005}}]},[y.BOOM]:{name:"Economic Boom",description:"Consumer confidence surges. Spending rises, businesses thrive.",duration:150,icon:"ðŸ“ˆ",effects:{demandMultiplier:1.4,hiringBoost:!0,wageGrowthRate:1.02}},[y.HYPERINFLATION]:{name:"Hyperinflation Spiral",description:"Prices are doubling every few weeks. Currency is losing value faster than anyone can spend it. People are using wheelbarrows of cash to buy bread. What do you do?",duration:300,icon:"ðŸ’¸",hint:"Stop the bleeding: set Print Money to 0 immediately and raise the Interest Rate sharply (15%+). This will cause a recession but stop the spiral. After prices stabilize, slowly lower rates again. Enable Foreign Reserve Intervention if available to defend the currency.",effects:{priceMultiplierPerTick:1.008,wageErosionRate:.005,savingsDestructionRate:.01},choices:[{id:"currency_reform",label:"Currency Reform",emoji:"ðŸª™",description:"Issue a new currency. Peg it to gold or a foreign reserve. Immediately restore confidence â€” if anyone believes you.",tradeoff:"Stops inflation fast. Requires credibility and foreign reserves. Painful one-time wealth reset.",historicalNote:"Germany's 1923 Rentenmark replaced the worthless Mark overnight. Inflation stopped within weeks â€” but required complete institutional trust.",effectOverride:{priceMultiplierPerTick:1,wageErosionRate:0,savingsDestructionRate:0,duration:50},govDebtPenalty:500},{id:"interest_rate_shock",label:"Shock Interest Rates",emoji:"ðŸ¦",description:"Raise interest rates to 20%+. Crush demand. Stop the money printing. It will cause a severe recession.",tradeoff:"Kills inflation but triggers mass unemployment and recession. Volcker shock medicine.",historicalNote:"Paul Volcker (1980-82) raised US rates to 20% to kill stagflation. Inflation died. So did 2 years of growth.",effectOverride:{priceMultiplierPerTick:1.001,wageErosionRate:.002,savingsDestructionRate:.003,duration:150},policyOverrides:{interestRate:.2,printMoney:0},followUpEvents:[{type:"recession",delay:60}]},{id:"price_freeze",label:"Emergency Price Freeze",emoji:"ðŸ§Š",description:"Legally freeze all prices where they are. Sounds good. Historically causes shortages, black markets, and collapse within months.",tradeoff:"Appears to stop inflation on paper. Creates chronic shortages and black markets.",historicalNote:"Nixon's 1971 price controls temporarily stopped inflation â€” then it came back worse. Venezuela's price controls in 2010s caused empty supermarkets.",effectOverride:{priceMultiplierPerTick:1,wageErosionRate:.003,savingsDestructionRate:.008,duration:400},policyOverrides:{priceControlFood:!0,priceControlHousing:!0},followUpEvents:[{type:"crimeWave",delay:150}]}]},[y.GENERAL_STRIKE]:{name:"General Strike",description:"Workers across every sector have walked off the job. Production has stopped. Shelves are emptying. The labor movement is demanding radical change. How do you respond?",duration:180,icon:"âœŠ",hint:"Workers are angry about low pay and inequality. Raise the Min Wage and enable UBI to address root grievances. If you negotiate, the economy recovers fast but costs rise. Long-term, boost Education Funding so workers have better opportunities.",effects:{productionMultiplier:.1,businessCapitalDrain:.03,unrestLevel:.8},choices:[{id:"negotiate",label:"Negotiate with Workers",emoji:"ðŸ¤",description:"Meet with union leaders. Accept major wage increases and worker protections. End the strike through concessions.",tradeoff:"Strike ends quickly. Wages rise significantly. Businesses face higher costs. May trigger inflation.",historicalNote:"UK 1926 General Strike ended after 9 days. Government conceded little. Workers returned defeated. France 1968 â€” de Gaulle negotiated wage increases of 35%.",effectOverride:{productionMultiplier:.9,businessCapitalDrain:.005,unrestLevel:.2,duration:80},policyOverrides:{minWage:18}},{id:"crack_down",label:"Call In the Military",emoji:"ðŸª–",description:"Declare the strike illegal. Deploy security forces to reopen businesses. Arrest strike leaders.",tradeoff:"Strike ends by force. Short-term production resumes. Generates massive unrest. Long-term labor relations destroyed.",historicalNote:"Tsar Nicholas II cracked down on 1905 strikes. Workers returned, resentment grew, revolution followed 12 years later.",effectOverride:{productionMultiplier:.7,businessCapitalDrain:.01,unrestLevel:.95,duration:100},followUpEvents:[{type:"revolution",delay:200}]},{id:"meet_demands",label:"Meet All Demands",emoji:"ðŸ“‹",description:"Full capitulation. Massive wage increases, worker ownership rights, reduced hours. Businesses will struggle to absorb the costs.",tradeoff:"Strike ends immediately. Workers are ecstatic. Many businesses go bankrupt within months.",historicalNote:"Bolivia's 1952 revolution saw workers seize mines. Production collapsed 40% initially before new management stabilized.",effectOverride:{productionMultiplier:.95,businessCapitalDrain:.02,unrestLevel:.05,duration:50},policyOverrides:{minWage:25,mandatoryProfitShare:.2}}]},[y.BANK_RUN]:{name:"Bank Run",description:"Citizens are lining up to withdraw everything from the banks. The financial system has 48 hours before it collapses completely. Businesses cannot make payroll. What do you do?",duration:200,icon:"ðŸ¦",hint:"Immediately raise the Reserve Requirement to stop reckless lending. Enable Deposit Insurance to restore confidence. Increase Financial Oversight to prevent future crises. After the run subsides, lower Interest Rate to help businesses recover.",effects:{wealthDestructionRate:.04,businessCapitalCrash:.5,hiringSuppression:!0},choices:[{id:"deposit_guarantee",label:"Guarantee All Deposits",emoji:"ðŸ›¡ï¸",description:"Government guarantees every citizen's deposits are safe. Panic stops immediately. Costs are enormous.",tradeoff:"Stops the run instantly. Restores confidence. Massive contingent liability on the government.",historicalNote:"FDR's FDIC (1933) deposit guarantee ended the Great Depression bank runs overnight. Still the gold standard.",effectOverride:{wealthDestructionRate:.002,businessCapitalCrash:.9,hiringSuppression:!1,duration:50},govDebtPenalty:3e3},{id:"bank_holiday",label:"Declare a Bank Holiday",emoji:"ðŸšª",description:"Close all banks for a week. Force a pause. Use the time to audit, restructure, or recapitalize.",tradeoff:"Buys time but deepens the panic. Economic activity freezes completely during the holiday.",historicalNote:"FDR declared a bank holiday in March 1933. When banks reopened 4 days later, the runs had stopped â€” but the pause was painful.",effectOverride:{wealthDestructionRate:.01,businessCapitalCrash:.3,hiringSuppression:!0,duration:150},govDebtPenalty:1e3},{id:"let_banks_fail",label:"Let Them Fail",emoji:"ðŸ’€",description:"No bailouts. Insolvent banks deserve to collapse. Creative destruction will rebuild stronger institutions.",tradeoff:"Short-term economic catastrophe. Possibly long-term healthy reset. Historically devastating.",historicalNote:'Hoover let 4,000 US banks fail 1930-33. GDP fell 30%. Unemployment hit 25%. "Creative destruction" was not creative.',effectOverride:{wealthDestructionRate:.06,businessCapitalCrash:.15,hiringSuppression:!0,duration:350},followUpEvents:[{type:"recession",delay:50},{type:"crimeWave",delay:150}]}]},[y.REVOLUTION]:{name:"ðŸ—¡ï¸ Revolution!",description:"THE PEOPLE HAVE HAD ENOUGH. Years of extreme inequality, poverty, and suffering have exploded into open revolt. The guillotine is being assembled in the town square. The wealthy are fleeing. The mob controls the streets. What do you do â€” if you even still have the power to do anything?",duration:400,icon:"âš”ï¸",hint:"This is an endgame event. To prevent future revolutions: reduce inequality with Wealth Tax and UBI, raise Min Wage, and fund Education. If you concede, rebuild with high Income Tax and social spending. The economy needs complete restructuring after this.",effects:{unrestLevel:1,productionMultiplier:.2,wealthSeizureRate:.05,executionProbability:.002,businessCapitalDrain:.04},choices:[{id:"concede_everything",label:"Concede Everything",emoji:"ðŸ³ï¸",description:"Accept the revolution. Abolish class privileges. Redistribute all wealth. Let the people's government take over.",tradeoff:"Unrest collapses. Radical equality â€” Gini drops to near zero. But all businesses are seized and production falls as the new system is built from scratch.",historicalNote:"France 1789: The Third Estate won. Feudalism ended overnight. But the following decade brought the Reign of Terror, economic chaos, and Napoleon.",effectOverride:{unrestLevel:.05,productionMultiplier:.4,wealthSeizureRate:0,executionProbability:0,businessCapitalDrain:.01,duration:300},policyOverrides:{incomeTax:.8,wealthConfiscation:.5,minWage:20,ubi:300},followUpEvents:[{type:"brainDrain",delay:80}]},{id:"flee",label:"The Aristocracy Flees",emoji:"ðŸƒ",description:"The ruling class escapes with whatever they can carry. Power vacuum. Nobody is in charge. The economy is left to reorganize itself.",tradeoff:"Mass wealth emigration. Short burst of looting. Long period of rebuilding with more equal starting conditions.",historicalNote:"Russian aristocracy fled 1917. Cuban bourgeoisie fled to Miami 1959. Both created power vacuums that new authoritarian regimes filled.",effectOverride:{unrestLevel:.3,productionMultiplier:.35,wealthSeizureRate:0,executionProbability:.001,businessCapitalDrain:.02,duration:250}},{id:"violent_suppression",label:"Violent Suppression",emoji:"ðŸ’€",description:'Deploy the army. Shoot the protesters. Behead the ringleaders. Restore "order" through maximum force.',tradeoff:"Short-term order restored. Underlying conditions unchanged. Revolution deferred, not defeated â€” it will return, worse.",historicalNote:"Tsar Nicholas II suppressed the 1905 revolution. 12 years later, the Romanovs were all executed in a basement.",effectOverride:{unrestLevel:.85,productionMultiplier:.5,wealthSeizureRate:.01,executionProbability:.005,businessCapitalDrain:.03,duration:500}}]},[y.BRAIN_DRAIN]:{name:"Brain Drain",description:"Your most skilled workers are leaving. High taxes, low opportunity, political instability â€” whatever the reason, talent is exiting fast. Businesses are struggling to fill key roles.",duration:250,icon:"ðŸ§ ",hint:"Talent leaves when taxes are too high and opportunities are low. Lower the Wealth Tax and Income Tax to reduce the push factor. Boost Education Funding to grow new talent domestically. If you open borders, new skilled immigrants can replace those who left.",effects:{skillErosionRate:.002,highSkillExitProbability:.01,productivityDecay:.998},choices:[{id:"talent_incentives",label:"Talent Retention Package",emoji:"ðŸ’°",description:"Tax breaks and bonuses for high-skill workers. Make staying worth their while.",tradeoff:"Slows emigration. Costs revenue. Creates a two-tier tax system that others resent.",historicalNote:"Ireland's special artist tax exemption attracted many creatives. Singapore's talent visa system draws global elites.",effectOverride:{skillErosionRate:3e-4,highSkillExitProbability:.001,productivityDecay:.9995,duration:150},govDebtPenalty:600},{id:"open_immigration",label:"Open Skilled Immigration",emoji:"ðŸŒ",description:"Replace departing talent with immigrants. Fast-track visas for skilled workers globally.",tradeoff:"Partially offsets the drain. Different skills may not perfectly match. Cultural adjustment takes time.",historicalNote:"Canada's points-based immigration system and the US H-1B visa program replace brain drain with brain gain.",effectOverride:{skillErosionRate:.001,highSkillExitProbability:.005,productivityDecay:.999,duration:200},policyOverrides:{openBorders:!0}},{id:"ignore_it",label:"Let Them Leave",emoji:"ðŸ‘‹",description:"Good riddance to elites. The working class will step up. Skills can be rebuilt from within.",tradeoff:"No cost. Significant long-term productivity collapse as expertise exits permanently.",historicalNote:"Zimbabwe's post-2000 land reform drove out skilled farmers and professionals. GDP fell 50%. 3 million skilled workers fled.",effectOverride:{skillErosionRate:.004,highSkillExitProbability:.02,productivityDecay:.993,duration:400},followUpEvents:[{type:"recession",delay:100}]}]},[y.CRIME_WAVE]:{name:"Crime Wave",description:"Poverty and desperation have triggered a surge in crime. Theft, robbery, and assault are skyrocketing. Businesses are closing early. Citizens are afraid. How do you respond?",duration:250,icon:"ðŸš¨",hint:"Crime stems from poverty and desperation. Raise Police Funding for a quick fix, but also address root causes: increase UBI, raise Min Wage, and boost Education Funding. Long-term, reducing inequality with Wealth Tax prevents the next crime wave.",effects:{crimeMultiplier:2,businessCapitalDrain:.01,happinessPenalty:.1},choices:[{id:"police_crackdown",label:"Police Crackdown",emoji:"ðŸš”",description:"Double police funding. Aggressive enforcement. Zero tolerance. Fill the prisons.",tradeoff:"Crime drops fast. Prisons overflow. Government costs soar. Civil liberties suffer.",historicalNote:`NYC's "broken windows" policing (1990s) reduced crime but led to mass incarceration and racial profiling. The cure had its own disease.`,effectOverride:{crimeMultiplier:.5,businessCapitalDrain:.003,happinessPenalty:.05,duration:150},policyOverrides:{policeFunding:.9},govDebtPenalty:800},{id:"community_programs",label:"Community Programs",emoji:"ðŸ˜ï¸",description:"Invest in education, job training, mental health, and community centers. Address root causes.",tradeoff:"Slow to take effect but lasting results. Expensive. Crime continues during the transition period.",historicalNote:"Cure Violence programs in Chicago reduced shootings 40-70% by treating violence as a public health issue, not just a law enforcement one.",effectOverride:{crimeMultiplier:1.2,businessCapitalDrain:.008,happinessPenalty:.03,duration:350},policyOverrides:{educationFunding:.8,prisonReform:!0},govDebtPenalty:1200},{id:"martial_law",label:"Martial Law",emoji:"ðŸª–",description:"Deploy the military. Impose curfews. Suspend civil rights. Restore order by force.",tradeoff:"Immediate crime suppression. Massive unrest backlash. Economy freezes under curfew.",historicalNote:'Martial law has been declared in countless countries. It always "works" short-term. The aftermath is rarely worth it.',effectOverride:{crimeMultiplier:.2,businessCapitalDrain:.02,happinessPenalty:.2,duration:100},govDebtPenalty:500}]},[y.VOTE_OF_NO_CONFIDENCE]:{name:"Vote of No Confidence",description:"Your approval rating has collapsed below 20%. The legislature is calling for your removal. The streets are restless. Your mandate is gone. How do you respond?",duration:100,icon:"ðŸ—³ï¸",hint:"Your approval crashed because people are suffering. Quick wins: raise UBI, lower Income Tax, or enable Public Healthcare to win back popular support. Longer term, reduce inequality and unemployment. If you resign, the next government starts fresh at 40% approval.",effects:{unrestLevel:.6,productionMultiplier:.85},choices:[{id:"resign_gracefully",label:"Resign Gracefully",emoji:"ðŸ•Šï¸",description:"Accept the vote. Call new elections. Step down with dignity and let a new government form.",tradeoff:"Approval resets to 40. Mild economic disruption during transition. Democracy survives.",historicalNote:"Thatcher resigned in 1990 after losing party confidence. Orderly transition. The economy barely noticed.",effectOverride:{unrestLevel:.2,productionMultiplier:.9,duration:60}},{id:"emergency_reforms",label:"Emergency Reforms",emoji:"ðŸ“œ",description:"Slash taxes, boost UBI, and announce sweeping popular reforms. Buy back the public's trust with their own money.",tradeoff:"Expensive but may save your government. Budget takes a massive hit.",historicalNote:"Macron repealed the fuel tax after the Yellow Vest protests. Sometimes retreat is the only viable advance.",effectOverride:{unrestLevel:.3,productionMultiplier:.95,duration:80},govDebtPenalty:2e3,policyOverrides:{incomeTax:.15,ubi:200}},{id:"cling_to_power",label:"Cling to Power",emoji:"ðŸ‘Š",description:"Reject the vote. Declare emergency powers. Suppress dissent. The economy be damned â€” you're not leaving.",tradeoff:"Unrest spikes massively. Production collapses. May cascade into revolution.",historicalNote:"Maduro rejected his no-confidence vote in 2017. Venezuela's economy collapsed 65%. 7 million fled the country.",effectOverride:{unrestLevel:.95,productionMultiplier:.5,duration:300},followUpEvents:[{type:"revolution",delay:150},{type:"brainDrain",delay:80}]}]}};function _e(){return{activeEvents:[],eventHistory:[],lastEventTick:0,scheduledFollowUps:[]}}function X(i,e,t,s,a=null){i.activeEvents=i.activeEvents.filter(o=>o.definition.duration===0?!0:s-o.startTick<o.definition.duration);const r=i.scheduledFollowUps.filter(o=>o.atTick<=s);i.scheduledFollowUps=i.scheduledFollowUps.filter(o=>o.atTick>s);for(const o of r){const n=Te(i,e,t,s,o.type);if(n!=null&&n.requiresChoice)return n}let l=null;if(a==="_random")l=Ce(i,e,t,s);else if(a)l=Te(i,e,t,s,a);else{const o=at*(1-i.activeEvents.length*.3);Math.random()<o&&s>i.lastEventTick+100&&(l=Ce(i,e,t,s))}if(l!=null&&l.requiresChoice)return l;for(const o of i.activeEvents)Tt(o,e,t,s);return l}function _t(i,e,t,s){var l;const a=i.pendingChoiceEvent;if(!a||a.id!==e)return;const r=(l=a.definition.choices)==null?void 0:l.find(o=>o.id===t);if(r){if(r.effectOverride&&(Object.assign(a.definition.effects,r.effectOverride),r.effectOverride.duration!==void 0&&(a.definition.duration=r.effectOverride.duration)),r.policyOverrides&&Object.assign(s.policies,r.policyOverrides),r.govDebtPenalty&&s.metrics&&(s.metrics.govDebt=(s.metrics.govDebt||0)+r.govDebtPenalty),a.choiceMade=t,a.requiresChoice=!1,r.followUpEvents)for(const o of r.followUpEvents)i.scheduledFollowUps.push({type:o.type,atTick:a.startTick+(o.delay||100)});Ge(a,s),i.activeEvents.push(a),i.pendingChoiceEvent=null}}function Te(i,e,t,s,a){const r=Fe[a];return r?Le(i,e,s,a,r):null}function Ce(i,e,t,s){const a=e.metrics||{},r={[y.PANDEMIC]:1,[y.CROP_FAILURE]:1,[y.TECH_BREAKTHROUGH]:1.5,[y.FINANCIAL_BUBBLE]:a.gini>.5?2:.5,[y.CORRUPTION]:a.govDebt>1e3?2:.5,[y.IMMIGRATION_WAVE]:t.openBorders?3:.5,[y.RECESSION]:a.inflation>5?2:.3,[y.BOOM]:a.unemployment<.05?2:.5,[y.HYPERINFLATION]:t.printMoney>20||a.inflation>10?3:.3,[y.GENERAL_STRIKE]:a.gini>.55?2:a.unemployment>.15?1.5:.3,[y.BANK_RUN]:a.govDebt>3e3||a.inflation>8?2:.3,[y.BRAIN_DRAIN]:t.wealthConfiscation>.1||t.maximumWage>0?2:.4,[y.CRIME_WAVE]:(a.crimeRate||0)>.3?3:a.povertyRate>.3&&a.unemployment>.15?1.5:.2,[y.REVOLUTION]:a.gini>.65&&(a.socialUnrest||0)>.65?4:a.gini>.6&&(a.socialUnrest||0)>.55?1.5:.05},l=Object.keys(r),o=l.map(d=>r[d]),n=o.reduce((d,p)=>d+p,0);let c=Math.random()*n,h=l[0];for(let d=0;d<l.length;d++)if(c-=o[d],c<=0){h=l[d];break}return Le(i,e,s,h,Fe[h])}function Le(i,e,t,s,a){var l;const r={id:`${s}_${t}`,type:s,definition:{...a,effects:{...a.effects}},startTick:t,name:a.name,description:a.description,icon:a.icon};return i.lastEventTick=t,i.eventHistory.push({id:r.id,name:a.name,icon:a.icon,tick:t}),((l=a.choices)==null?void 0:l.length)>0?(r.requiresChoice=!0,i.pendingChoiceEvent=r,r):(i.activeEvents.push(r),Ge(r,e),r)}function Ge(i,e){const{effects:t}=i.definition,s=e.agents.filter(r=>r.alive),a=e.businesses.filter(r=>r.alive);switch(i.type){case y.PANDEMIC:for(const r of s)r.health*=.8+Math.random()*.2,r.health=g(r.health,.1,1);break;case y.IMMIGRATION_WAVE:i._spawnAgents=t.newAgentCount,i._spawnSkillBonus=t.newAgentSkillBonus;break;case y.FINANCIAL_BUBBLE:i.phase="inflate",i.phaseStartTick=i.startTick;break;case y.TECH_BREAKTHROUGH:for(const r of a.filter(l=>l.sector==="tech"))r.productivity*=t.techProductivityMultiplier;break;case y.BANK_RUN:for(const r of a)r.capital*=t.businessCapitalCrash;for(const r of s)r.wealth*=1-t.wealthDestructionRate*5,r.wealth=Math.max(0,r.wealth);break;case y.GENERAL_STRIKE:for(const r of a)r.production=(r.production||1)*.15;break;case y.BRAIN_DRAIN:{const r=s.filter(o=>o.skill>.75).sort((o,n)=>n.skill-o.skill),l=Math.floor(r.length*.15);for(const o of r.slice(0,l))o.alive=!1}break;case y.REVOLUTION:{const r=s.filter(o=>o.wealth>0).sort((o,n)=>n.wealth-o.wealth),l=Math.max(1,Math.floor(r.length*.1));for(const o of r.slice(0,l))o.wealth*=.2;for(const o of a)o.capital*=.4;i._revolutionActive=!0}break}}function Tt(i,e,t,s){var o;const{effects:a}=i.definition,r=s-i.startTick,l=i.definition.duration>0?r/i.definition.duration:0;switch(i.type){case y.PANDEMIC:if(Math.random()<.01)for(const n of e.businesses.filter(c=>c.alive))n.capital-=n.capital*.005;break;case y.FINANCIAL_BUBBLE:if(l<.5){if(Math.random()<.05)for(const n of e.agents.filter(c=>c.alive&&c.wealth>500))n.wealth*=1.01}else if(i.phase==="inflate"){i.phase="crash";for(const n of e.agents.filter(c=>c.alive))n.wealth*=a.wealthCrashPhase+Math.random()*.3}break;case y.RECESSION:if(Math.random()<.1)for(const n of e.businesses.filter(c=>c.alive))n.capital-=n.capital*a.businessCapitalDrain;break;case y.BOOM:if(Math.random()<.05)for(const n of e.businesses.filter(c=>c.alive))n.wageOffered*=a.wageGrowthRate;break;case y.HYPERINFLATION:if((o=e.market)!=null&&o.prices)for(const n of Object.keys(e.market.prices))e.market.prices[n]*=a.priceMultiplierPerTick;if(Math.random()<.1)for(const n of e.agents.filter(c=>c.alive&&c.wealth>0))n.wealth*=1-a.savingsDestructionRate;break;case y.GENERAL_STRIKE:if(Math.random()<.15)for(const n of e.businesses.filter(c=>c.alive))n.capital-=n.capital*a.businessCapitalDrain;break;case y.BANK_RUN:if(Math.random()<.05)for(const n of e.agents.filter(c=>c.alive))n.wealth*=1-a.wealthDestructionRate,n.wealth=Math.max(0,n.wealth);break;case y.BRAIN_DRAIN:if(Math.random()<.02){const n=e.agents.filter(c=>c.alive&&c.skill>.6);for(const c of n)c.skill=g(c.skill-a.skillErosionRate,0,1),Math.random()<a.highSkillExitProbability&&(c.alive=!1)}break;case y.CRIME_WAVE:if(Math.random()<.08)for(const n of e.businesses.filter(c=>c.alive))n.capital-=n.capital*a.businessCapitalDrain;if(Math.random()<.05)for(const n of e.agents.filter(c=>c.alive))n.happiness=g((n.happiness||.5)-a.happinessPenalty*.01,0,1);break;case y.REVOLUTION:{const c=e.agents.filter(h=>h.alive).filter(h=>h.wealth>800).sort((h,d)=>d.wealth-h.wealth);for(const h of c)Math.random()<a.executionProbability?h.alive=!1:Math.random()<a.wealthSeizureRate&&(h.wealth*=.7);if(Math.random()<.05)for(const h of e.businesses.filter(d=>d.alive))h.capital-=h.capital*a.businessCapitalDrain;e._revolutionActive||(e._revolutionActive=!0);break}}}const Ee=[{type:"oil_crisis",label:"Oil Crisis",icon:"ðŸ›¢ï¸",priceMultipliers:{food:1.6,housing:1.3,tech:1.2,luxury:1.1},duration:200},{type:"global_recession",label:"Global Recession",icon:"ðŸ“‰",priceMultipliers:{food:.7,housing:.6,tech:.5,luxury:.5},duration:300},{type:"commodity_supercycle",label:"Commodity Supercycle",icon:"ðŸ“¦",priceMultipliers:{food:1.8,housing:1.5,tech:1.1,luxury:1.2},duration:250},{type:"trade_war",label:"Trade War",icon:"âš”ï¸",priceMultipliers:{food:1.2,housing:1.1,tech:1.4,luxury:1.3},duration:180},{type:"tech_deflation",label:"Tech Deflation",icon:"ðŸ’»",priceMultipliers:{food:1,housing:1,tech:.4,luxury:.8},duration:200}];function Re(){return{worldPrices:{...Y},basePrices:{...Y},fxRate:1,foreignReserves:st,tradeBalance:{food:0,housing:0,tech:0,luxury:0},cumulativeTradeBalance:0,activeShock:null,history:{fxRate:[],foreignReserves:[],tradeBalance:[]}}}function Ct(i,e,t,s){for(const u of B){const w=i.basePrices[u],S=i.worldPrices[u],D=(Math.random()-.5)*2*Qe,E=(w-S)/w*.001;i.worldPrices[u]=Math.max(1,S*(1+D+E))}if(!i.activeShock&&Math.random()<it){const u=Ee[Math.floor(Math.random()*Ee.length)];i.activeShock={...u,ticksRemaining:u.duration}}let a=null;if(i.activeShock){const u=i.activeShock;for(const w of B){const S=u.priceMultipliers[w]||1,D=1-u.ticksRemaining/u.duration,E=1+(S-1)*Math.min(1,D*3);i.worldPrices[w]*=E>1?1+(E-1)*.01:1-(1-E)*.01}u.ticksRemaining--,u.ticksRemaining<=0&&(i.activeShock=null),u.ticksRemaining===u.duration-1&&(a={type:u.type,label:u.label,icon:u.icon,duration:u.duration})}const l=-Object.values(i.tradeBalance).reduce((u,w)=>u+w,0)*1e-5,o=((t.interestRate||.05)-.05)*ot*100,n=(t.printMoney||0)*2e-4,c=(e.inflation||0)*.005,h=(1-i.fxRate)*nt;let d=l-o+n+c+h;if(i.fxRate=g(i.fxRate+d,de,ue),t.foreignReserveIntervention&&i.foreignReserves>50){const u=d*.5;i.fxRate-=u,i.fxRate=g(i.fxRate,de,ue),i.foreignReserves-=Math.abs(u)*500}const p=t.punitiveTargiffs||0,m=t.exportSubsidies||0,v={};let b=0;for(const u of B){const w=e.prices[u]||10,S=i.worldPrices[u]*i.fxRate,D=S*(1+p)*et,E=S*(1+m)*tt;let A=0,H=0;w>D&&D>0&&(A=(w-D)/w*e.supply[u]*.15),w<E&&w>0&&(H=(E-w)/E*e.supply[u]*.1),v[u]={imports:A,exports:H};const U=H*w-A*S;i.tradeBalance[u]=U,b+=U}i.foreignReserves+=b*.01,i.foreignReserves=Math.max(0,i.foreignReserves),i.cumulativeTradeBalance+=b;const C=i.history;return C.fxRate.push(Math.round(i.fxRate*1e3)/1e3),C.foreignReserves.push(Math.round(i.foreignReserves)),C.tradeBalance.push(Math.round(b)),C.fxRate.length>200&&C.fxRate.shift(),C.foreignReserves.length>200&&C.foreignReserves.shift(),C.tradeBalance.length>200&&C.tradeBalance.shift(),{tradeFlows:v,shockEvent:a}}const se={greatDepression:[{id:"restore_employment",label:"Restore Employment",description:"Bring unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:52*2,weight:.4,icon:"ðŸ‘·",tip:"Government work programs, public investment, and lower interest rates historically helped."},{id:"gdp_recovery",label:"GDP Recovery",description:"Grow GDP back to starting level",metric:"gdp",operator:"gt_initial",threshold:1,sustainTicks:0,weight:.4,icon:"ðŸ“ˆ",tip:"Demand-side stimulus: UBI, public spending, and low interest rates can restart growth."},{id:"prevent_deflation",label:"Stop Deflation",description:"Keep CPI above 90 (avoid deflationary spiral)",metric:"cpi",operator:"gt",threshold:90,sustainTicks:52,weight:.2,icon:"ðŸ¦",tip:"Deflation is self-reinforcing â€” people delay spending, worsening the cycle. QE can help."}],weimarHyperinflation:[{id:"tame_inflation",label:"Tame Hyperinflation",description:"Bring inflation below 5% and hold for 3 years",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*3,weight:.5,icon:"ðŸ”¥",tip:"Stop money printing immediately. High interest rates are painful but necessary."},{id:"restore_trust",label:"Restore Public Trust",description:"Reduce social unrest below 30%",metric:"socialUnrest",operator:"lt",threshold:.3,sustainTicks:52,weight:.3,icon:"ðŸ¤",tip:"People need to believe the currency holds value. Actions speak louder than promises."},{id:"employment_stability",label:"Employment Stability",description:"Hold unemployment below 15%",metric:"unemployment",operator:"lt",threshold:.15,sustainTicks:0,weight:.2,icon:"âš–ï¸",tip:"Stabilizing the currency will disrupt employment â€” the question is how much."}],stagflation1970s:[{id:"tame_inflation_s",label:"Control Inflation",description:"Bring inflation below 5%",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*2,weight:.4,icon:"ðŸ”¥",tip:"High interest rates cure inflation â€” but cause a recession. Timing matters."},{id:"limit_unemployment_s",label:"Limit Unemployment",description:"Keep unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:0,weight:.35,icon:"ðŸ‘·",tip:"The classic dilemma: fixing inflation worsens unemployment and vice versa."},{id:"gdp_positive",label:"Avoid Recession",description:"Keep GDP growth positive",metric:"gdpGrowth",operator:"gt",threshold:0,sustainTicks:52,weight:.25,icon:"ðŸ“Š",tip:"Near impossible to avoid entirely â€” the question is how deep the recession goes."}],crisisOf2008:[{id:"prevent_depression",label:"Prevent Depression",description:"Keep unemployment below 12%",metric:"unemployment",operator:"lt",threshold:.12,sustainTicks:0,weight:.35,icon:"ðŸ¦",tip:"Bank bailouts and fiscal stimulus are expensive but prevent cascading failures."},{id:"restore_growth_08",label:"Restore Growth",description:"Return GDP to pre-crisis level within 10 years",metric:"gdp",operator:"gt_initial",threshold:.95,sustainTicks:0,weight:.35,icon:"ðŸ“ˆ",tip:"Austerity prolongs recessions. Targeted stimulus accelerates recovery."},{id:"inequality_check",label:"Prevent Inequality Surge",description:"Keep Gini below 0.55",metric:"gini",operator:"lt",threshold:.55,sustainTicks:0,weight:.3,icon:"âš–ï¸",tip:"Bailouts that save banks but not homeowners cause lasting inequality damage."}],japanLostDecade:[{id:"escape_deflation",label:"Escape Deflation",description:"Keep CPI above 95 for 5 years",metric:"cpi",operator:"gt",threshold:95,sustainTicks:52*5,weight:.4,icon:"ðŸ“‰",tip:"Zero interest rates alone aren't enough. QE, fiscal spending, and structural reform all needed."},{id:"growth_japan",label:"Restart Growth",description:"Achieve positive GDP growth for 3 consecutive years",metric:"gdpGrowth",operator:"gt",threshold:.01,sustainTicks:52*3,weight:.35,icon:"ðŸŒ±",tip:"Japan's half-measures dragged the slump out for 20 years. Bold action earlier helps."},{id:"low_unemployment_jp",label:"Maintain Employment",description:"Keep unemployment below 6%",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:0,weight:.25,icon:"ðŸ’¼",tip:"Japan kept employment through corporate welfare (zombie firms). Productive or not?"}],nordicMiracle:[{id:"equality_nordic",label:"Achieve Equality",description:"Bring Gini below 0.30",metric:"gini",operator:"lt",threshold:.3,sustainTicks:52*3,weight:.35,icon:"âš–ï¸",tip:"Universal services + progressive taxation + strong unions. All three matter."},{id:"prosperity_nordic",label:"Maintain Prosperity",description:"Keep unemployment below 6% AND GDP growing",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:52*2,weight:.35,icon:"ðŸŒŸ",tip:"High taxes don't kill growth if trust, education, and institutions are strong."},{id:"poverty_nordic",label:"Eliminate Poverty",description:"Bring poverty rate below 10%",metric:"povertyRate",operator:"lt",threshold:.1,sustainTicks:52,weight:.3,icon:"ðŸ ",tip:"Universal basic services (healthcare, education, housing support) matter more than cash transfers alone."}]};for(const i of Be)se[i.id]=i.objectives;function Et(i,e,t){const s=e[i.metric];if(s==null)return!1;switch(i.operator){case"lt":return s<i.threshold;case"gt":return s>i.threshold;case"gt_initial":return s>((t==null?void 0:t[i.metric])||0)*i.threshold;default:return!1}}function Rt(i,e,t){const s=e[i.metric];if(s==null)return 0;switch(i.operator){case"lt":return Math.min(1,Math.max(0,1-s/(i.threshold*1.5)));case"gt":return Math.min(1,Math.max(0,s/(i.threshold*1.2)));case"gt_initial":{const a=((t==null?void 0:t[i.metric])||1)*i.threshold;return Math.min(1,Math.max(0,s/(a*1.2)))}default:return 0}}const It=[{id:"full_employment",name:"Full Employment",icon:"ðŸ’¼",description:"Reach unemployment below 3%",category:"economy",check:i=>i.unemployment<.03},{id:"gdp_boom",name:"Economic Boom",icon:"ðŸ“ˆ",description:"Grow GDP above $50,000",category:"economy",check:i=>i.gdp>5e4},{id:"stable_prices",name:"Price Stability",icon:"âš–ï¸",description:"Keep CPI between 95 and 110 for 5 years",category:"economy",sustained:260,check:i=>i.cpi>=95&&i.cpi<=110},{id:"hyperinflation_survivor",name:"Hyperinflation Survivor",icon:"ðŸ”¥",description:"Recover from CPI above 200",category:"economy",check:(i,e)=>e._sawHyperinflation&&i.cpi<120},{id:"equalizer",name:"The Equalizer",icon:"ðŸ¤",description:"Reduce Gini below 0.25",category:"equality",check:i=>i.gini<.25&&i.gini>0},{id:"zero_poverty",name:"No One Left Behind",icon:"ðŸ ",description:"Reach 0% poverty rate",category:"equality",check:i=>i.povertyRate===0&&i.population>20},{id:"billionaire_factory",name:"Billionaire Factory",icon:"ðŸ’Ž",description:"Gini above 0.75 â€” extreme inequality",category:"equality",check:i=>i.gini>.75},{id:"popular_mandate",name:"Popular Mandate",icon:"ðŸ—³ï¸",description:"Reach 90% approval rating",category:"stability",check:(i,e)=>e.approvalRating>90},{id:"zero_crime",name:"Utopian Peace",icon:"ðŸ•Šï¸",description:"Reduce crime rate to 0",category:"stability",check:i=>i.crimeRate===0&&i.population>20},{id:"debt_free",name:"Debt Free Nation",icon:"ðŸ¦",description:"Bring government debt to $0 or surplus",category:"stability",check:i=>i.govDebt<=0},{id:"year_5",name:"Getting Started",icon:"ðŸ“…",description:"Survive 5 years",category:"milestone",check:i=>i.year>=5},{id:"year_20",name:"A Generation",icon:"ðŸ“…",description:"Survive 20 years",category:"milestone",check:i=>i.year>=20},{id:"year_50",name:"Half Century",icon:"ðŸ›ï¸",description:"Survive 50 years",category:"milestone",check:i=>i.year>=50},{id:"population_300",name:"Growing Nation",icon:"ðŸ‘¥",description:"Population reaches 300",category:"milestone",check:i=>i.population>=300},{id:"recession_recovery",name:"Phoenix Economy",icon:"ðŸ”„",description:"Recover GDP after it drops below 50%",category:"chaos",check:(i,e)=>e._sawGdpCrash&&i.gdp>e._peakGdp*.9},{id:"population_collapse",name:"Ghost Nation",icon:"ðŸ’€",description:"Population drops below 20",category:"chaos",check:i=>i.population<20&&i.population>0},{id:"print_everything",name:"Money Printer Go Brrrr",icon:"ðŸ–¨ï¸",description:"Set money printing to maximum",category:"chaos",check:(i,e)=>{var t;return((t=e.policies)==null?void 0:t.printMoney)>=45}},{id:"confiscate_all",name:"Seize the Means",icon:"âš’ï¸",description:"Enable wealth confiscation + nationalize industries",category:"chaos",check:(i,e)=>{var t,s;return((t=e.policies)==null?void 0:t.wealthConfiscation)>.3&&((s=e.policies)==null?void 0:s.nationalizeIndustries)}}];function St(i,e){let t=0;const s=i.unemployment||0;s<.03?t+=20:s<.05?t+=16:s<.1?t+=10:s<.2&&(t+=4);const a=i.gdpGrowth||0;a>.05?t+=15:a>.02?t+=12:a>0?t+=8:a>-.02&&(t+=3);const r=i.inflation||0,l=Math.abs(r-.02);l<.01?t+=15:l<.03?t+=12:l<.05?t+=8:l<.1&&(t+=3);const o=i.gini||.5;o<.25?t+=15:o<.35?t+=12:o<.45?t+=8:o<.55&&(t+=4);const n=i.povertyRate||0;n===0?t+=10:n<.05?t+=8:n<.15?t+=5:n<.25&&(t+=2);const c=i.crimeRate||0;c===0?t+=10:c<.1?t+=8:c<.3?t+=5:c<.5&&(t+=2);const h=e||50;return h>80?t+=15:h>60?t+=12:h>40?t+=8:h>20&&(t+=4),Math.min(100,Math.max(0,t))}const L=[{id:"m1",name:"First Year",desc:"Survive your first year",check:i=>i.year>=1},{id:"m2",name:"Stable Start",desc:"Keep unemployment below 15%",check:i=>i.unemployment<.15&&i.year>=2},{id:"m3",name:"Growing Economy",desc:"GDP exceeds $10,000",check:i=>i.gdp>1e4},{id:"m4",name:"Tax Collector",desc:"Earn $500 in tax revenue",check:i=>i.totalTaxRevenue>500},{id:"m5",name:"Low Crime",desc:"Crime rate below 0.1",check:i=>i.crimeRate<.1&&i.year>=3},{id:"m6",name:"Decade Leader",desc:"Reach year 10 with approval > 50%",check:(i,e)=>i.year>=10&&e.approvalRating>50},{id:"m7",name:"Inequality Fighter",desc:"Gini coefficient below 0.35",check:i=>i.gini<.35&&i.gini>0},{id:"m8",name:"Budget Surplus",desc:"Government debt below $0",check:i=>i.govDebt<=0},{id:"m9",name:"Golden Age",desc:"Score above 80 for 3 years",sustained:156,check:(i,e)=>e._score>=80},{id:"m10",name:"Economic Mastery",desc:"Reach year 50 with score above 70",check:(i,e)=>i.year>=50&&e._score>=70}];class xt{constructor(e={}){if(this.tick=0,this.running=!1,this.speed=1,this.scenario=e,this.policies=we(e.policies||{}),this.market=be(),e.startMarket){const{prices:t,...s}=e.startMarket;Object.assign(this.market,s),t&&Object.assign(this.market.prices,{...t})}if(this.metrics=ke(),e.startMetrics&&Object.assign(this.metrics,e.startMetrics),this.eventsState=_e(),this.agents=fe(e.agentCount||200,e),this.businesses=ge(e.businessCount||re,this.agents,e),this.banks=ye(3),ve(this.agents,this.banks),this._crimeLog=[],this.globalEconomy=Re(),this.objectives=se[e.id]||[],this.objectiveProgress=this.objectives.map(t=>({...t,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scenarioFailed=!1,this._zeroGdpStreak=0,this.scheduledEvents=e.scheduledEvents||[],e.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,e.scheduledEvent]),this.isStoryMode=!!e.isStory,this.isTutorialMode=!!e.isTutorial,this._pendingMessages=[],this.policyLag={},this.approvalRating=50,this.approvalHistory=[],this._prevMetricsForApproval=null,this._econFeed=[],this._score=0,this._scoreHistory=[],this._unlockedAchievements=new Set,this._newAchievements=[],this._completedMilestones=new Set,this._milestoneProgress=0,this._sustainedCounters={},this._peakGdp=0,this._sawHyperinflation=!1,this._sawGdpCrash=!1,this._warmup(),e.warmupTicks>0){for(let t=0;t<e.warmupTicks;t++)this.step();if(this.tick=0,e.startMetrics&&Object.assign(this.metrics,e.startMetrics),e.startMarket&&(e.startMarket.prices&&Object.assign(this.market.prices,{...e.startMarket.prices}),e.startMarket.cpi!==void 0&&(this.market.cpi=e.startMarket.cpi),e.startMarket.avgExpectedInflation!==void 0)){this.market.avgExpectedInflation=e.startMarket.avgExpectedInflation;for(const t of this.agents)t.alive&&(t.inflationExpectation=e.startMarket.avgExpectedInflation)}}}_warmup(){const e=this.agents.filter(o=>o.alive&&!o.employed&&!o.isOwner),t=this.businesses.filter(o=>o.alive),s=t.reduce((o,n)=>o+(n.maxEmployees-n.employees.length),0),a=Math.floor(s*.8);let r=0;for(const o of t){const n=o.maxEmployees-o.employees.length;for(let c=0;c<n&&e.length>0&&r<a;c++){const h=Math.floor(Math.random()*e.length),d=e[h];e.splice(h,1),d.employed=!0,d.employerId=o.id,d.jobSector=o.sector;const p=8+d.skill*12;d.wage=Math.max(this.policies.minWage||0,p),d.unemployedTicks=0,o.employees.push(d.id),r++}}for(const o of this.agents)o.alive&&(o.wealth>1500?o.socialClass="rich":o.wealth>300?o.socialClass="middle":o.socialClass="poor",o.creditScore=g(400+Math.floor(o.wealth/10)+Math.floor(o.skill*100),300,850),o.employed&&o.wage>0&&(o.income=o.wage,o.deposits=o.wage*(5+Math.random()*10)));for(const o of t){const n=o.employees.length;o.production=n*o.productivity*2,o.inventory=o.production*3,o.revenue=o.production*(o.price||5),o.profit=o.revenue*.15,o.profitHistory=Array(5).fill(o.profit*(.8+Math.random()*.4))}for(const o of["food","housing","tech","luxury"]){const n=t.filter(c=>c.sector===o);this.market.supply[o]=n.reduce((c,h)=>c+h.production,0),this.market.demand[o]=this.agents.filter(c=>c.alive).length*2}const l=this._buildState();Me(this.metrics,l,this.market,this.policies)}applyMessage(e){switch(e.type){case"SET_POLICY":{const t=lt[e.policy];if(t&&typeof e.value=="number"){const s=this.policies[e.policy];s!==e.value&&(this.policyLag[e.policy]={start:s,target:e.value,lagTicks:t,elapsed:0})}else this.policies[e.policy]=e.value;break}case"SET_SPEED":this.speed=e.speed;break;case"RESET":this._reset(e.scenario);break;case"PAUSE":this.running=!1;break;case"RESUME":this.running=!0;break;case"RESOLVE_CHOICE":_t(this.eventsState,e.eventId,e.choiceId,this._buildState());break;case"FORCE_SHOCK":this._pendingForceShock=!0;break}}_reset(e){const t=De(e)||{};this.scenario=t,this.tick=0,this.policies=we(t.policies||{}),this.market=be(),this.metrics=ke(),t.startMetrics&&Object.assign(this.metrics,t.startMetrics),this.eventsState=_e(),this.agents=fe(t.agentCount||200,t),this.businesses=ge(t.businessCount||re,this.agents,t),this.banks=ye(3),ve(this.agents,this.banks),this._crimeLog=[],this.globalEconomy=Re(),this.objectives=se[t.id]||[],this.objectiveProgress=this.objectives.map(s=>({...s,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scenarioFailed=!1,this._zeroGdpStreak=0,this.scheduledEvents=t.scheduledEvents||[],t.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,t.scheduledEvent]),this.isStoryMode=!!t.isStory,this.isTutorialMode=!!t.isTutorial,this._firedInsights=null,this._lastInsightTick=null,this.policyLag={},this.approvalRating=50,this.approvalHistory=[],this._prevMetricsForApproval=null,this._noConfidenceTriggered=!1,this._econFeed=[],this._prevEconMetrics={}}step(){this.tick++;const e=this._buildState();for(const p of this.agents)p.alive&&p.tick(e,this.policies);const t=this.policies.wealthTax||0;if(t>0){const p=t/52;for(const m of this.agents)m.alive&&m.wealth>J&&(m.wealth-=(m.wealth-J)*p)}for(const p of this.businesses)p.alive&&p.tick(e,this.policies);for(const p of this.banks)p.alive&&p.tick(e,this.policies);this.tick%5===0&&vt(e,this.policies),this._advancePolicyLag();const{tradeFlows:s,shockEvent:a}=Ct(this.globalEconomy,this.market,this.policies,this.metrics);if(a){const p=`global_${a.type}`;this._emitEconEvent(a.icon,`${a.label} â€” world markets disrupted`,"danger"),this._pendingMessages.push({type:"globalShock",...a,narrationKey:p})}if(pt(this.market,e,this.policies,s),!this.policies.antiMonopoly)for(const p of["food","housing","tech","luxury"]){const m=this.businesses.filter(b=>b.alive&&b.sector===p),v=m.find(b=>b.dominance>.5);if(v){for(const b of this.agents)b.alive&&(b.unrest=g((b.unrest||0)+.003,0,1));if(p==="food"&&(this.market.prices.food*=1.001),p==="housing")for(const b of this.agents)b.alive&&!b.hasMortgage&&(b.wealth-=b.expenses*.002);if(v.dominance>.7)for(const b of m)b.id!==v.id&&(b.capital-=b.capital*.02)}}wt(e,this.policies,this.market),e._jubileeApplied&&(this.policies.debtJubilee=!1,delete e._jubileeApplied);let r=null;for(const p of this.scheduledEvents)if(this.tick===p.atTick){const m=X(this.eventsState,e,this.policies,this.tick,p.type);m&&(r=m)}let l=null;this._pendingForceShock&&(this._pendingForceShock=!1,l="_random");const o=this.isStoryMode||this.isTutorialMode,n=r||(l?X(this.eventsState,e,this.policies,this.tick,l):o?null:X(this.eventsState,e,this.policies,this.tick));n&&n._spawnAgents&&this._spawnImmigrants(n._spawnAgents,n._spawnSkillBonus),this.tick%52===0&&this._processBirths(),this._cleanup(),this._processNewBusinesses(e),this.tick%j===0&&(Me(this.metrics,e,this.market,this.policies),this.initialMetrics||(this.initialMetrics={...q(this.metrics)}),this._updateApprovalRating(),this._updateObjectives(),this._updateGamification()),this.tick%j===0&&this._detectEconEvents();const c=this._checkInsights();let h=null;!this.isTutorialMode&&!this.scenarioFailed&&!this.scenarioComplete&&(h=this._checkFailure());let d=null;return!this.isTutorialMode&&!this.scenarioComplete&&!this.scenarioFailed&&this.scenario.durationYears&&Math.floor(this.tick/52)>=this.scenario.durationYears&&(this.scenarioComplete=!0,d=this._buildReport()),{shouldUpdate:this.tick%3===0,event:n,insight:c,scenarioComplete:d,scenarioFailed:h}}_buildState(){return{agents:this.agents,businesses:this.businesses,banks:this.banks,policies:this.policies,market:this.market,metrics:this.metrics,globalEconomy:this.globalEconomy,prices:this.market.prices,_crimeLog:this._crimeLog}}_updateObjectives(){const e=q(this.metrics);for(const t of this.objectiveProgress){const s=Et(t,e,this.initialMetrics);if(t.met=s,t.progress=Rt(t,e,this.initialMetrics),s){t.sustainCount=(t.sustainCount||0)+j;const a=t.sustainTicks||0;t.sustainProgress=a>0?Math.min(1,t.sustainCount/a):1,t.sustainCount>=a&&!t.completed&&(t.completed=!0)}else t.sustainCount=0,t.sustainProgress=0}}_buildObjectivesSnapshot(){return this.objectiveProgress.map(e=>({id:e.id,label:e.label,description:e.description,icon:e.icon,tip:e.tip,met:e.met,completed:e.completed,progress:e.progress,sustainProgress:e.sustainProgress,weight:e.weight}))}_buildReport(){const e=q(this.metrics),t=this._buildObjectivesSnapshot(),s=t.reduce((p,m)=>p+(m.weight||0),0)||1,a=t.reduce((p,m)=>{const v=m.completed?100:m.met?50:Math.round(m.progress*40);return p+v*(m.weight||0)},0)/s;let r=Math.round(a),l=null;const o=this.scenario.isHistorical&&this.scenario.historicalOutcome&&this.initialMetrics?(e.gdp-this.initialMetrics.gdp)/(this.initialMetrics.gdp||1)>(this.scenario.historicalOutcome.gdpChange||-1):!1;this.scenario.isHistorical&&(o&&r<70?(r=Math.max(r,65),l="You outperformed history â€” but the era was brutal. Grade adjusted.",r=Math.min(100,r+10)):o&&r>=70?l="Exceptional â€” you rewrote history.":this.scenario.historicalOutcome&&(l="History proved hard to beat."));const n=r>=90?"A+":r>=80?"A":r>=70?"B":r>=60?"C":r>=45?"D":"F",c=Math.round(Math.max(0,(1-this.metrics.gini/.7)*100)),h=Math.round(Math.min(100,Math.max(0,(e.gdpGrowth+.02)*2e3))),d=Math.round(Math.max(0,100-Math.abs(e.inflation)*5-e.socialUnrest*100));return{scenarioId:this.scenario.id,scenarioName:this.scenario.name,finalScore:r,grade:n,verdict:l,beatHistory:o,domains:{equality:{score:c,label:"Equality"},growth:{score:h,label:"Growth"},stability:{score:d,label:"Stability"}},objectives:t,playerOutcome:{gdpChangePercent:this.initialMetrics?Math.round((e.gdp-this.initialMetrics.gdp)/(this.initialMetrics.gdp||1)*100):0,peakUnemployment:Math.round(e.unemployment*100),inflationAvg:Math.round(e.inflation*10)/10,gini:Math.round(e.gini*100)/100,povertyRate:Math.round(e.povertyRate*100)},finalPolicies:{...this.policies},year:Math.floor(this.tick/52)}}_checkFailure(){return this.agents.filter(t=>t.alive).length===0?(this.scenarioFailed=!0,{reason:"extinction",message:"Everyone is dead. Your civilization has ended.",report:this._buildReport()}):this.tick%j===0&&(this.metrics.gdp===0?this._zeroGdpStreak++:this._zeroGdpStreak=0,this._zeroGdpStreak>=5)?(this.scenarioFailed=!0,{reason:"economic_collapse",message:"GDP has been zero for an extended period â€” the economy has flatlined.",report:this._buildReport()}):null}_processBirths(){const e=this.agents.filter(t=>t.alive&&t.age>1040&&t.age<2340);for(const t of e)if(Math.random()<.02){const a=new ie({x:t.x+(Math.random()-.5)*20,y:t.y+(Math.random()-.5)*20,age:0,skill:g(_(t.skill,.15),.1,1),education:0,wealth:10,parentWealth:t.wealth,bornInYear:Math.floor(this.tick/52)});this.agents.push(a)}}_spawnImmigrants(e,t){for(let s=0;s<e;s++){const a=new ie({skill:g(_(.6+t,.15),.3,1),education:g(_(.6,.2),.2,1),wealth:g(_(300,100),50,800),bornInYear:Math.floor(this.tick/52)});this.agents.push(a)}}_processNewBusinesses(e){const t=this.agents.filter(s=>s._wantsToStartBusiness);for(const s of t){const a=s._needsBusinessLoan;if(delete s._wantsToStartBusiness,delete s._needsBusinessLoan,this.businesses.filter(c=>c.alive).length>=80)continue;let r;if(a){const h=this.banks.find(d=>d.alive&&d.canIssueLoan(s,"business",300,this.policies).approved);if(!h)continue;h.issueLoan(s,"business",300,this.policies),r=300,s.events.push(`Took business loan ($300) at age ${Math.floor(s.age/52)}`)}else{if(s.wealth<300)continue;r=s.wealth*.5,s.wealth-=r}const{SECTORS:l}={SECTORS:["food","housing","tech","luxury"]},o=l[Math.floor(Math.random()*l.length)],n=new Ae({sector:o,capital:r,ownerId:s.id,productivity:g(_(s.skill,.2),.3,2)});s.isOwner=!0,s.businessId=n.id,s.employed=!0,s.employerId=n.id,s.wage=20,s.jobSector=o,n.employees.push(s.id),this.businesses.push(n),s.events.push(`Started ${n.name} at age ${Math.floor(s.age/52)}`)}}_cleanup(){if(this.agents=this.agents.filter(e=>e.alive),this.businesses=this.businesses.filter(e=>e.alive),this.banks=this.banks.filter(e=>e.alive),this.banks.length===0){const e=new He({reserves:5e3});this.banks.push(e);for(const t of this.agents)t.alive&&!t._bankId&&(t._bankId=e.id)}}_emitEconEvent(e,t,s="info"){this._econFeed.push({icon:e,text:t,severity:s,tick:this.tick}),this._econFeed.length>20&&this._econFeed.shift()}_detectEconEvents(){var l,o;const e=this.metrics,t=this._prevEconMetrics||{};this.market.deflationDrag>.05&&this._emitEconEvent("ðŸ“‰",`Debt-deflation drag at ${(this.market.deflationDrag*100).toFixed(0)}%`,"danger"),t.totalMarketCap>0&&e.totalMarketCap<t.totalMarketCap*.85&&this._emitEconEvent("ðŸ”»","Panic selling â€” market crash","danger"),t.bankCount!==void 0&&e.bankCount<t.bankCount&&this._emitEconEvent("ðŸ¦",`Bank failure! ${t.bankCount-e.bankCount} bank(s) collapsed`,"danger"),e.agentsInDebtSpiral>e.population*.15&&(t.agentsInDebtSpiral||0)<e.population*.15&&this._emitEconEvent("ðŸŒ€",`Debt spiral â€” ${e.agentsInDebtSpiral} agents trapped`,"warning"),e.unemployment<.03&&e.inflation>5&&this._emitEconEvent("ðŸ”¥","Wage-price spiral â€” tight labor + high inflation","warning"),Math.abs(e.govDebt)/Math.max(e.gdp,1)>1.5&&(!t.govDebt||Math.abs(t.govDebt)/Math.max(t.gdp,1)<=1.5)&&this._emitEconEvent("ðŸ’°","Sovereign debt crisis â€” debt/GDP > 150%","danger"),e.totalPrivateDebt>e.gdp*2&&(t.totalPrivateDebt||0)<=(t.gdp||1)*2&&this._emitEconEvent("ðŸ’³","Credit boom â€” private debt > 2x GDP","warning");const a=((o=(l=e.history)==null?void 0:l.sectorPrices)==null?void 0:o.housing)||[];if(a.length>10){const n=a[0],c=a[a.length-1];n>0&&c>n*2.5&&!t._housingBubbleEmitted&&(this._emitEconEvent("ðŸ ","Housing bubble â€” prices 2.5x from start","warning"),this._prevEconMetrics._housingBubbleEmitted=!0)}e.unemployment<.02&&(t.unemployment||1)>=.02&&this._emitEconEvent("âœ…","Near full employment!","good"),e.gdpGrowth<-.02&&(t.gdpGrowth||0)<-.02&&this._emitEconEvent("ðŸ“Š","Recession â€” GDP contracting","danger");const r=this.globalEconomy;r.fxRate>2&&(t.fxRate||1)<=2&&this._emitEconEvent("ðŸ’±",`Currency crisis â€” FX rate at ${r.fxRate.toFixed(2)}`,"danger"),r.foreignReserves<50&&(t.foreignReserves||500)>=50&&this._emitEconEvent("ðŸ¦","Foreign reserves critically low!","danger"),r.cumulativeTradeBalance<-500&&(t.cumulativeTradeBalance||0)>=-500&&this._emitEconEvent("ðŸ“¦","Chronic trade deficit â€” imports far exceed exports","warning"),this._prevEconMetrics={totalMarketCap:e.totalMarketCap,bankCount:e.bankCount,agentsInDebtSpiral:e.agentsInDebtSpiral,govDebt:e.govDebt,gdp:e.gdp,gdpGrowth:e.gdpGrowth,totalPrivateDebt:e.totalPrivateDebt,unemployment:e.unemployment,fxRate:r.fxRate,foreignReserves:r.foreignReserves,cumulativeTradeBalance:r.cumulativeTradeBalance,_housingBubbleEmitted:t._housingBubbleEmitted}}_advancePolicyLag(){for(const e of Object.keys(this.policyLag)){const t=this.policyLag[e];t.elapsed++;let s=1;this.approvalRating>80?s=1.3:this.approvalRating<30&&(s=.8);const a=t.elapsed*s,r=Math.min(1,a/t.lagTicks);this.policies[e]=t.start+(t.target-t.start)*r,r>=1&&(this.policies[e]=t.target,delete this.policyLag[e])}}_updateApprovalRating(){const e=this.metrics,t=this._prevMetricsForApproval;let s=0;if(t){e.gdpGrowth>0?s+=e.gdpGrowth*20:s+=e.gdpGrowth*30;const r=e.unemployment-(t.unemployment||0);r<0?s+=2:r>0&&(s-=3),e.avgWage-(t.avgWage||0)>0&&(s+=1);const o=e.povertyRate-(t.povertyRate||0);o<0?s+=1.5:o>0&&(s-=1.5)}e.inflation>8&&(s-=(e.inflation-8)*.15),e.povertyRate>.3&&(s-=1),e.socialUnrest>.5&&(s-=e.socialUnrest*2),(e.crimeRate||0)>.3&&(s-=1),(e.agentsInDebtSpiral||0)>e.population*.1&&(s-=1);const a=this.policies;a.incomeTax>.4&&(s-=1),a.wealthConfiscation>0&&(s-=2),a.nationalizeIndustries&&(s-=1.5),a.ubi>100&&(s+=.5),a.publicHealthcare&&(s+=.3),a.breadAndCircuses&&(s+=1),this.approvalRating=g(this.approvalRating+s*.3,0,100),this.approvalHistory.push(Math.round(this.approvalRating*10)/10),this.approvalHistory.length>200&&this.approvalHistory.shift(),this._prevMetricsForApproval={...q(e)},this.approvalRating<20&&!this._noConfidenceTriggered&&(this._noConfidenceTriggered=!0,X(this.eventsState,this._buildState(),this.policies,this.tick,"voteOfNoConfidence")),this.approvalRating>=25&&(this._noConfidenceTriggered=!1)}_checkInsights(){var s;const e=this.metrics;if(this._lastInsightTick&&this.tick-this._lastInsightTick<100)return null;const t=[{id:"monopoly_forming",condition:()=>this.businesses.some(a=>a.dominance>.6),title:"Monopoly Forming",body:"One business controls over 60% of a market. Competition disappears, prices rise, and innovation stalls.",realWorld:"This mirrors Standard Oil in 1911 or modern big tech. Anti-monopoly policy can break this up â€” but at what cost to efficiency?"},{id:"high_inequality",condition:()=>e.gini>.55,title:"Extreme Inequality",body:`Gini coefficient hit ${(e.gini*100).toFixed(0)}. The top 10% own most of the wealth. Social unrest is rising.`,realWorld:"Research shows high inequality reduces social mobility, increases crime, and can destabilize democracies. Nordic countries maintain ~0.28 Gini through redistribution."},{id:"high_unemployment",condition:()=>e.unemployment>.2,title:"Mass Unemployment",body:`${(e.unemployment*100).toFixed(0)}% unemployment. Businesses can't afford wages; workers can't find jobs.`,realWorld:"The Great Depression peaked at 25% US unemployment. Keynes argued government spending could break the cycle."},{id:"inflation_spiral",condition:()=>e.inflation>8,title:"Inflation Spiral",body:"Prices are rising fast. Your money buys less each tick. Real wages are falling.",realWorld:"Zimbabwe (2008) and Venezuela (2018) experienced hyperinflation from excessive money printing. Central banks fight this with higher interest rates."},{id:"min_wage_tradeoff",condition:()=>this.policies.minWage>15&&e.unemployment>.15,title:"Minimum Wage Tradeoff",body:"Minimum wage is high AND unemployment is rising. Small businesses can't afford to hire.",realWorld:"The minimum wage debate: living wages vs. employment effects. Studies show it depends heavily on local cost of living and business type."},{id:"budget_surplus",condition:()=>e.govBudget>500&&e.govDebt<0,title:"Fiscal Surplus",body:"The government is running a surplus! Tax revenue exceeds spending. Debt is falling.",realWorld:"Budget surpluses allow debt reduction and investment in public goods â€” but may slow demand if taxes are too high."},{id:"bank_crisis",condition:()=>this.banks.filter(a=>a.alive).length<2&&this.banks.length>=2,title:"Banking Crisis",body:"Banks are failing! Reserves depleted by bad loans. Credit dries up and the economy contracts.",realWorld:"The 2008 financial crisis started with bad mortgages. When banks fail, credit freezes, businesses can't borrow, and unemployment spikes."},{id:"credit_bubble",condition:()=>e.totalPrivateDebt>e.gdp*2&&e.gdp>0,title:"Credit Bubble",body:`Private debt is ${(e.totalPrivateDebt/(e.gdp||1)*100).toFixed(0)}% of GDP. Overleveraged economy â€” one shock could cascade.`,realWorld:"Japan in 1991 and the US in 2008 both had private debt exceeding 200% of GDP before their crashes. Steve Keen's research shows this is a key predictor."},{id:"stagnation",condition:()=>e.gdpGrowth<0&&e.unemployment>.12,title:"Stagflation Risk",body:"GDP is shrinking and unemployment is rising simultaneously. The classic policy dilemma.",realWorld:"The 1970s oil crisis created stagflation. Cutting interest rates helps unemployment but worsens inflation. Raising them helps inflation but worsens unemployment."},{id:"crime_wave",condition:()=>(e.crimeRate||0)>.3,title:"Crime Wave",body:`Crime rate hit ${(e.crimeRate||0).toFixed(1)} per 1000. Poverty and unemployment are driving people to desperate measures.`,realWorld:"Research consistently shows crime correlates with poverty, inequality, and unemployment. Policing alone rarely solves root causes."},{id:"corporate_scandal",condition:()=>(e.corporateCrimeCount||0)>3,title:"Corporate Scandal",body:"A wave of corporate fraud is eroding trust in the financial system. Businesses are stealing from employees, customers, and banks.",realWorld:"Enron (2001), WorldCom, and the 2008 mortgage fraud â€” corporate crime costs the economy far more than street crime but receives less attention."},{id:"prison_overcrowding",condition:()=>e.population>0&&(e.prisonPopulation||0)/e.population>.1,title:"Prison Overcrowding",body:`${e.prisonPopulation||0} people are incarcerated â€” over 10% of the population. The prison-industrial complex is consuming the workforce.`,realWorld:"The US incarcerates more people per capita than any other nation. Mass incarceration costs $80B/year and removes productive workers from the economy."},{id:"debt_spiral",condition:()=>e.population>0&&(e.agentsInDebtSpiral||0)/e.population>.15,title:"Debt Trap",body:`${((e.agentsInDebtSpiral||0)/Math.max(1,e.population)*100).toFixed(0)}% of agents are in debt spirals. Poverty becomes self-reinforcing as compounding debt prevents recovery.`,realWorld:"US payday loans trap 12 million Americans yearly in debt cycles. Average borrower pays $520 in fees to borrow $375."},{id:"unanchored_expectations",condition:()=>(e.centralBankCredibility||1)<.3,title:"Unanchored Inflation Expectations",body:`Central bank credibility collapsed to ${((e.centralBankCredibility||0)*100).toFixed(0)}%. People expect high inflation â€” and their behavior makes it self-fulfilling.`,realWorld:"Turkey 2021-2023: unorthodox rate cuts destroyed credibility. Inflation expectations unanchored from 15% to 80%+. Once lost, credibility takes years to rebuild."},{id:"currency_crisis",condition:()=>this.globalEconomy.fxRate>1.8,title:"Currency Crisis",body:`Your currency has depreciated to ${this.globalEconomy.fxRate.toFixed(2)}x. Imports are becoming unaffordable. Foreign reserves are draining.`,realWorld:"The 1997 Asian Financial Crisis saw currencies lose 50-80% of value in months. Capital flight, import inflation, and debt denominated in foreign currency create a vicious spiral."},{id:"trade_deficit",condition:()=>this.globalEconomy.cumulativeTradeBalance<-300,title:"Chronic Trade Deficit",body:"Your economy is importing far more than it exports. Foreign reserves are depleting. The currency is under pressure.",realWorld:"The US has run trade deficits since the 1970s, funded by the dollar's reserve currency status. Most countries can't sustain this â€” eventually the currency adjusts."},{id:"wealth_via_stocks",condition:()=>{const a=this.agents.filter(l=>l.alive&&l.wealth>5e3);return a.filter(l=>l.portfolio&&l.portfolio.length>0).length>a.length*.7&&e.gini>.5},title:"Stock Market Inequality",body:"Over 70% of wealthy agents own stocks while the poor cannot invest. Dividends compound inequality faster than wages ever could.",realWorld:"The top 10% of Americans own 93% of all stocks. Investment income grows exponentially while wages grow linearly â€” the core engine of modern inequality."}];for(const a of t)if(a.condition()&&((s=this._firedInsights)==null?void 0:s.has(a.id))!==!0)return this._firedInsights||(this._firedInsights=new Set),this._firedInsights.add(a.id),this._lastInsightTick=this.tick,{id:a.id,title:a.title,body:a.body,realWorld:a.realWorld,tick:this.tick,year:Math.floor(this.tick/52)};return null}_updateGamification(){const e=q(this.metrics),t={approvalRating:this.approvalRating,policies:this.policies,_score:this._score,_peakGdp:this._peakGdp,_sawHyperinflation:this._sawHyperinflation,_sawGdpCrash:this._sawGdpCrash};e.gdp>this._peakGdp&&(this._peakGdp=e.gdp),e.cpi>200&&(this._sawHyperinflation=!0),this._peakGdp>0&&e.gdp<this._peakGdp*.5&&(this._sawGdpCrash=!0),this._score=St(e,this.approvalRating),this._scoreHistory.push(this._score),this._scoreHistory.length>200&&this._scoreHistory.shift();for(const s of It)if(!this._unlockedAchievements.has(s.id))try{s.sustained?s.check(e,t)?(this._sustainedCounters[s.id]=(this._sustainedCounters[s.id]||0)+j,this._sustainedCounters[s.id]>=s.sustained&&(this._unlockedAchievements.add(s.id),this._newAchievements.push(s))):this._sustainedCounters[s.id]=0:s.check(e,t)&&(this._unlockedAchievements.add(s.id),this._newAchievements.push(s))}catch{}if(this._milestoneProgress<L.length){const s=L[this._milestoneProgress];try{if(s.sustained){const a="ms_"+s.id;s.check(e,t)?(this._sustainedCounters[a]=(this._sustainedCounters[a]||0)+j,this._sustainedCounters[a]>=s.sustained&&(this._completedMilestones.add(s.id),this._milestoneProgress++)):this._sustainedCounters[a]=0}else s.check(e,t)&&(this._completedMilestones.add(s.id),this._milestoneProgress++)}catch{}}}getSnapshot(){return{tick:this.tick,year:Math.floor(this.tick/52),agents:this.agents.map(e=>e.toSnapshot()),businesses:this.businesses.map(e=>e.toSnapshot()),banks:this.banks.map(e=>e.toSnapshot()),metrics:q(this.metrics),market:{prices:{...this.market.prices},supply:{...this.market.supply},demand:{...this.market.demand},cpi:this.market.cpi,inflation:this.market.inflation,avgExpectedInflation:this.market.avgExpectedInflation,centralBankCredibility:this.market.centralBankCredibility},policies:{...this.policies},activeEvents:this.eventsState.activeEvents.map(e=>({id:e.id,name:e.name,icon:e.icon,description:e.description,startTick:e.startTick})),pendingChoice:this.eventsState.pendingChoiceEvent?{id:this.eventsState.pendingChoiceEvent.id,type:this.eventsState.pendingChoiceEvent.type,name:this.eventsState.pendingChoiceEvent.name,description:this.eventsState.pendingChoiceEvent.description,icon:this.eventsState.pendingChoiceEvent.icon,choices:this.eventsState.pendingChoiceEvent.definition.choices,hint:this.eventsState.pendingChoiceEvent.definition.hint}:null,objectives:this._buildObjectivesSnapshot(),scenarioDurationYears:this.scenario.durationYears||null,isHistorical:this.scenario.isHistorical||!1,policyLag:Object.fromEntries(Object.entries(this.policyLag).map(([e,t])=>[e,{current:this.policies[e],target:t.target,progress:Math.min(1,t.elapsed/t.lagTicks)}])),approvalRating:this.approvalRating,approvalHistory:this.approvalHistory,score:this._score,scoreHistory:[...this._scoreHistory],achievements:[...this._unlockedAchievements],newAchievements:this._newAchievements.splice(0).map(e=>({id:e.id,name:e.name,icon:e.icon,description:e.description,category:e.category})),milestoneProgress:this._milestoneProgress,totalMilestones:L.length,currentMilestone:this._milestoneProgress<L.length?{id:L[this._milestoneProgress].id,name:L[this._milestoneProgress].name,icon:L[this._milestoneProgress].icon,description:L[this._milestoneProgress].description}:null,econFeed:this._econFeed.slice(-10),globalEconomy:{worldPrices:{...this.globalEconomy.worldPrices},fxRate:this.globalEconomy.fxRate,foreignReserves:this.globalEconomy.foreignReserves,tradeBalance:{...this.globalEconomy.tradeBalance},cumulativeTradeBalance:this.globalEconomy.cumulativeTradeBalance,activeShock:this.globalEconomy.activeShock?{type:this.globalEconomy.activeShock.type,label:this.globalEconomy.activeShock.label,icon:this.globalEconomy.activeShock.icon,ticksRemaining:this.globalEconomy.activeShock.ticksRemaining}:null,history:{fxRate:this.globalEconomy.history.fxRate.slice(-100),foreignReserves:this.globalEconomy.history.foreignReserves.slice(-100),tradeBalance:this.globalEconomy.history.tradeBalance.slice(-100)}}}}}let P=null,O=!1,oe=1,W=null,Z=0;const Pt={1:10,2:30,5:150,10:600};function Ie(i="freeMarket",e=null){const t=e||De(i);P=new xt(t),O=!0,Z=0}function $(i){if(!(!O||!P)){try{const e=Pt[oe]||oe*30;Z+=e/60;const t=Math.floor(Z);Z-=t;let s=null,a=null,r=null;for(let o=0;o<t;o++){const n=P.step();if(n.event&&(s=n.event),n.insight&&(a=n.insight),n.scenarioComplete&&(r=n.scenarioComplete),s!=null&&s.requiresChoice)break}const l=P.getSnapshot();self.postMessage({type:"STATE_UPDATE",state:l}),s&&(self.postMessage({type:"EVENT",event:s}),s.requiresChoice&&(O=!1,self.postMessage({type:"CHOICE_REQUIRED",event:l.pendingChoice}))),a&&self.postMessage({type:"INSIGHT",insight:a}),r&&(O=!1,self.postMessage({type:"SCENARIO_COMPLETE",report:r}))}catch(e){console.error("[simWorker] loop error:",e)}W=setTimeout($,1e3/60)}}self.addEventListener("message",i=>{const e=i.data;switch(e.type){case"INIT":Ie(e.scenarioId||"freeMarket",e.scenarioConfig||null),$();break;case"SET_POLICY":P&&P.applyMessage(e);break;case"SET_SPEED":oe=e.speed;break;case"PAUSE":O=!1,W&&(clearTimeout(W),W=null);break;case"RESUME":O||(O=!0,$());break;case"RESET":O=!1,W&&(clearTimeout(W),W=null),Ie(e.scenarioId||"freeMarket",e.scenarioConfig||null),$();break;case"RESOLVE_CHOICE":P&&(P.applyMessage(e),O||(O=!0,$()));break;case"FORCE_SHOCK":P&&P.applyMessage(e);break;case"GET_SNAPSHOT":P&&self.postMessage({type:"STATE_UPDATE",state:P.getSnapshot()});break}});

const M=["food","housing","tech","luxury"],B={food:10,housing:50,tech:30,luxury:80},me={food:.15,housing:.2,tech:.8,luxury:1.5},ye={food:2,housing:10,tech:5,luxury:10},be={food:200,housing:500,tech:300,luxury:800},L={food:15,housing:5,tech:10,luxury:8},U=20,ve=1,we=15,ne=500,Ee=-200,Me=.7,ke=.3,Ie=.15,j=.3,D=500,oe=300,Te={food:.15,housing:.3,tech:.1,luxury:.05},q=100,W=5e3,A=800,P=600,Y=.8,K=.2,Se={incomeTax:.25,corporateTax:.21,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.3,unemploymentBenefit:50,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},_e=2e-4,Ce=200,V=10;function h(i,e,t){return Math.max(e,Math.min(t,i))}function g(i=0,e=1){let t=0,s=0;for(;t===0;)t=Math.random();for(;s===0;)s=Math.random();return i+e*Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*s)}function I(i,e){return Math.random()*(e-i)+i}function Re(i){if(!i||i.length===0)return 0;const e=[...i].sort((n,a)=>n-a),t=e.length,s=e.reduce((n,a)=>n+a,0);if(s===0)return 0;let o=0;for(let n=0;n<t;n++)o+=(2*(n+1)-t-1)*e[n];return h(o/(t*s),0,1)}function z(i){return!i||i.length===0?0:i.reduce((e,t)=>e+t,0)/i.length}function Oe(i,e){if(!i||i.length===0)return 0;const t=[...i].sort((o,n)=>o-n),s=Math.floor(e/100*(t.length-1));return t[s]}let ae=1;const b={CHILD:"child",WORKING:"working",UNEMPLOYED:"unemployed",RETIRED:"retired",BUSINESS_OWNER:"owner",DEAD:"dead"};class G{constructor(e={}){this.id=e.id??ae++,this.alive=!0,this.x=e.x??I(20,A-20),this.y=e.y??I(20,P-20),this.vx=0,this.vy=0,this.targetX=this.x,this.targetY=this.y,this.age=e.age??Math.floor(I(936,3380*.6)),this.gender=Math.random()>.5?"M":"F",this.skill=e.skill??h(g(.5,.2),.1,1),this.health=e.health??h(g(.8,.15),.1,1),this.education=e.education??h(g(.5,.25),0,1),this.wealth=e.wealth??h(g(D,oe),10,1/0),this.income=0,this.expenses=0,this.debt=0,this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this.unemployedTicks=0,this.workHistory=[],this.businessId=null,this.isOwner=!1,this.happiness=.5,this.unrest=0,this.socialClass="middle",this.events=[],this.bornInYear=e.bornInYear??0,this.parentWealth=e.parentWealth??D,this.moveTimer=Math.random()*60,this.homeX=this.x,this.homeY=this.y,this.highlight=!1,this.selected=!1,this.deathFade=1,this._updateState()}_updateState(){this.age<936?this.state=b.CHILD:this.age>=3380?this.state=b.RETIRED:this.isOwner?this.state=b.BUSINESS_OWNER:this.employed?this.state=b.WORKING:this.state=b.UNEMPLOYED,this.wealth<q?this.socialClass="poor":this.wealth>=W?this.socialClass="rich":this.socialClass="middle"}tick(e,t){if(this.alive){if(this.age++,this._shouldDie(t)){this._die(e,"natural causes");return}if(this._updateState(),this._move(e),this.state!==b.CHILD&&(this._consumeGoods(e.prices,t),this._earnIncome(t),this._updateHappiness(e,t),this._considerStartingBusiness(e,t)),this.wealth<-500&&this.state!==b.CHILD){this._die(e,"poverty");return}}}_shouldDie(e){if(this.age>=4420)return!0;const t=e.publicHealthcare?.5:1,o=5e-5*(this.age>3380?3:1)*(1-this.health*.5)*t;return Math.random()<o}_die(e,t){if(this.alive=!1,this.state=b.DEAD,this.employed=!1,this.employerId=null,this.deathFade=1,this.events.push(`Died from ${t} at age ${Math.floor(this.age/52)}`),this.wealth>0&&e.agents){const s=e.agents.filter(o=>o.alive&&o.id!==this.id);if(s.length>0){const o=s[Math.floor(Math.random()*s.length)];o.wealth+=this.wealth*.8,o.events.push(`Inherited ${Math.round(this.wealth*.8)} from agent #${this.id}`)}}}_move(e){if(this.moveTimer--,this.moveTimer<=0)if(this.moveTimer=I(30,120),this.employed&&this.employerId&&e.businesses){const n=e.businesses.find(a=>a.id===this.employerId);n?(this.targetX=n.x+g(0,30),this.targetY=n.y+g(0,30)):this._wanderTarget()}else this._wanderTarget();const t=this.targetX-this.x,s=this.targetY-this.y,o=Math.sqrt(t*t+s*s);o>2?(this.vx=t/o*Y,this.vy=s/o*Y):(this.vx*=.9,this.vy*=.9),this.vx+=(Math.random()-.5)*K,this.vy+=(Math.random()-.5)*K,this.x=h(this.x+this.vx,5,A-5),this.y=h(this.y+this.vy,5,P-5)}_wanderTarget(){this.targetX=h(this.x+g(0,60),10,A-10),this.targetY=h(this.y+g(0,60),10,P-10)}_consumeGoods(e,t){let s=0;const o=this.wage||0;for(const n of["food","housing","tech","luxury"]){let a=Te[n];t[`priceControl${n.charAt(0).toUpperCase()+n.slice(1)}`]&&(a*=.8),n==="luxury"&&this.wealth<q*2&&(a=0);const r=o*a/(e[n]||1)*e[n];s+=r}this.expenses=s,this.wealth-=s*.1}_earnIncome(e){let t=0;if(this.employed&&this.wage>0){const s=e.incomeTax||0;t=this.wage*(1-s)}else this.state===b.UNEMPLOYED&&(e.unemploymentBenefit>0&&(t=e.unemploymentBenefit*.1),this.unemployedTicks++);e.ubi>0&&this.state!==b.CHILD&&(t+=e.ubi*.01),this.income=t,this.wealth+=t}_updateHappiness(e,t){var n;let s=.5;const o=this.wealth/1e3;s+=h(o*.2,-.3,.3),this.employed?s+=.1:s-=.15,((n=e.metrics)==null?void 0:n.gini)>.6&&(s-=.1),t.publicHealthcare&&(s+=.05),this.happiness=h(s,0,1),this.unrest=h(1-this.happiness-.3,0,1)}_considerStartingBusiness(e,t){this.state===b.UNEMPLOYED&&this.wealth>300&&this.skill>.4&&!this.businessId&&Math.random()<3e-5&&(this._wantsToStartBusiness=!0)}hire(e,t){this.employed=!0,this.employerId=e.id,this.wage=t,this.jobSector=e.sector,this.unemployedTicks=0,this.workHistory.push({businessId:e.id,sector:e.sector,wage:t,startAge:this.age}),this.events.push(`Hired at ${e.name} (age ${Math.floor(this.age/52)})`),this._updateState()}fire(e="layoff"){if(this.workHistory.length>0){const t=this.workHistory[this.workHistory.length-1];t.endAge=this.age,t.reason=e}this.events.push(`Lost job (${e}) at age ${Math.floor(this.age/52)}`),this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this._updateState()}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,state:this.state,wealth:this.wealth,age:this.age,skill:this.skill,health:this.health,education:this.education,happiness:this.happiness,unrest:this.unrest,employed:this.employed,employerId:this.employerId,socialClass:this.socialClass,wage:this.wage,jobSector:this.jobSector,isOwner:this.isOwner,businessId:this.businessId,deathFade:this.deathFade,events:this.events.slice(-10)}}}function $(i,e={}){ae=1;const t=[];for(let s=0;s<i;s++){const o=e.wealthInequality||1,n=Math.max(10,g(D*(e.wealthMultiplier||1),oe*o));t.push(new G({wealth:n,skill:h(g(e.avgSkill||.5,.2),.05,1),education:h(g(e.avgEducation||.5,.25),0,1),bornInYear:0}))}return t}const F={freeMarket:{id:"freeMarket",name:"Free Market Utopia",subtitle:"No rules. Pure capitalism.",description:"Zero regulation. No minimum wage, no taxes, no safety net. Watch monopolies form naturally and see who wins ‚Äî and who gets left behind.",icon:"ü¶Ö",difficulty:"Observe",color:"#3b82f6",isHistorical:!1,policies:{incomeTax:0,corporateTax:0,minWage:0,ubi:0,interestRate:.02,antiMonopoly:!1,educationFunding:0,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1.2,wealthInequality:1.5,avgSkill:.5,lesson:"Natural monopolies emerge quickly. The rich get richer. But GDP grows fast at first."},debtSpiral:{id:"debtSpiral",name:"The Debt Spiral",subtitle:"Borrowed too much. Now what?",description:"The government spent heavily on social programs. Debt is high, deficit is growing. Austerity or default ‚Äî pick your poison.",icon:"üí∏",difficulty:"Hard",color:"#ef4444",isHistorical:!1,policies:{incomeTax:.45,corporateTax:.35,minWage:15,ubi:200,interestRate:.12,antiMonopoly:!0,educationFunding:.8,unemploymentBenefit:150,priceControlFood:!1,priceControlHousing:!1,printMoney:5,publicHealthcare:!0,wealthTax:.02,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.8,wealthInequality:.8,avgSkill:.55,startGovDebt:5e3,lesson:"Cutting programs causes pain now. Keeping them causes pain later. The political economy of austerity."},techDisruption:{id:"techDisruption",name:"Tech Disruption",subtitle:"Automation is coming for jobs.",description:"A stable, balanced economy. Then a tech breakthrough hits ‚Äî half the jobs can be automated. Will you adapt or collapse?",icon:"ü§ñ",difficulty:"Medium",color:"#8b5cf6",isHistorical:!1,policies:{incomeTax:.28,corporateTax:.21,minWage:12,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.5,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1,wealthInequality:1,avgSkill:.5,scheduledEvents:[{type:"techBreakthrough",atTick:200}],lesson:"Automation creates wealth but destroys jobs. UBI or retraining ‚Äî which policy saves more people?"},greatDepression:{id:"greatDepression",name:"The Great Depression",subtitle:"October 1929. The markets have collapsed.",description:'GDP has fallen 30%. Unemployment is climbing toward 25%. Banks are failing daily. Hoover says "be patient." Do you agree?',icon:"üìâ",difficulty:"Very Hard",color:"#78716c",isHistorical:!0,era:"1929‚Äì1939 ¬∑ United States",durationYears:15,policies:{incomeTax:.02,corporateTax:.12,minWage:0,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.1,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:12,wealthMultiplier:.35,wealthInequality:2,avgSkill:.4,scheduledEvents:[{type:"recession",atTick:1},{type:"financialBubble",atTick:80}],lesson:"Austerity deepened the Depression. FDR's New Deal proved government spending could restart demand."},weimarHyperinflation:{id:"weimarHyperinflation",name:"Weimar Hyperinflation",subtitle:"A loaf of bread costs a wheelbarrow of cash.",description:"Post-WWI Germany is printing money to pay reparations. Inflation is doubling daily. The middle class is being wiped out. Can you stabilize the currency before society collapses?",icon:"üíπ",difficulty:"Expert",color:"#dc2626",isHistorical:!0,era:"1921‚Äì1924 ¬∑ Germany",durationYears:10,policies:{incomeTax:.15,corporateTax:.1,minWage:0,ubi:0,interestRate:.01,antiMonopoly:!1,educationFunding:.2,unemploymentBenefit:0,priceControlFood:!0,priceControlHousing:!1,printMoney:40,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:180,businessCount:15,wealthMultiplier:.5,wealthInequality:1.8,avgSkill:.45,scheduledEvents:[],lesson:"Stopping hyperinflation requires cold turkey: halt money printing, issue new credible currency, accept short-term pain."},stagflation1970s:{id:"stagflation1970s",name:"1970s Stagflation",subtitle:"Inflation up. Unemployment up. Nothing works.",description:"OPEC's oil embargo just hit. Prices are surging but the economy is stagnating. Your standard policy tools are pointing in opposite directions. What do you do?",icon:"‚õΩ",difficulty:"Hard",color:"#d97706",isHistorical:!0,era:"1973‚Äì1982 ¬∑ United States",durationYears:12,policies:{incomeTax:.3,corporateTax:.48,minWage:8,ubi:0,interestRate:.06,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:8,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.85,wealthInequality:1.1,avgSkill:.5,scheduledEvents:[{type:"cropFailure",atTick:20},{type:"recession",atTick:150}],lesson:"Stagflation broke Keynesian consensus. Volcker's painful rate hikes eventually worked ‚Äî but cost millions their jobs."},crisisOf2008:{id:"crisisOf2008",name:"2008 Financial Crisis",subtitle:"Lehman just failed. The banks are frozen.",description:"The US housing bubble has burst. Banks are insolvent. Credit is frozen. The global economy is in freefall. Bail out the banks, let them fail, or something else?",icon:"üè¶",difficulty:"Hard",color:"#7c3aed",isHistorical:!0,era:"2008‚Äì2015 ¬∑ Global",durationYears:10,policies:{incomeTax:.28,corporateTax:.35,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.4,unemploymentBenefit:100,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:16,wealthMultiplier:.7,wealthInequality:1.6,avgSkill:.5,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:30}],lesson:"Bailouts prevented a depression but rewarded recklessness. The political consequences lasted a decade."},japanLostDecade:{id:"japanLostDecade",name:"Japan's Lost Decade",subtitle:"Zero rates. Zero growth. Zero inflation.",description:"Japan's asset bubble burst in 1991. Interest rates are near zero. Stimulus packages come and go. Nothing works. Can you escape the deflationary trap that trapped Japan for 20 years?",icon:"üóæ",difficulty:"Expert",color:"#0891b2",isHistorical:!0,era:"1991‚Äì2010 ¬∑ Japan",durationYears:15,policies:{incomeTax:.33,corporateTax:.38,minWage:6,ubi:0,interestRate:.005,antiMonopoly:!1,educationFunding:.6,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:2,publicHealthcare:!0,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:.9,wealthInequality:.9,avgSkill:.65,scheduledEvents:[{type:"financialBubble",atTick:1},{type:"recession",atTick:10}],lesson:"Half-measures and zombie banks prolonged Japan's stagnation for 20 years. Swift, decisive action matters."},nordicMiracle:{id:"nordicMiracle",name:"Build the Nordic Model",subtitle:"High taxes. High trust. High happiness.",description:"You're building a new nation. Can you achieve the Nordic balance: low inequality, high productivity, strong safety net, and sustained growth? This is what success looks like.",icon:"üåç",difficulty:"Blueprint",color:"#059669",isHistorical:!0,era:"Reference Model ¬∑ Scandinavia",durationYears:20,policies:{incomeTax:.45,corporateTax:.25,minWage:18,ubi:0,interestRate:.03,antiMonopoly:!0,educationFunding:.9,unemploymentBenefit:200,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!0,wealthTax:.01,openBorders:!1,subsidiesFarming:!0},agentCount:200,businessCount:22,wealthMultiplier:1,wealthInequality:.7,avgSkill:.6,avgEducation:.65,scheduledEvents:[],lesson:"The Nordic model requires high institutional trust, universal services, AND open competitive markets. All three."}};function re(i){return F[i]||F.freeMarket}const le=Object.values(F);le.filter(i=>!i.isHistorical);le.filter(i=>i.isHistorical);let ce=1;const xe={food:["FarmFresh","GrainCo","HarvestHub","OrchardInc","FoodWorks","NourishCo"],housing:["ShelterCo","HomeBase","RoofWorks","DwellCo","AbodeLtd","NestBuilders"],tech:["DataSpark","ByteForge","CodeWorks","TechVault","NeuralCo","SyntaxLtd"],luxury:["GoldEdge","EliteCo","PremiumHub","LuxuryInc","OpalWorks","CrestLtd"]};class he{constructor(e={}){this.id=e.id??ce++,this.alive=!0,this.sector=e.sector??M[Math.floor(Math.random()*M.length)];const t=xe[this.sector];this.name=e.name??t[Math.floor(Math.random()*t.length)]+" #"+this.id,this.x=e.x??I(30,A-30),this.y=e.y??I(30,P-30),this.capital=e.capital??ne,this.revenue=0,this.expenses=0,this.profit=0,this.profitHistory=[],this.productivity=e.productivity??h(g(1,.2),.3,2.5),this.production=0,this.price=B[this.sector],this.inventory=0,this.maxInventory=100,this.employees=[],this.maxEmployees=e.maxEmployees??Math.floor(I(ve,we)),this.wageOffered=e.wageOffered??12,this.hiringCooldown=0,this.firingCooldown=0,this.marketShare=0,this.dominance=0,this.ownerId=e.ownerId??null,this.age=0,this.totalProduced=0,this.totalRevenue=0,this.events=[],this.radius=10,this.pulse=0}tick(e,t){this.alive&&(this.age++,this.hiringCooldown=Math.max(0,this.hiringCooldown-1),this.firingCooldown=Math.max(0,this.firingCooldown-1),this._produce(t),this._sellGoods(e.prices),this._payWages(t),this._adjustPriceStrategy(e),this._adjustWorkforce(e,t),this._checkBankruptcy(e),this._updateVisuals())}_produce(e){const t=this.employees.length;if(t===0){this.production=0;return}let s=L[this.sector]*t*this.productivity;e.subsidiesFarming&&this.sector==="food"&&(s*=1.3),e.educationFunding>.5&&(s*=1+e.educationFunding*.1),this.production=Math.floor(s),this.inventory=Math.min(this.inventory+this.production,this.maxInventory),this.totalProduced+=this.production}_sellGoods(e){const t=e[this.sector]||B[this.sector],s=Math.min(this.inventory,Math.floor(this.production*.9));this.revenue=s*t,this.inventory=Math.max(0,this.inventory-s),this.capital+=this.revenue,this.totalRevenue+=this.revenue}_payWages(e){const t=e.minWage||0,o=Math.max(this.wageOffered,t)*this.employees.length;if(this.expenses=o,this.capital-=o,this.profit=this.revenue-this.expenses,this.profitHistory.push(this.profit),this.profitHistory.length>50&&this.profitHistory.shift(),this.profit>0){const n=e.corporateTax||0,a=this.profit*n;this.capital-=a}this.profit>this.revenue*Ie*2?this.wageOffered=Math.min(this.wageOffered*1.02,100):this.profit<0&&this.employees.length>0&&(this.wageOffered=Math.max(this.wageOffered*.98,t))}_adjustPriceStrategy(e){var o;const t=this.wageOffered;this.employees.length>0&&t*this.employees.length/Math.max(this.production,1);const s=this.inventory/this.maxInventory;s>.8?this.price*=.995:s<.2&&this.production>0&&(this.price*=1.005),(o=e.policies)!=null&&o.antiMonopoly&&this.dominance>.4&&(this.price*=.99)}_adjustWorkforce(e,t){const s=this.production>0?Math.min(this.production/(L[this.sector]*this.maxEmployees*this.productivity),1):0;this.hiringCooldown===0&&this.employees.length<this.maxEmployees&&s>Me&&this.capital>this.wageOffered*20&&this._hire(e),this.firingCooldown===0&&this.employees.length>1&&(s<ke||this.capital<0)&&this._fire(e)}_hire(e){var n;const t=((n=e.agents)==null?void 0:n.filter(a=>a.alive&&!a.employed&&!a.isOwner&&a.state!=="child"&&a.state!=="retired"))||[];if(t.length===0)return;t.sort((a,r)=>r.skill-a.skill);const s=t[0],o=Math.max(this.wageOffered,policies.minWage||0);s.hire(this,o),this.employees.push(s.id),this.hiringCooldown=10,this.events.push(`Hired agent #${s.id}`)}_fire(e){var o;if(this.employees.length===0)return;const t=this.employees[this.employees.length-1];this.employees=this.employees.filter(n=>n!==t);const s=(o=e.agents)==null?void 0:o.find(n=>n.id===t);s&&s.fire("layoff"),this.firingCooldown=15,this.events.push(`Fired agent #${t}`)}_checkBankruptcy(e){this.capital<Ee&&this._close(e,"bankruptcy")}_close(e,t){var s,o,n;this.alive=!1,this.events.push(`Closed due to ${t}`);for(const a of this.employees){const r=(s=e.agents)==null?void 0:s.find(c=>c.id===a);r&&r.fire(t)}if(this.employees=[],this.ownerId){const a=(o=e.agents)==null?void 0:o.find(r=>r.id===this.ownerId);a&&(a.isOwner=!1,a.businessId=null,a.events.push(`Business closed (${t}) at age ${Math.floor(a.age/52)}`),(n=a._updateState)==null||n.call(a))}}_updateVisuals(){this.profit>this.revenue*.2?this.pulse=Math.min(1,this.pulse+.05):this.pulse=Math.max(0,this.pulse-.03),this.radius=8+this.employees.length*.5+this.pulse*3}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,sector:this.sector,name:this.name,capital:this.capital,revenue:this.revenue,profit:this.profit,production:this.production,price:this.price,inventory:this.inventory,employees:[...this.employees],employeeCount:this.employees.length,maxEmployees:this.maxEmployees,wageOffered:this.wageOffered,marketShare:this.marketShare,dominance:this.dominance,productivity:this.productivity,age:this.age,radius:this.radius,pulse:this.pulse,ownerId:this.ownerId}}}function J(i,e,t={}){ce=1;const s=[],o=Math.floor(i/M.length);for(const n of M)for(let a=0;a<o;a++){const r=new he({sector:n,capital:ne*(t.startCapitalMultiplier||1),productivity:h(g(t.avgProductivity||1,.2),.3,2.5)}),c=e.filter(l=>l.alive&&!l.employed&&!l.isOwner&&l.state!=="child"&&l.state!=="retired"&&l.skill>.4);if(c.length>0){c.sort((p,d)=>d.skill-p.skill);const l=c[0];r.ownerId=l.id,l.isOwner=!0,l.businessId=r.id,l.employed=!0,l.employerId=r.id,l.wage=20,l.jobSector=n,l.state="owner",r.employees.push(l.id)}s.push(r)}return s}function X(){return{prices:{...B},supply:{food:0,housing:0,tech:0,luxury:0},demand:{food:0,housing:0,tech:0,luxury:0},inflation:0,cpi:100,basePrices:{...B}}}function Ae(i,e,t){const{agents:s,businesses:o}=e,n=s.filter(l=>l.alive&&l.state!=="child"),a=o.filter(l=>l.alive);let r=0;for(const l of M){const p=a.filter(v=>v.sector===l).reduce((v,R)=>v+R.production,0),d=n.filter(v=>v.employed||v.isOwner),m=d.length>0?d.reduce((v,R)=>v+(R.wage||20),0)/d.length:20,T={food:.15,housing:.25,tech:.1,luxury:.05},y=n.length*m*(T[l]||.1);i.supply[l]=p,i.demand[l]=y;const f=Math.max(p,1),S=(y-f)/f,ge=me[l];let _=S*ge*.05;l==="food"&&t.priceControlFood&&(_=h(_,-.01,.01)),l==="housing"&&t.priceControlHousing&&(_=h(_,-.01,.01)),t.printMoney>0&&(_+=t.printMoney*1e-4);const N=i.prices[l],H=h(N*(1+h(_,-.08,.08)),ye[l],be[l]);i.prices[l]=H;for(const v of a.filter(R=>R.sector===l))v.price=H;r+=(H-N)/N}const c={food:.35,housing:.35,tech:.15,luxury:.15};return i.cpi=M.reduce((l,p)=>l+i.prices[p]/i.basePrices[p]*c[p]*100,0),i.inflation=r/M.length,Pe(a),i}function Pe(i){for(const e of M){const t=i.filter(o=>o.sector===e),s=t.reduce((o,n)=>o+n.production,0);if(s!==0)for(const o of t)o.marketShare=o.production/s,o.dominance=o.marketShare}}function Be(i,e){return i.businesses.filter(s=>s.alive).reduce((s,o)=>s+o.production*e.prices[o.sector],0)}function Ne(i){const e=i.filter(s=>s.alive&&s.state!=="child"&&s.state!=="retired"&&s.state!=="dead");return e.length===0?0:e.filter(s=>s.state==="unemployed").length/e.length}function He(i){const e=i.filter(s=>s.alive&&s.state!=="dead"&&s.state!=="child");return e.length===0?0:e.filter(s=>s.wealth<100).length/e.length}function De(i,e){const{agents:t,businesses:s}=i,o=t.filter(a=>a.alive&&a.state==="unemployed"&&a.age>18*52),n=s.filter(a=>a.alive&&a.employees.length<a.maxEmployees&&a.capital>a.wageOffered*10);if(!(o.length===0||n.length===0))for(const a of n){if(o.length===0)break;let r=0,c=-1/0;for(let d=0;d<o.length;d++){const m=o[d],T=m.x-a.x,y=m.y-a.y,f=Math.sqrt(T*T+y*y),S=m.skill*.7+m.education*.3-f*.001;S>c&&(c=S,r=d)}const l=o[r],p=We(a,l,e);a.capital>p*5&&(l.hire(a,p),a.employees.push(l.id),a.hiringCooldown=10,o.splice(r,1))}}function We(i,e,t){const s=t.minWage||0,o=i.wageOffered,n=e.skill*10+e.education*5,a=o*(1-j)+n*j;return Math.max(a,s)}function Z(i={}){return{...Se,...i}}function Ge(i,e,t){const{agents:s,businesses:o}=i;if(e.minWage>0)for(const n of o.filter(a=>a.alive))n.wageOffered<e.minWage&&(n.wageOffered=e.minWage,n.capital<e.minWage*n.employees.length*20);if(e.antiMonopoly)for(const n of o.filter(a=>a.alive&&a.dominance>.5))n.maxEmployees=Math.max(5,Math.floor(n.maxEmployees*.9));if(e.interestRate>.1)for(const n of o.filter(a=>a.alive))n.capital-=n.capital*e.interestRate*.001;if(e.printMoney>0){const n=e.printMoney,a=s.filter(r=>r.alive&&r.state!=="dead");for(const r of a)r.wealth+=n*.01}if(e.educationFunding>.3){const n=s.filter(a=>a.alive&&a.age<1560&&a.state!=="dead");for(const a of n)Math.random()<e.educationFunding*1e-4&&(a.skill=h(a.skill+.001,0,1),a.education=h(a.education+.001,0,1))}if(e.publicHealthcare&&Math.random()<.001){const n=s.filter(a=>a.alive&&a.health<.5);for(const a of n.slice(0,5))a.health=h(a.health+.01,0,1)}}function Q(){return{tick:0,year:0,gdp:0,gdpGrowth:0,gini:0,unemployment:0,povertyRate:0,cpi:100,inflation:0,avgWage:0,avgWealth:0,medianWealth:0,socialUnrest:0,population:0,businessCount:0,bankruptcies:0,totalTaxRevenue:0,govBudget:0,govDebt:0,history:{gdp:[],gini:[],unemployment:[],cpi:[],population:[],unrest:[]}}}function Fe(i,e,t,s){const{agents:o,businesses:n}=e,a=o.filter(f=>f.alive&&f.state!=="dead"),r=n.filter(f=>f.alive);i.tick++,i.year=Math.floor(i.tick/52),i.population=a.length,i.businessCount=r.length;const c=a.map(f=>Math.max(0,f.wealth));i.gini=Re(c),i.avgWealth=z(c),i.medianWealth=Oe(c,50);const l=i.gdp;i.gdp=Be(e,t),i.gdpGrowth=l>0?(i.gdp-l)/l:0,i.unemployment=Ne(a),i.povertyRate=He(a);const p=a.filter(f=>f.employed&&f.wage>0);i.avgWage=p.length>0?p.reduce((f,S)=>f+S.wage,0)/p.length:0,i.cpi=t.cpi,i.inflation=t.inflation*100;const d=a.map(f=>f.unrest);i.socialUnrest=z(d);const m=Le(a,r,s),T=Ue(a,s);i.totalTaxRevenue=m,i.govBudget=m-T,i.govDebt+=-i.govBudget*.1;const y=i.history;return C(y.gdp,i.gdp),C(y.gini,i.gini),C(y.unemployment,i.unemployment*100),C(y.cpi,i.cpi),C(y.population,i.population),C(y.unrest,i.socialUnrest*100),i}function C(i,e){i.push(Math.round(e*100)/100),i.length>Ce&&i.shift()}function Le(i,e,t){const s=i.filter(a=>a.employed&&a.wage>0).reduce((a,r)=>a+r.wage*(t.incomeTax||0),0),o=e.filter(a=>a.profit>0).reduce((a,r)=>a+r.profit*(t.corporateTax||0),0),n=i.filter(a=>a.wealth>W).reduce((a,r)=>a+(r.wealth-W)*(t.wealthTax||0),0);return s+o+n}function Ue(i,e){const s=i.filter(r=>r.state==="unemployed").length*(e.unemploymentBenefit||0)*.1,o=i.filter(r=>r.state!=="child").length*(e.ubi||0)*.01,n=e.publicHealthcare?i.length*.5:0,a=i.length*(e.educationFunding||0)*.2;return s+o+n+a}function x(i){return{tick:i.tick,year:i.year,gdp:i.gdp,gdpGrowth:i.gdpGrowth,gini:i.gini,unemployment:i.unemployment,povertyRate:i.povertyRate,cpi:i.cpi,inflation:i.inflation,avgWage:i.avgWage,avgWealth:i.avgWealth,medianWealth:i.medianWealth,socialUnrest:i.socialUnrest,population:i.population,businessCount:i.businessCount,govDebt:i.govDebt,totalTaxRevenue:i.totalTaxRevenue,history:i.history}}const u={PANDEMIC:"pandemic",CROP_FAILURE:"cropFailure",TECH_BREAKTHROUGH:"techBreakthrough",FINANCIAL_BUBBLE:"financialBubble",CORRUPTION:"corruption",IMMIGRATION_WAVE:"immigrationWave",RECESSION:"recession",BOOM:"boom"},de={[u.PANDEMIC]:{name:"Pandemic",description:"A disease is spreading fast. How do you respond?",duration:200,icon:"ü¶†",effects:{healthMultiplier:.7,productionMultiplier:.6,deathRateMultiplier:3,consumerSpendingMultiplier:.5},choices:[{id:"lockdown",label:"Lockdown",emoji:"üè†",description:"Shut down non-essential businesses. Mandate isolation.",tradeoff:"Saves lives, fewer deaths. GDP falls sharply. Unemployment spikes short-term.",historicalNote:"COVID lockdowns (2020) saved millions but triggered the sharpest recession since WWII.",effectOverride:{healthMultiplier:.95,productionMultiplier:.4,deathRateMultiplier:1.2,duration:150}},{id:"herd_immunity",label:"Herd Immunity",emoji:"üß¨",description:"Keep the economy open. Let the disease spread to build immunity.",tradeoff:"Economy keeps running. Much higher death toll. Healthcare system may collapse.",historicalNote:"Sweden's initial COVID approach ‚Äî lower short-term GDP hit but higher deaths.",effectOverride:{healthMultiplier:.5,productionMultiplier:.8,deathRateMultiplier:5,duration:250}},{id:"targeted_support",label:"Targeted Support",emoji:"üíâ",description:"Protect vulnerable groups. Support businesses. Invest in healthcare.",tradeoff:"Balanced outcome. Costs significant government spending.",historicalNote:"Germany's Kurzarbeit (short-work) scheme kept unemployment low during COVID.",effectOverride:{healthMultiplier:.8,productionMultiplier:.65,deathRateMultiplier:1.8,duration:180},govDebtPenalty:1e3}]},[u.CROP_FAILURE]:{name:"Crop Failure",description:"Severe drought has decimated harvests. Food prices are spiking. The poor can't eat. What do you do?",duration:150,icon:"üåæ",effects:{foodSupplyMultiplier:.3,foodPriceMultiplier:2.5},choices:[{id:"food_aid",label:"Emergency Food Aid",emoji:"üçû",description:"Government distributes food and subsidizes prices for low-income households.",tradeoff:"Prevents starvation and unrest. Costs government significantly. Doesn't fix supply.",historicalNote:"US food stamps (1939, expanded 1961) prevented widespread malnutrition during agricultural crises.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.4,duration:120},govDebtPenalty:600},{id:"price_controls_food",label:"Cap Food Prices",emoji:"üè∑Ô∏è",description:"Legally limit how much food can cost. Sellers cannot raise prices above the cap.",tradeoff:"Keeps food accessible short-term. Reduces farmer incentives ‚Äî may worsen next harvest.",historicalNote:"USSR price controls kept bread cheap but caused chronic shortages and black markets.",effectOverride:{foodSupplyMultiplier:.3,foodPriceMultiplier:1.1,duration:200},policyOverrides:{priceControlFood:!0}},{id:"import_food",label:"Open Food Imports",emoji:"üö¢",description:"Remove trade barriers on food. International supply fills the gap.",tradeoff:"Quickly stabilizes prices. Hurts domestic farmers long-term. Adds trade dependency.",historicalNote:"Ireland's famine (1845) was worsened by British refusal to halt food exports. Open imports could have saved millions.",effectOverride:{foodSupplyMultiplier:.8,foodPriceMultiplier:1.3,duration:100},policyOverrides:{openBorders:!0}}]},[u.TECH_BREAKTHROUGH]:{name:"Tech Breakthrough",description:"A new technology could double productivity ‚Äî but automate 20% of jobs. How do you respond to this disruption?",duration:300,icon:"üöÄ",effects:{techProductivityMultiplier:2,techWorkerWageMultiplier:1.5,otherJobsAutomatedRate:.1},choices:[{id:"embrace_tech",label:"Embrace It Fully",emoji:"ü§ñ",description:"Let the market adopt technology at full speed. No restrictions.",tradeoff:"Maximum GDP growth. Rapid job displacement. High inequality surge.",historicalNote:"Industrial Revolution (1760s+): enormous long-term gains, but decades of worker misery before adaptation.",effectOverride:{techProductivityMultiplier:2.5,techWorkerWageMultiplier:2,otherJobsAutomatedRate:.25,duration:300}},{id:"managed_transition",label:"Managed Transition",emoji:"üéì",description:"Tax tech gains, fund retraining programs and transition support for displaced workers.",tradeoff:"Slower adoption but smoother adjustment. Higher government cost. Better long-term stability.",historicalNote:`Germany's "Kurzarbeit" and Denmark's "flexicurity" ‚Äî managed disruption with strong safety nets.`,effectOverride:{techProductivityMultiplier:1.7,techWorkerWageMultiplier:1.3,otherJobsAutomatedRate:.08,duration:250},govDebtPenalty:800,policyOverrides:{educationFunding:.8,unemploymentBenefit:150}},{id:"restrict_automation",label:"Regulate Automation",emoji:"‚õî",description:"Limit how quickly companies can replace workers with machines. Robot tax.",tradeoff:"Protects jobs short-term. Slows GDP growth. May fall behind globally.",historicalNote:"Luddites (1811) destroyed textile machinery. Short-term protection, but technology won eventually.",effectOverride:{techProductivityMultiplier:1.2,techWorkerWageMultiplier:1.1,otherJobsAutomatedRate:.03,duration:350}}]},[u.FINANCIAL_BUBBLE]:{name:"Financial Bubble",description:"Asset prices are wildly inflated. A crash appears imminent. How do you respond?",duration:250,icon:"üí•",effects:{wealthInflationPhase:1.5,wealthCrashPhase:.4},choices:[{id:"let_it_burn",label:"Let It Burn",emoji:"üî•",description:"No intervention. Let markets correct naturally.",tradeoff:"Short, sharp crash. High unemployment spike. Faster long-term recovery.",historicalNote:"Hoover's approach in 1929 ‚Äî worsened the Depression when banks also failed.",effectOverride:{wealthCrashPhase:.25,duration:150}},{id:"bailout",label:"Bail Out Banks",emoji:"üè¶",description:"Government buys toxic assets. Prevent bank collapse.",tradeoff:"Softer crash, but adds massive debt and rewards recklessness. Slow recovery.",historicalNote:"TARP (2008) ‚Äî prevented depression but caused lasting public anger.",effectOverride:{wealthCrashPhase:.6,duration:350},govDebtPenalty:2e3},{id:"regulate",label:"Emergency Controls",emoji:"‚öñÔ∏è",description:"Freeze credit, impose capital controls, force write-downs.",tradeoff:"Medium crash severity. Suppresses growth for years but prevents another bubble.",historicalNote:"Sweden 1992: nationalized banks, forced writedowns, recovered fully in 3 years.",effectOverride:{wealthCrashPhase:.45,duration:200},policyOverrides:{antiMonopoly:!0,interestRate:.08}}]},[u.CORRUPTION]:{name:"Corruption Scandal",description:"Government corruption diverts tax revenue. Public services collapse.",duration:180,icon:"üí∞",effects:{taxRevenueLeakage:.5,publicTrustMultiplier:.6}},[u.IMMIGRATION_WAVE]:{name:"Immigration Wave",description:"Skilled workers arrive, boosting productivity but increasing competition for jobs.",duration:0,icon:"üåç",effects:{newAgentCount:30,newAgentSkillBonus:.3}},[u.RECESSION]:{name:"Recession",description:"The economy is contracting. Businesses are cutting, unemployment is rising. What's your response?",duration:200,icon:"üìâ",effects:{demandMultiplier:.6,businessCapitalDrain:.02,hiringSuppression:!0},choices:[{id:"stimulus",label:"Stimulus Package",emoji:"üíµ",description:"Government spending on infrastructure, public jobs, and direct payments.",tradeoff:"Kickstarts demand. Adds to government debt. May cause mild inflation.",historicalNote:"FDR's New Deal (1933), Obama's ARRA (2009), Biden's ARP (2021) ‚Äî all used stimulus to end recessions.",effectOverride:{demandMultiplier:.85,businessCapitalDrain:.01,hiringSuppression:!1,duration:130},govDebtPenalty:1500},{id:"austerity",label:"Austerity",emoji:"‚úÇÔ∏è",description:"Cut government spending. Reduce deficit. Let weak firms fail.",tradeoff:"Improves budget balance. Deepens recession short-term. May extend recovery by years.",historicalNote:"UK and EU austerity (2010-2015) extended the recession and caused a lost generation of unemployment.",effectOverride:{demandMultiplier:.45,businessCapitalDrain:.04,hiringSuppression:!0,duration:280},policyOverrides:{unemploymentBenefit:0,educationFunding:.1}},{id:"rate_cut",label:"Cut Interest Rates",emoji:"üè¶",description:"Lower borrowing costs to encourage investment and spending.",tradeoff:"Helps businesses invest. Limited effect if rates are already near zero.",historicalNote:"Fed cut rates to near-zero in 2008 and 2020 ‚Äî effective, but creates risk of asset bubbles.",effectOverride:{demandMultiplier:.72,businessCapitalDrain:.01,hiringSuppression:!1,duration:160},policyOverrides:{interestRate:.005}}]},[u.BOOM]:{name:"Economic Boom",description:"Consumer confidence surges. Spending rises, businesses thrive.",duration:150,icon:"üìà",effects:{demandMultiplier:1.4,hiringBoost:!0,wageGrowthRate:1.02}}};function ee(){return{activeEvents:[],eventHistory:[],lastEventTick:0}}function te(i,e,t,s,o=null){i.activeEvents=i.activeEvents.filter(a=>a.definition.duration===0?!0:s-a.startTick<a.definition.duration);let n=null;if(o)n=qe(i,e,t,s,o);else{const a=_e*(1-i.activeEvents.length*.3);Math.random()<a&&s>i.lastEventTick+100&&(n=Ye(i,e,t,s))}if(n!=null&&n.requiresChoice)return n;for(const a of i.activeEvents)Ve(a,e,t,s);return n}function je(i,e,t,s){var a;const o=i.pendingChoiceEvent;if(!o||o.id!==e)return;const n=(a=o.definition.choices)==null?void 0:a.find(r=>r.id===t);n&&(n.effectOverride&&(Object.assign(o.definition.effects,n.effectOverride),n.effectOverride.duration!==void 0&&(o.definition.duration=n.effectOverride.duration)),n.policyOverrides&&Object.assign(s.policies,n.policyOverrides),n.govDebtPenalty&&s.metrics&&(s.metrics.govDebt=(s.metrics.govDebt||0)+n.govDebtPenalty),o.choiceMade=t,o.requiresChoice=!1,pe(o,s),i.activeEvents.push(o),i.pendingChoiceEvent=null)}function qe(i,e,t,s,o){const n=de[o];return n?ue(i,e,s,o,n):null}function Ye(i,e,t,s){const o=e.metrics||{},n={[u.PANDEMIC]:1,[u.CROP_FAILURE]:1,[u.TECH_BREAKTHROUGH]:1.5,[u.FINANCIAL_BUBBLE]:o.gini>.5?2:.5,[u.CORRUPTION]:o.govDebt>1e3?2:.5,[u.IMMIGRATION_WAVE]:t.openBorders?3:.5,[u.RECESSION]:o.inflation>5?2:.3,[u.BOOM]:o.unemployment<.05?2:.5},a=Object.keys(n),r=a.map(d=>n[d]),c=r.reduce((d,m)=>d+m,0);let l=Math.random()*c,p=a[0];for(let d=0;d<a.length;d++)if(l-=r[d],l<=0){p=a[d];break}return ue(i,e,s,p,de[p])}const Ke={id:"do_nothing",label:"Do Nothing",emoji:"ü§∑",description:"No intervention. Let the situation play out without government action.",tradeoff:"Preserves budget and avoids unintended consequences ‚Äî but cedes control to market forces.",historicalNote:"Doing nothing is itself a policy choice. Hoover (1929), ECB (2010-12), and many others chose inaction with lasting consequences.",effectOverride:null};function ue(i,e,t,s,o){var a;const n={id:`${s}_${t}`,type:s,definition:{...o,effects:{...o.effects}},startTick:t,name:o.name,description:o.description,icon:o.icon};return i.lastEventTick=t,i.eventHistory.push({id:n.id,name:o.name,icon:o.icon,tick:t}),((a=o.choices)==null?void 0:a.length)>0?(o.choices.some(c=>c.id==="do_nothing")||(n.definition={...n.definition,choices:[...o.choices,Ke]}),n.requiresChoice=!0,i.pendingChoiceEvent=n,n):(i.activeEvents.push(n),pe(n,e),n)}function pe(i,e){const{effects:t}=i.definition,s=e.agents.filter(n=>n.alive),o=e.businesses.filter(n=>n.alive);switch(i.type){case u.PANDEMIC:for(const n of s)n.health*=.8+Math.random()*.2,n.health=h(n.health,.1,1);break;case u.IMMIGRATION_WAVE:i._spawnAgents=t.newAgentCount,i._spawnSkillBonus=t.newAgentSkillBonus;break;case u.FINANCIAL_BUBBLE:i.phase="inflate",i.phaseStartTick=i.startTick;break;case u.TECH_BREAKTHROUGH:for(const n of o.filter(a=>a.sector==="tech"))n.productivity*=t.techProductivityMultiplier;break}}function Ve(i,e,t,s){const{effects:o}=i.definition,n=s-i.startTick,a=i.definition.duration>0?n/i.definition.duration:0;switch(i.type){case u.PANDEMIC:if(Math.random()<.01)for(const r of e.businesses.filter(c=>c.alive))r.capital-=r.capital*.005;break;case u.FINANCIAL_BUBBLE:if(a<.5){if(Math.random()<.05)for(const r of e.agents.filter(c=>c.alive&&c.wealth>500))r.wealth*=1.01}else if(i.phase==="inflate"){i.phase="crash";for(const r of e.agents.filter(c=>c.alive))r.wealth*=o.wealthCrashPhase+Math.random()*.3}break;case u.RECESSION:if(Math.random()<.1)for(const r of e.businesses.filter(c=>c.alive))r.capital-=r.capital*o.businessCapitalDrain;break;case u.BOOM:if(Math.random()<.05)for(const r of e.businesses.filter(c=>c.alive))r.wageOffered*=o.wageGrowthRate;break}}const ie={greatDepression:[{id:"restore_employment",label:"Restore Employment",description:"Bring unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:52*2,weight:.4,icon:"üë∑",tip:"Government work programs, public investment, and lower interest rates historically helped."},{id:"gdp_recovery",label:"GDP Recovery",description:"Grow GDP back to starting level",metric:"gdp",operator:"gt_initial",threshold:1,sustainTicks:0,weight:.4,icon:"üìà",tip:"Demand-side stimulus: UBI, public spending, and low interest rates can restart growth."},{id:"prevent_deflation",label:"Stop Deflation",description:"Keep CPI above 90 (avoid deflationary spiral)",metric:"cpi",operator:"gt",threshold:90,sustainTicks:52,weight:.2,icon:"üè¶",tip:"Deflation is self-reinforcing ‚Äî people delay spending, worsening the cycle. QE can help."}],weimarHyperinflation:[{id:"tame_inflation",label:"Tame Hyperinflation",description:"Bring inflation below 5% and hold for 3 years",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*3,weight:.5,icon:"üî•",tip:"Stop money printing immediately. High interest rates are painful but necessary."},{id:"restore_trust",label:"Restore Public Trust",description:"Reduce social unrest below 30%",metric:"socialUnrest",operator:"lt",threshold:.3,sustainTicks:52,weight:.3,icon:"ü§ù",tip:"People need to believe the currency holds value. Actions speak louder than promises."},{id:"employment_stability",label:"Employment Stability",description:"Hold unemployment below 15%",metric:"unemployment",operator:"lt",threshold:.15,sustainTicks:0,weight:.2,icon:"‚öñÔ∏è",tip:"Stabilizing the currency will disrupt employment ‚Äî the question is how much."}],stagflation1970s:[{id:"tame_inflation_s",label:"Control Inflation",description:"Bring inflation below 5%",metric:"inflation",operator:"lt",threshold:5,sustainTicks:52*2,weight:.4,icon:"üî•",tip:"High interest rates cure inflation ‚Äî but cause a recession. Timing matters."},{id:"limit_unemployment_s",label:"Limit Unemployment",description:"Keep unemployment below 10%",metric:"unemployment",operator:"lt",threshold:.1,sustainTicks:0,weight:.35,icon:"üë∑",tip:"The classic dilemma: fixing inflation worsens unemployment and vice versa."},{id:"gdp_positive",label:"Avoid Recession",description:"Keep GDP growth positive",metric:"gdpGrowth",operator:"gt",threshold:0,sustainTicks:52,weight:.25,icon:"üìä",tip:"Near impossible to avoid entirely ‚Äî the question is how deep the recession goes."}],crisisOf2008:[{id:"prevent_depression",label:"Prevent Depression",description:"Keep unemployment below 12%",metric:"unemployment",operator:"lt",threshold:.12,sustainTicks:0,weight:.35,icon:"üè¶",tip:"Bank bailouts and fiscal stimulus are expensive but prevent cascading failures."},{id:"restore_growth_08",label:"Restore Growth",description:"Return GDP to pre-crisis level within 10 years",metric:"gdp",operator:"gt_initial",threshold:.95,sustainTicks:0,weight:.35,icon:"üìà",tip:"Austerity prolongs recessions. Targeted stimulus accelerates recovery."},{id:"inequality_check",label:"Prevent Inequality Surge",description:"Keep Gini below 0.55",metric:"gini",operator:"lt",threshold:.55,sustainTicks:0,weight:.3,icon:"‚öñÔ∏è",tip:"Bailouts that save banks but not homeowners cause lasting inequality damage."}],japanLostDecade:[{id:"escape_deflation",label:"Escape Deflation",description:"Keep CPI above 95 for 5 years",metric:"cpi",operator:"gt",threshold:95,sustainTicks:52*5,weight:.4,icon:"üìâ",tip:"Zero interest rates alone aren't enough. QE, fiscal spending, and structural reform all needed."},{id:"growth_japan",label:"Restart Growth",description:"Achieve positive GDP growth for 3 consecutive years",metric:"gdpGrowth",operator:"gt",threshold:.01,sustainTicks:52*3,weight:.35,icon:"üå±",tip:"Japan's half-measures dragged the slump out for 20 years. Bold action earlier helps."},{id:"low_unemployment_jp",label:"Maintain Employment",description:"Keep unemployment below 6%",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:0,weight:.25,icon:"üíº",tip:"Japan kept employment through corporate welfare (zombie firms). Productive or not?"}],nordicMiracle:[{id:"equality_nordic",label:"Achieve Equality",description:"Bring Gini below 0.30",metric:"gini",operator:"lt",threshold:.3,sustainTicks:52*3,weight:.35,icon:"‚öñÔ∏è",tip:"Universal services + progressive taxation + strong unions. All three matter."},{id:"prosperity_nordic",label:"Maintain Prosperity",description:"Keep unemployment below 6% AND GDP growing",metric:"unemployment",operator:"lt",threshold:.06,sustainTicks:52*2,weight:.35,icon:"üåü",tip:"High taxes don't kill growth if trust, education, and institutions are strong."},{id:"poverty_nordic",label:"Eliminate Poverty",description:"Bring poverty rate below 10%",metric:"povertyRate",operator:"lt",threshold:.1,sustainTicks:52,weight:.3,icon:"üè†",tip:"Universal basic services (healthcare, education, housing support) matter more than cash transfers alone."}]};function ze(i,e,t){const s=e[i.metric];if(s==null)return!1;switch(i.operator){case"lt":return s<i.threshold;case"gt":return s>i.threshold;case"gt_initial":return s>((t==null?void 0:t[i.metric])||0)*i.threshold;default:return!1}}function $e(i,e,t){const s=e[i.metric];if(s==null)return 0;switch(i.operator){case"lt":return Math.min(1,Math.max(0,1-s/(i.threshold*1.5)));case"gt":return Math.min(1,Math.max(0,s/(i.threshold*1.2)));case"gt_initial":{const o=((t==null?void 0:t[i.metric])||1)*i.threshold;return Math.min(1,Math.max(0,s/(o*1.2)))}default:return 0}}class Je{constructor(e={}){this.tick=0,this.running=!1,this.speed=1,this.scenario=e,this.policies=Z(e.policies||{}),this.market=X(),this.metrics=Q(),this.eventsState=ee(),this.agents=$(e.agentCount||200,e),this.businesses=J(e.businessCount||U,this.agents,e),this.objectives=ie[e.id]||[],this.objectiveProgress=this.objectives.map(t=>({...t,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scheduledEvents=e.scheduledEvents||[],e.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,e.scheduledEvent]),this._pendingMessages=[]}applyMessage(e){switch(e.type){case"SET_POLICY":this.policies[e.policy]=e.value;break;case"SET_SPEED":this.speed=e.speed;break;case"RESET":this._reset(e.scenario);break;case"PAUSE":this.running=!1;break;case"RESUME":this.running=!0;break;case"RESOLVE_CHOICE":je(this.eventsState,e.eventId,e.choiceId,this._buildState());break}}_reset(e){const t=re(e)||{};this.scenario=t,this.tick=0,this.policies=Z(t.policies||{}),this.market=X(),this.metrics=Q(),this.eventsState=ee(),this.agents=$(t.agentCount||200,t),this.businesses=J(t.businessCount||U,this.agents,t),this.objectives=ie[t.id]||[],this.objectiveProgress=this.objectives.map(s=>({...s,met:!1,completed:!1,sustainCount:0,progress:0,sustainProgress:0})),this.initialMetrics=null,this.scenarioComplete=!1,this.scheduledEvents=t.scheduledEvents||[],t.scheduledEvent&&(this.scheduledEvents=[...this.scheduledEvents,t.scheduledEvent]),this._firedInsights=null,this._lastInsightTick=null}step(){this.tick++;const e=this._buildState();for(const n of this.agents)n.alive&&n.tick(e,this.policies);for(const n of this.businesses)n.alive&&n.tick(e,this.policies);this.tick%5===0&&De(e,this.policies),Ae(this.market,e,this.policies),Ge(e,this.policies,this.market);for(const n of this.scheduledEvents)this.tick===n.atTick&&te(this.eventsState,e,this.policies,this.tick,n.type);const t=te(this.eventsState,e,this.policies,this.tick);t&&t._spawnAgents&&this._spawnImmigrants(t._spawnAgents,t._spawnSkillBonus),this.tick%52===0&&this._processBirths(),this._cleanup(),this._processNewBusinesses(e),this.tick%V===0&&(Fe(this.metrics,e,this.market,this.policies),this.initialMetrics||(this.initialMetrics={...x(this.metrics)}),this._updateObjectives());const s=this._checkInsights();let o=null;return!this.scenarioComplete&&this.scenario.durationYears&&Math.floor(this.tick/52)>=this.scenario.durationYears&&(this.scenarioComplete=!0,o=this._buildReport()),{shouldUpdate:this.tick%3===0,event:t,insight:s,scenarioComplete:o}}_buildState(){return{agents:this.agents,businesses:this.businesses,policies:this.policies,market:this.market,metrics:this.metrics}}_updateObjectives(){const e=x(this.metrics);for(const t of this.objectiveProgress){const s=ze(t,e,this.initialMetrics);if(t.met=s,t.progress=$e(t,e,this.initialMetrics),s){t.sustainCount=(t.sustainCount||0)+V;const o=t.sustainTicks||0;t.sustainProgress=o>0?Math.min(1,t.sustainCount/o):1,t.sustainCount>=o&&!t.completed&&(t.completed=!0)}else t.sustainCount=0,t.sustainProgress=0}}_buildObjectivesSnapshot(){return this.objectiveProgress.map(e=>({id:e.id,label:e.label,description:e.description,icon:e.icon,tip:e.tip,met:e.met,completed:e.completed,progress:e.progress,sustainProgress:e.sustainProgress,weight:e.weight}))}_buildReport(){const e=x(this.metrics),t=this._buildObjectivesSnapshot(),s=t.reduce((p,d)=>p+(d.weight||0),0)||1,o=t.reduce((p,d)=>{const m=d.completed?100:d.met?50:Math.round(d.progress*40);return p+m*(d.weight||0)},0)/s,n=Math.round(o),a=n>=90?"A+":n>=80?"A":n>=70?"B":n>=60?"C":n>=45?"D":"F",r=Math.round(Math.max(0,(1-this.metrics.gini/.7)*100)),c=Math.round(Math.min(100,Math.max(0,(e.gdpGrowth+.02)*2e3))),l=Math.round(Math.max(0,100-Math.abs(e.inflation)*5-e.socialUnrest*100));return{scenarioId:this.scenario.id,scenarioName:this.scenario.name,finalScore:n,grade:a,domains:{equality:{score:r,label:"Equality"},growth:{score:c,label:"Growth"},stability:{score:l,label:"Stability"}},objectives:t,playerOutcome:{gdpChangePercent:this.initialMetrics?Math.round((e.gdp-this.initialMetrics.gdp)/(this.initialMetrics.gdp||1)*100):0,peakUnemployment:Math.round(e.unemployment*100),inflationAvg:Math.round(e.inflation*10)/10,gini:Math.round(e.gini*100)/100,povertyRate:Math.round(e.povertyRate*100)},finalPolicies:{...this.policies},year:Math.floor(this.tick/52)}}_processBirths(){const e=this.agents.filter(t=>t.alive&&t.age>1040&&t.age<2340);for(const t of e)if(Math.random()<.02&&this.agents.filter(s=>s.alive).length<500){const s=new G({x:t.x+(Math.random()-.5)*20,y:t.y+(Math.random()-.5)*20,age:0,skill:h(g(t.skill,.15),.1,1),education:0,wealth:10,parentWealth:t.wealth,bornInYear:Math.floor(this.tick/52)});this.agents.push(s)}}_spawnImmigrants(e,t){for(let s=0;s<e;s++){const o=new G({skill:h(g(.6+t,.15),.3,1),education:h(g(.6,.2),.2,1),wealth:h(g(300,100),50,800),bornInYear:Math.floor(this.tick/52)});this.agents.push(o)}}_processNewBusinesses(e){const t=this.agents.filter(s=>s._wantsToStartBusiness);for(const s of t){if(delete s._wantsToStartBusiness,this.businesses.filter(r=>r.alive).length>=80||s.wealth<300)continue;const{SECTORS:o}={SECTORS:["food","housing","tech","luxury"]},n=o[Math.floor(Math.random()*o.length)],a=new he({sector:n,capital:s.wealth*.5,ownerId:s.id,productivity:h(g(s.skill,.2),.3,2)});s.wealth*=.5,s.isOwner=!0,s.businessId=a.id,s.employed=!0,s.employerId=a.id,s.wage=20,s.jobSector=n,a.employees.push(s.id),this.businesses.push(a),s.events.push(`Started ${a.name} at age ${Math.floor(s.age/52)}`)}}_cleanup(){this.agents=this.agents.filter(e=>e.alive),this.businesses=this.businesses.filter(e=>e.alive)}_checkInsights(){var s;const e=this.metrics;if(this._lastInsightTick&&this.tick-this._lastInsightTick<100)return null;const t=[{id:"monopoly_forming",condition:()=>this.businesses.some(o=>o.dominance>.6),title:"Monopoly Forming",body:"One business controls over 60% of a market. Competition disappears, prices rise, and innovation stalls.",realWorld:"This mirrors Standard Oil in 1911 or modern big tech. Anti-monopoly policy can break this up ‚Äî but at what cost to efficiency?"},{id:"high_inequality",condition:()=>e.gini>.55,title:"Extreme Inequality",body:`Gini coefficient hit ${(e.gini*100).toFixed(0)}. The top 10% own most of the wealth. Social unrest is rising.`,realWorld:"Research shows high inequality reduces social mobility, increases crime, and can destabilize democracies. Nordic countries maintain ~0.28 Gini through redistribution."},{id:"high_unemployment",condition:()=>e.unemployment>.2,title:"Mass Unemployment",body:`${(e.unemployment*100).toFixed(0)}% unemployment. Businesses can't afford wages; workers can't find jobs.`,realWorld:"The Great Depression peaked at 25% US unemployment. Keynes argued government spending could break the cycle."},{id:"inflation_spiral",condition:()=>e.inflation>8,title:"Inflation Spiral",body:"Prices are rising fast. Your money buys less each tick. Real wages are falling.",realWorld:"Zimbabwe (2008) and Venezuela (2018) experienced hyperinflation from excessive money printing. Central banks fight this with higher interest rates."},{id:"min_wage_tradeoff",condition:()=>this.policies.minWage>15&&e.unemployment>.15,title:"Minimum Wage Tradeoff",body:"Minimum wage is high AND unemployment is rising. Small businesses can't afford to hire.",realWorld:"The minimum wage debate: living wages vs. employment effects. Studies show it depends heavily on local cost of living and business type."},{id:"budget_surplus",condition:()=>e.govBudget>500&&e.govDebt<0,title:"Fiscal Surplus",body:"The government is running a surplus! Tax revenue exceeds spending. Debt is falling.",realWorld:"Budget surpluses allow debt reduction and investment in public goods ‚Äî but may slow demand if taxes are too high."},{id:"stagnation",condition:()=>e.gdpGrowth<0&&e.unemployment>.12,title:"Stagflation Risk",body:"GDP is shrinking and unemployment is rising simultaneously. The classic policy dilemma.",realWorld:"The 1970s oil crisis created stagflation. Cutting interest rates helps unemployment but worsens inflation. Raising them helps inflation but worsens unemployment."}];for(const o of t)if(o.condition()&&((s=this._firedInsights)==null?void 0:s.has(o.id))!==!0)return this._firedInsights||(this._firedInsights=new Set),this._firedInsights.add(o.id),this._lastInsightTick=this.tick,{id:o.id,title:o.title,body:o.body,realWorld:o.realWorld,tick:this.tick,year:Math.floor(this.tick/52)};return null}getSnapshot(){return{tick:this.tick,year:Math.floor(this.tick/52),agents:this.agents.map(e=>e.toSnapshot()),businesses:this.businesses.map(e=>e.toSnapshot()),metrics:x(this.metrics),market:{prices:{...this.market.prices},supply:{...this.market.supply},demand:{...this.market.demand},cpi:this.market.cpi,inflation:this.market.inflation},policies:{...this.policies},activeEvents:this.eventsState.activeEvents.map(e=>({id:e.id,name:e.name,icon:e.icon,description:e.description,startTick:e.startTick})),pendingChoice:this.eventsState.pendingChoiceEvent?{id:this.eventsState.pendingChoiceEvent.id,type:this.eventsState.pendingChoiceEvent.type,name:this.eventsState.pendingChoiceEvent.name,description:this.eventsState.pendingChoiceEvent.description,icon:this.eventsState.pendingChoiceEvent.icon,choices:this.eventsState.pendingChoiceEvent.definition.choices}:null,objectives:this._buildObjectivesSnapshot(),scenarioDurationYears:this.scenario.durationYears||null,isHistorical:this.scenario.isHistorical||!1}}}let w=null,E=!1,fe=1,k=null;function se(i="freeMarket"){const e=re(i);w=new Je(e),E=!0}function O(i){if(!E||!w)return;const e=fe;let t=null,s=null,o=null;for(let a=0;a<e;a++){const r=w.step();if(r.event&&(t=r.event),r.insight&&(s=r.insight),r.scenarioComplete&&(o=r.scenarioComplete),t!=null&&t.requiresChoice)break}const n=w.getSnapshot();self.postMessage({type:"STATE_UPDATE",state:n}),t&&(self.postMessage({type:"EVENT",event:t}),t.requiresChoice&&(E=!1,self.postMessage({type:"CHOICE_REQUIRED",event:n.pendingChoice}))),s&&self.postMessage({type:"INSIGHT",insight:s}),o&&(E=!1,self.postMessage({type:"SCENARIO_COMPLETE",report:o})),k=setTimeout(O,1e3/60)}self.addEventListener("message",i=>{const e=i.data;switch(e.type){case"INIT":se(e.scenarioId||"freeMarket"),O();break;case"SET_POLICY":w&&w.applyMessage(e);break;case"SET_SPEED":fe=e.speed;break;case"PAUSE":E=!1,k&&(clearTimeout(k),k=null);break;case"RESUME":E||(E=!0,O());break;case"RESET":E=!1,k&&(clearTimeout(k),k=null),se(e.scenarioId||"freeMarket"),O();break;case"RESOLVE_CHOICE":w&&(w.applyMessage(e),E=!0,O());break;case"GET_SNAPSHOT":w&&self.postMessage({type:"STATE_UPDATE",state:w.getSnapshot()});break}});

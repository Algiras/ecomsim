const b=["food","housing","tech","luxury"],N={food:10,housing:50,tech:30,luxury:80},le={food:.15,housing:.2,tech:.8,luxury:1.5},he={food:2,housing:10,tech:5,luxury:10},ce={food:200,housing:500,tech:300,luxury:800},G={food:15,housing:5,tech:10,luxury:8},L=20,ue=1,de=15,ee=500,pe=-200,fe=.7,ge=.3,me=.15,U=.3,P=500,te=300,ye={food:.15,housing:.3,tech:.1,luxury:.05},F=100,H=5e3,A=800,x=600,Y=.8,V=.2,ve={incomeTax:.25,corporateTax:.21,minWage:10,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.3,unemploymentBenefit:50,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},Ee=2e-4,we=200,Ie=10;function h(t,e,i){return Math.max(e,Math.min(i,t))}function g(t=0,e=1){let i=0,s=0;for(;i===0;)i=Math.random();for(;s===0;)s=Math.random();return t+e*Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*s)}function T(t,e){return Math.random()*(e-t)+t}function be(t){if(!t||t.length===0)return 0;const e=[...t].sort((a,n)=>a-n),i=e.length,s=e.reduce((a,n)=>a+n,0);if(s===0)return 0;let o=0;for(let a=0;a<i;a++)o+=(2*(a+1)-i-1)*e[a];return h(o/(i*s),0,1)}function $(t){return!t||t.length===0?0:t.reduce((e,i)=>e+i,0)/t.length}function Me(t,e){if(!t||t.length===0)return 0;const i=[...t].sort((o,a)=>o-a),s=Math.floor(e/100*(i.length-1));return i[s]}let ie=1;const E={CHILD:"child",WORKING:"working",UNEMPLOYED:"unemployed",RETIRED:"retired",BUSINESS_OWNER:"owner",DEAD:"dead"};class D{constructor(e={}){this.id=e.id??ie++,this.alive=!0,this.x=e.x??T(20,A-20),this.y=e.y??T(20,x-20),this.vx=0,this.vy=0,this.targetX=this.x,this.targetY=this.y,this.age=e.age??Math.floor(T(936,3380*.6)),this.gender=Math.random()>.5?"M":"F",this.skill=e.skill??h(g(.5,.2),.1,1),this.health=e.health??h(g(.8,.15),.1,1),this.education=e.education??h(g(.5,.25),0,1),this.wealth=e.wealth??h(g(P,te),10,1/0),this.income=0,this.expenses=0,this.debt=0,this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this.unemployedTicks=0,this.workHistory=[],this.businessId=null,this.isOwner=!1,this.happiness=.5,this.unrest=0,this.socialClass="middle",this.events=[],this.bornInYear=e.bornInYear??0,this.parentWealth=e.parentWealth??P,this.moveTimer=Math.random()*60,this.homeX=this.x,this.homeY=this.y,this.highlight=!1,this.selected=!1,this.deathFade=1,this._updateState()}_updateState(){this.age<936?this.state=E.CHILD:this.age>=3380?this.state=E.RETIRED:this.isOwner?this.state=E.BUSINESS_OWNER:this.employed?this.state=E.WORKING:this.state=E.UNEMPLOYED,this.wealth<F?this.socialClass="poor":this.wealth>=H?this.socialClass="rich":this.socialClass="middle"}tick(e,i){if(this.alive){if(this.age++,this._shouldDie(i)){this._die(e,"natural causes");return}if(this._updateState(),this._move(e),this.state!==E.CHILD&&(this._consumeGoods(e.prices,i),this._earnIncome(i),this._updateHappiness(e,i),this._considerStartingBusiness(e,i)),this.wealth<-500&&this.state!==E.CHILD){this._die(e,"poverty");return}}}_shouldDie(e){if(this.age>=4420)return!0;const i=e.publicHealthcare?.5:1,o=5e-5*(this.age>3380?3:1)*(1-this.health*.5)*i;return Math.random()<o}_die(e,i){if(this.alive=!1,this.state=E.DEAD,this.employed=!1,this.employerId=null,this.deathFade=1,this.events.push(`Died from ${i} at age ${Math.floor(this.age/52)}`),this.wealth>0&&e.agents){const s=e.agents.filter(o=>o.alive&&o.id!==this.id);if(s.length>0){const o=s[Math.floor(Math.random()*s.length)];o.wealth+=this.wealth*.8,o.events.push(`Inherited ${Math.round(this.wealth*.8)} from agent #${this.id}`)}}}_move(e){if(this.moveTimer--,this.moveTimer<=0)if(this.moveTimer=T(30,120),this.employed&&this.employerId&&e.businesses){const a=e.businesses.find(n=>n.id===this.employerId);a?(this.targetX=a.x+g(0,30),this.targetY=a.y+g(0,30)):this._wanderTarget()}else this._wanderTarget();const i=this.targetX-this.x,s=this.targetY-this.y,o=Math.sqrt(i*i+s*s);o>2?(this.vx=i/o*Y,this.vy=s/o*Y):(this.vx*=.9,this.vy*=.9),this.vx+=(Math.random()-.5)*V,this.vy+=(Math.random()-.5)*V,this.x=h(this.x+this.vx,5,A-5),this.y=h(this.y+this.vy,5,x-5)}_wanderTarget(){this.targetX=h(this.x+g(0,60),10,A-10),this.targetY=h(this.y+g(0,60),10,x-10)}_consumeGoods(e,i){let s=0;const o=this.wage||0;for(const a of["food","housing","tech","luxury"]){let n=ye[a];i[`priceControl${a.charAt(0).toUpperCase()+a.slice(1)}`]&&(n*=.8),a==="luxury"&&this.wealth<F*2&&(n=0);const r=o*n/(e[a]||1)*e[a];s+=r}this.expenses=s,this.wealth-=s*.1}_earnIncome(e){let i=0;if(this.employed&&this.wage>0){const s=e.incomeTax||0;i=this.wage*(1-s)}else this.state===E.UNEMPLOYED&&(e.unemploymentBenefit>0&&(i=e.unemploymentBenefit*.1),this.unemployedTicks++);e.ubi>0&&this.state!==E.CHILD&&(i+=e.ubi*.01),this.income=i,this.wealth+=i}_updateHappiness(e,i){var a;let s=.5;const o=this.wealth/1e3;s+=h(o*.2,-.3,.3),this.employed?s+=.1:s-=.15,((a=e.metrics)==null?void 0:a.gini)>.6&&(s-=.1),i.publicHealthcare&&(s+=.05),this.happiness=h(s,0,1),this.unrest=h(1-this.happiness-.3,0,1)}_considerStartingBusiness(e,i){this.state===E.UNEMPLOYED&&this.wealth>300&&this.skill>.4&&!this.businessId&&Math.random()<3e-5&&(this._wantsToStartBusiness=!0)}hire(e,i){this.employed=!0,this.employerId=e.id,this.wage=i,this.jobSector=e.sector,this.unemployedTicks=0,this.workHistory.push({businessId:e.id,sector:e.sector,wage:i,startAge:this.age}),this.events.push(`Hired at ${e.name} (age ${Math.floor(this.age/52)})`),this._updateState()}fire(e="layoff"){if(this.workHistory.length>0){const i=this.workHistory[this.workHistory.length-1];i.endAge=this.age,i.reason=e}this.events.push(`Lost job (${e}) at age ${Math.floor(this.age/52)}`),this.employed=!1,this.employerId=null,this.wage=0,this.jobSector=null,this._updateState()}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,state:this.state,wealth:this.wealth,age:this.age,skill:this.skill,health:this.health,education:this.education,happiness:this.happiness,unrest:this.unrest,employed:this.employed,employerId:this.employerId,socialClass:this.socialClass,wage:this.wage,jobSector:this.jobSector,isOwner:this.isOwner,businessId:this.businessId,deathFade:this.deathFade,events:this.events.slice(-10)}}}function j(t,e={}){ie=1;const i=[];for(let s=0;s<t;s++){const o=e.wealthInequality||1,a=Math.max(10,g(P*(e.wealthMultiplier||1),te*o));i.push(new D({wealth:a,skill:h(g(e.avgSkill||.5,.2),.05,1),education:h(g(e.avgEducation||.5,.25),0,1),bornInYear:0}))}return i}const K={freeMarket:{id:"freeMarket",name:"Free Market Utopia",subtitle:"No rules. Pure capitalism.",description:"Zero regulation. No minimum wage, no taxes, no safety net. Watch monopolies form naturally and see who wins â€” and who gets left behind.",icon:"ðŸ¦…",difficulty:"Observe",color:"#3b82f6",policies:{incomeTax:0,corporateTax:0,minWage:0,ubi:0,interestRate:.02,antiMonopoly:!1,educationFunding:0,unemploymentBenefit:0,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1.2,wealthInequality:1.5,avgSkill:.5,lesson:"Natural monopolies emerge quickly. The rich get richer. But GDP grows fast at first."},debtSpiral:{id:"debtSpiral",name:"The Debt Spiral",subtitle:"Borrowed too much. Now what?",description:"The government spent heavily on social programs. Debt is high, deficit is growing. Austerity or default â€” pick your poison.",icon:"ðŸ’¸",difficulty:"Hard",color:"#ef4444",policies:{incomeTax:.45,corporateTax:.35,minWage:15,ubi:200,interestRate:.12,antiMonopoly:!0,educationFunding:.8,unemploymentBenefit:150,priceControlFood:!1,priceControlHousing:!1,printMoney:5,publicHealthcare:!0,wealthTax:.02,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:18,wealthMultiplier:.8,wealthInequality:.8,avgSkill:.55,startGovDebt:5e3,lesson:"Cutting programs causes pain now. Keeping them causes pain later. The political economy of austerity."},techDisruption:{id:"techDisruption",name:"Tech Disruption",subtitle:"Automation is coming for jobs.",description:"A stable, balanced economy. Then a tech breakthrough hits â€” half the jobs can be automated. Will you adapt or collapse?",icon:"ðŸ¤–",difficulty:"Medium",color:"#8b5cf6",policies:{incomeTax:.28,corporateTax:.21,minWage:12,ubi:0,interestRate:.05,antiMonopoly:!1,educationFunding:.5,unemploymentBenefit:80,priceControlFood:!1,priceControlHousing:!1,printMoney:0,publicHealthcare:!1,wealthTax:0,openBorders:!1,subsidiesFarming:!1},agentCount:200,businessCount:20,wealthMultiplier:1,wealthInequality:1,avgSkill:.5,scheduledEvent:{type:"techBreakthrough",atTick:200},lesson:"Automation creates wealth but destroys jobs. UBI or retraining â€” which policy saves more people?"}};function se(t){return K[t]||K.freeMarket}let ne=1;const Te={food:["FarmFresh","GrainCo","HarvestHub","OrchardInc","FoodWorks","NourishCo"],housing:["ShelterCo","HomeBase","RoofWorks","DwellCo","AbodeLtd","NestBuilders"],tech:["DataSpark","ByteForge","CodeWorks","TechVault","NeuralCo","SyntaxLtd"],luxury:["GoldEdge","EliteCo","PremiumHub","LuxuryInc","OpalWorks","CrestLtd"]};class oe{constructor(e={}){this.id=e.id??ne++,this.alive=!0,this.sector=e.sector??b[Math.floor(Math.random()*b.length)];const i=Te[this.sector];this.name=e.name??i[Math.floor(Math.random()*i.length)]+" #"+this.id,this.x=e.x??T(30,A-30),this.y=e.y??T(30,x-30),this.capital=e.capital??ee,this.revenue=0,this.expenses=0,this.profit=0,this.profitHistory=[],this.productivity=e.productivity??h(g(1,.2),.3,2.5),this.production=0,this.price=N[this.sector],this.inventory=0,this.maxInventory=100,this.employees=[],this.maxEmployees=e.maxEmployees??Math.floor(T(ue,de)),this.wageOffered=e.wageOffered??12,this.hiringCooldown=0,this.firingCooldown=0,this.marketShare=0,this.dominance=0,this.ownerId=e.ownerId??null,this.age=0,this.totalProduced=0,this.totalRevenue=0,this.events=[],this.radius=10,this.pulse=0}tick(e,i){this.alive&&(this.age++,this.hiringCooldown=Math.max(0,this.hiringCooldown-1),this.firingCooldown=Math.max(0,this.firingCooldown-1),this._produce(i),this._sellGoods(e.prices),this._payWages(i),this._adjustPriceStrategy(e),this._adjustWorkforce(e,i),this._checkBankruptcy(e),this._updateVisuals())}_produce(e){const i=this.employees.length;if(i===0){this.production=0;return}let s=G[this.sector]*i*this.productivity;e.subsidiesFarming&&this.sector==="food"&&(s*=1.3),e.educationFunding>.5&&(s*=1+e.educationFunding*.1),this.production=Math.floor(s),this.inventory=Math.min(this.inventory+this.production,this.maxInventory),this.totalProduced+=this.production}_sellGoods(e){const i=e[this.sector]||N[this.sector],s=Math.min(this.inventory,Math.floor(this.production*.9));this.revenue=s*i,this.inventory=Math.max(0,this.inventory-s),this.capital+=this.revenue,this.totalRevenue+=this.revenue}_payWages(e){const i=e.minWage||0,o=Math.max(this.wageOffered,i)*this.employees.length;if(this.expenses=o,this.capital-=o,this.profit=this.revenue-this.expenses,this.profitHistory.push(this.profit),this.profitHistory.length>50&&this.profitHistory.shift(),this.profit>0){const a=e.corporateTax||0,n=this.profit*a;this.capital-=n}this.profit>this.revenue*me*2?this.wageOffered=Math.min(this.wageOffered*1.02,100):this.profit<0&&this.employees.length>0&&(this.wageOffered=Math.max(this.wageOffered*.98,i))}_adjustPriceStrategy(e){var o;const i=this.wageOffered;this.employees.length>0&&i*this.employees.length/Math.max(this.production,1);const s=this.inventory/this.maxInventory;s>.8?this.price*=.995:s<.2&&this.production>0&&(this.price*=1.005),(o=e.policies)!=null&&o.antiMonopoly&&this.dominance>.4&&(this.price*=.99)}_adjustWorkforce(e,i){const s=this.production>0?Math.min(this.production/(G[this.sector]*this.maxEmployees*this.productivity),1):0;this.hiringCooldown===0&&this.employees.length<this.maxEmployees&&s>fe&&this.capital>this.wageOffered*20&&this._hire(e),this.firingCooldown===0&&this.employees.length>1&&(s<ge||this.capital<0)&&this._fire(e)}_hire(e){var a;const i=((a=e.agents)==null?void 0:a.filter(n=>n.alive&&!n.employed&&!n.isOwner&&n.state!=="child"&&n.state!=="retired"))||[];if(i.length===0)return;i.sort((n,r)=>r.skill-n.skill);const s=i[0],o=Math.max(this.wageOffered,policies.minWage||0);s.hire(this,o),this.employees.push(s.id),this.hiringCooldown=10,this.events.push(`Hired agent #${s.id}`)}_fire(e){var o;if(this.employees.length===0)return;const i=this.employees[this.employees.length-1];this.employees=this.employees.filter(a=>a!==i);const s=(o=e.agents)==null?void 0:o.find(a=>a.id===i);s&&s.fire("layoff"),this.firingCooldown=15,this.events.push(`Fired agent #${i}`)}_checkBankruptcy(e){this.capital<pe&&this._close(e,"bankruptcy")}_close(e,i){var s,o,a;this.alive=!1,this.events.push(`Closed due to ${i}`);for(const n of this.employees){const r=(s=e.agents)==null?void 0:s.find(c=>c.id===n);r&&r.fire(i)}if(this.employees=[],this.ownerId){const n=(o=e.agents)==null?void 0:o.find(r=>r.id===this.ownerId);n&&(n.isOwner=!1,n.businessId=null,n.events.push(`Business closed (${i}) at age ${Math.floor(n.age/52)}`),(a=n._updateState)==null||a.call(n))}}_updateVisuals(){this.profit>this.revenue*.2?this.pulse=Math.min(1,this.pulse+.05):this.pulse=Math.max(0,this.pulse-.03),this.radius=8+this.employees.length*.5+this.pulse*3}toSnapshot(){return{id:this.id,x:this.x,y:this.y,alive:this.alive,sector:this.sector,name:this.name,capital:this.capital,revenue:this.revenue,profit:this.profit,production:this.production,price:this.price,inventory:this.inventory,employees:[...this.employees],employeeCount:this.employees.length,maxEmployees:this.maxEmployees,wageOffered:this.wageOffered,marketShare:this.marketShare,dominance:this.dominance,productivity:this.productivity,age:this.age,radius:this.radius,pulse:this.pulse,ownerId:this.ownerId}}}function q(t,e,i={}){ne=1;const s=[],o=Math.floor(t/b.length);for(const a of b)for(let n=0;n<o;n++){const r=new oe({sector:a,capital:ee*(i.startCapitalMultiplier||1),productivity:h(g(i.avgProductivity||1,.2),.3,2.5)}),c=e.filter(l=>l.alive&&!l.employed&&!l.isOwner&&l.state!=="child"&&l.state!=="retired"&&l.skill>.4);if(c.length>0){c.sort((d,p)=>p.skill-d.skill);const l=c[0];r.ownerId=l.id,l.isOwner=!0,l.businessId=r.id,l.employed=!0,l.employerId=r.id,l.wage=20,l.jobSector=a,l.state="owner",r.employees.push(l.id)}s.push(r)}return s}function X(){return{prices:{...N},supply:{food:0,housing:0,tech:0,luxury:0},demand:{food:0,housing:0,tech:0,luxury:0},inflation:0,cpi:100,basePrices:{...N}}}function _e(t,e,i){const{agents:s,businesses:o}=e,a=s.filter(l=>l.alive&&l.state!=="child"),n=o.filter(l=>l.alive);let r=0;for(const l of b){const d=n.filter(w=>w.sector===l).reduce((w,C)=>w+C.production,0),p=a.filter(w=>w.employed||w.isOwner),y=p.length>0?p.reduce((w,C)=>w+(C.wage||20),0)/p.length:20,m={food:.15,housing:.25,tech:.1,luxury:.05},v=a.length*y*(m[l]||.1);t.supply[l]=d,t.demand[l]=v;const f=Math.max(d,1),_=(v-f)/f,re=le[l];let S=_*re*.05;l==="food"&&i.priceControlFood&&(S=h(S,-.01,.01)),l==="housing"&&i.priceControlHousing&&(S=h(S,-.01,.01)),i.printMoney>0&&(S+=i.printMoney*1e-4);const B=t.prices[l],W=h(B*(1+h(S,-.08,.08)),he[l],ce[l]);t.prices[l]=W;for(const w of n.filter(C=>C.sector===l))w.price=W;r+=(W-B)/B}const c={food:.35,housing:.35,tech:.15,luxury:.15};return t.cpi=b.reduce((l,d)=>l+t.prices[d]/t.basePrices[d]*c[d]*100,0),t.inflation=r/b.length,Se(n),t}function Se(t){for(const e of b){const i=t.filter(o=>o.sector===e),s=i.reduce((o,a)=>o+a.production,0);if(s!==0)for(const o of i)o.marketShare=o.production/s,o.dominance=o.marketShare}}function ke(t,e){return t.businesses.filter(s=>s.alive).reduce((s,o)=>s+o.production*e.prices[o.sector],0)}function Re(t){const e=t.filter(s=>s.alive&&s.state!=="child"&&s.state!=="retired"&&s.state!=="dead");return e.length===0?0:e.filter(s=>s.state==="unemployed").length/e.length}function Ce(t){const e=t.filter(s=>s.alive&&s.state!=="dead"&&s.state!=="child");return e.length===0?0:e.filter(s=>s.wealth<100).length/e.length}function Ae(t,e){const{agents:i,businesses:s}=t,o=i.filter(n=>n.alive&&n.state==="unemployed"&&n.age>18*52),a=s.filter(n=>n.alive&&n.employees.length<n.maxEmployees&&n.capital>n.wageOffered*10);if(!(o.length===0||a.length===0))for(const n of a){if(o.length===0)break;let r=0,c=-1/0;for(let p=0;p<o.length;p++){const y=o[p],m=y.x-n.x,v=y.y-n.y,f=Math.sqrt(m*m+v*v),_=y.skill*.7+y.education*.3-f*.001;_>c&&(c=_,r=p)}const l=o[r],d=xe(n,l,e);n.capital>d*5&&(l.hire(n,d),n.employees.push(l.id),n.hiringCooldown=10,o.splice(r,1))}}function xe(t,e,i){const s=i.minWage||0,o=t.wageOffered,a=e.skill*10+e.education*5,n=o*(1-U)+a*U;return Math.max(n,s)}function z(t={}){return{...ve,...t}}function Oe(t,e,i){const{agents:s,businesses:o}=t;if(e.minWage>0)for(const a of o.filter(n=>n.alive))a.wageOffered<e.minWage&&(a.wageOffered=e.minWage,a.capital<e.minWage*a.employees.length*20);if(e.antiMonopoly)for(const a of o.filter(n=>n.alive&&n.dominance>.5))a.maxEmployees=Math.max(5,Math.floor(a.maxEmployees*.9));if(e.interestRate>.1)for(const a of o.filter(n=>n.alive))a.capital-=a.capital*e.interestRate*.001;if(e.printMoney>0){const a=e.printMoney,n=s.filter(r=>r.alive&&r.state!=="dead");for(const r of n)r.wealth+=a*.01}if(e.educationFunding>.3){const a=s.filter(n=>n.alive&&n.age<1560&&n.state!=="dead");for(const n of a)Math.random()<e.educationFunding*1e-4&&(n.skill=h(n.skill+.001,0,1),n.education=h(n.education+.001,0,1))}if(e.publicHealthcare&&Math.random()<.001){const a=s.filter(n=>n.alive&&n.health<.5);for(const n of a.slice(0,5))n.health=h(n.health+.01,0,1)}}function Z(){return{tick:0,year:0,gdp:0,gdpGrowth:0,gini:0,unemployment:0,povertyRate:0,cpi:100,inflation:0,avgWage:0,avgWealth:0,medianWealth:0,socialUnrest:0,population:0,businessCount:0,bankruptcies:0,totalTaxRevenue:0,govBudget:0,govDebt:0,history:{gdp:[],gini:[],unemployment:[],cpi:[],population:[],unrest:[]}}}function Ne(t,e,i,s){const{agents:o,businesses:a}=e,n=o.filter(f=>f.alive&&f.state!=="dead"),r=a.filter(f=>f.alive);t.tick++,t.year=Math.floor(t.tick/52),t.population=n.length,t.businessCount=r.length;const c=n.map(f=>Math.max(0,f.wealth));t.gini=be(c),t.avgWealth=$(c),t.medianWealth=Me(c,50);const l=t.gdp;t.gdp=ke(e,i),t.gdpGrowth=l>0?(t.gdp-l)/l:0,t.unemployment=Re(n),t.povertyRate=Ce(n);const d=n.filter(f=>f.employed&&f.wage>0);t.avgWage=d.length>0?d.reduce((f,_)=>f+_.wage,0)/d.length:0,t.cpi=i.cpi,t.inflation=i.inflation*100;const p=n.map(f=>f.unrest);t.socialUnrest=$(p);const y=Be(n,r,s),m=We(n,s);t.totalTaxRevenue=y,t.govBudget=y-m,t.govDebt+=-t.govBudget*.1;const v=t.history;return k(v.gdp,t.gdp),k(v.gini,t.gini),k(v.unemployment,t.unemployment*100),k(v.cpi,t.cpi),k(v.population,t.population),k(v.unrest,t.socialUnrest*100),t}function k(t,e){t.push(Math.round(e*100)/100),t.length>we&&t.shift()}function Be(t,e,i){const s=t.filter(n=>n.employed&&n.wage>0).reduce((n,r)=>n+r.wage*(i.incomeTax||0),0),o=e.filter(n=>n.profit>0).reduce((n,r)=>n+r.profit*(i.corporateTax||0),0),a=t.filter(n=>n.wealth>H).reduce((n,r)=>n+(r.wealth-H)*(i.wealthTax||0),0);return s+o+a}function We(t,e){const s=t.filter(r=>r.state==="unemployed").length*(e.unemploymentBenefit||0)*.1,o=t.filter(r=>r.state!=="child").length*(e.ubi||0)*.01,a=e.publicHealthcare?t.length*.5:0,n=t.length*(e.educationFunding||0)*.2;return s+o+a+n}function Pe(t){return{tick:t.tick,year:t.year,gdp:t.gdp,gdpGrowth:t.gdpGrowth,gini:t.gini,unemployment:t.unemployment,povertyRate:t.povertyRate,cpi:t.cpi,inflation:t.inflation,avgWage:t.avgWage,avgWealth:t.avgWealth,medianWealth:t.medianWealth,socialUnrest:t.socialUnrest,population:t.population,businessCount:t.businessCount,govDebt:t.govDebt,totalTaxRevenue:t.totalTaxRevenue,history:t.history}}const u={PANDEMIC:"pandemic",CROP_FAILURE:"cropFailure",TECH_BREAKTHROUGH:"techBreakthrough",FINANCIAL_BUBBLE:"financialBubble",CORRUPTION:"corruption",IMMIGRATION_WAVE:"immigrationWave",RECESSION:"recession",BOOM:"boom"},He={[u.PANDEMIC]:{name:"Pandemic",description:"A disease sweeps the economy. Health drops, businesses close, workers stay home.",duration:200,icon:"ðŸ¦ ",effects:{healthMultiplier:.7,productionMultiplier:.6,deathRateMultiplier:3,consumerSpendingMultiplier:.5}},[u.CROP_FAILURE]:{name:"Crop Failure",description:"Poor harvests cause food prices to spike. The poor suffer most.",duration:150,icon:"ðŸŒ¾",effects:{foodSupplyMultiplier:.3,foodPriceMultiplier:2.5}},[u.TECH_BREAKTHROUGH]:{name:"Tech Breakthrough",description:"A technology revolution doubles productivity in the tech sector.",duration:300,icon:"ðŸš€",effects:{techProductivityMultiplier:2,techWorkerWageMultiplier:1.5,otherJobsAutomatedRate:.1}},[u.FINANCIAL_BUBBLE]:{name:"Financial Bubble",description:"Asset prices inflate, then violently crash. Wealth evaporates.",duration:250,icon:"ðŸ’¥",effects:{wealthInflationPhase:1.5,wealthCrashPhase:.4}},[u.CORRUPTION]:{name:"Corruption Scandal",description:"Government corruption diverts tax revenue. Public services collapse.",duration:180,icon:"ðŸ’°",effects:{taxRevenueLeakage:.5,publicTrustMultiplier:.6}},[u.IMMIGRATION_WAVE]:{name:"Immigration Wave",description:"Skilled workers arrive, boosting productivity but increasing competition for jobs.",duration:0,icon:"ðŸŒ",effects:{newAgentCount:30,newAgentSkillBonus:.3}},[u.RECESSION]:{name:"Recession",description:"Economic contraction: businesses struggle, unemployment rises, demand drops.",duration:200,icon:"ðŸ“‰",effects:{demandMultiplier:.6,businessCapitalDrain:.02,hiringSuppression:!0}},[u.BOOM]:{name:"Economic Boom",description:"Consumer confidence surges. Spending rises, businesses thrive.",duration:150,icon:"ðŸ“ˆ",effects:{demandMultiplier:1.4,hiringBoost:!0,wageGrowthRate:1.02}}};function J(){return{activeEvents:[],eventHistory:[],lastEventTick:0}}function De(t,e,i,s){t.activeEvents=t.activeEvents.filter(a=>a.definition.duration===0?!0:s-a.startTick<a.definition.duration);const o=Ee*(1-t.activeEvents.length*.3);if(Math.random()<o&&s>t.lastEventTick+100){const a=Ge(t,e,i,s);if(a)return a}for(const a of t.activeEvents)Ue(a,e,i,s);return null}function Ge(t,e,i,s){const o=e.metrics||{},a={[u.PANDEMIC]:1,[u.CROP_FAILURE]:1,[u.TECH_BREAKTHROUGH]:1.5,[u.FINANCIAL_BUBBLE]:o.gini>.5?2:.5,[u.CORRUPTION]:o.govDebt>1e3?2:.5,[u.IMMIGRATION_WAVE]:i.openBorders?3:.5,[u.RECESSION]:o.inflation>5?2:.3,[u.BOOM]:o.unemployment<.05?2:.5},n=Object.keys(a),r=n.map(m=>a[m]),c=r.reduce((m,v)=>m+v,0);let l=Math.random()*c,d=n[0];for(let m=0;m<n.length;m++)if(l-=r[m],l<=0){d=n[m];break}const p=He[d],y={id:`${d}_${s}`,type:d,definition:p,startTick:s,name:p.name,description:p.description,icon:p.icon};return t.activeEvents.push(y),t.eventHistory.push({...y,resolvedTick:s+p.duration}),t.lastEventTick=s,Le(y,e),y}function Le(t,e){const{effects:i}=t.definition,s=e.agents.filter(a=>a.alive),o=e.businesses.filter(a=>a.alive);switch(t.type){case u.PANDEMIC:for(const a of s)a.health*=.8+Math.random()*.2,a.health=h(a.health,.1,1);break;case u.IMMIGRATION_WAVE:t._spawnAgents=i.newAgentCount,t._spawnSkillBonus=i.newAgentSkillBonus;break;case u.FINANCIAL_BUBBLE:t.phase="inflate",t.phaseStartTick=t.startTick;break;case u.TECH_BREAKTHROUGH:for(const a of o.filter(n=>n.sector==="tech"))a.productivity*=i.techProductivityMultiplier;break}}function Ue(t,e,i,s){const{effects:o}=t.definition,a=s-t.startTick,n=t.definition.duration>0?a/t.definition.duration:0;switch(t.type){case u.PANDEMIC:if(Math.random()<.01)for(const r of e.businesses.filter(c=>c.alive))r.capital-=r.capital*.005;break;case u.FINANCIAL_BUBBLE:if(n<.5){if(Math.random()<.05)for(const r of e.agents.filter(c=>c.alive&&c.wealth>500))r.wealth*=1.01}else if(t.phase==="inflate"){t.phase="crash";for(const r of e.agents.filter(c=>c.alive))r.wealth*=o.wealthCrashPhase+Math.random()*.3}break;case u.RECESSION:if(Math.random()<.1)for(const r of e.businesses.filter(c=>c.alive))r.capital-=r.capital*o.businessCapitalDrain;break;case u.BOOM:if(Math.random()<.05)for(const r of e.businesses.filter(c=>c.alive))r.wageOffered*=o.wageGrowthRate;break}}class Fe{constructor(e={}){this.tick=0,this.running=!1,this.speed=1,this.scenario=e,this.policies=z(e.policies||{}),this.market=X(),this.metrics=Z(),this.eventsState=J(),this.agents=j(e.agentCount||200,e),this.businesses=q(e.businessCount||L,this.agents,e),this._pendingMessages=[]}applyMessage(e){switch(e.type){case"SET_POLICY":this.policies[e.policy]=e.value;break;case"SET_SPEED":this.speed=e.speed;break;case"RESET":this._reset(e.scenario);break;case"PAUSE":this.running=!1;break;case"RESUME":this.running=!0;break}}_reset(e){const i=se(e)||{};this.tick=0,this.policies=z(i.policies||{}),this.market=X(),this.metrics=Z(),this.eventsState=J(),this.agents=j(i.agentCount||200,i),this.businesses=q(i.businessCount||L,this.agents,i)}step(){this.tick++;const e=this._buildState();for(const o of this.agents)o.alive&&o.tick(e,this.policies);for(const o of this.businesses)o.alive&&o.tick(e,this.policies);this.tick%5===0&&Ae(e,this.policies),_e(this.market,e,this.policies),Oe(e,this.policies,this.market);const i=De(this.eventsState,e,this.policies,this.tick);i&&i._spawnAgents&&this._spawnImmigrants(i._spawnAgents,i._spawnSkillBonus),this.tick%52===0&&this._processBirths(),this._cleanup(),this._processNewBusinesses(e),this.tick%Ie===0&&Ne(this.metrics,e,this.market,this.policies);const s=this._checkInsights();return{shouldUpdate:this.tick%3===0,event:i,insight:s}}_buildState(){return{agents:this.agents,businesses:this.businesses,policies:this.policies,market:this.market,metrics:this.metrics}}_processBirths(){const e=this.agents.filter(i=>i.alive&&i.age>1040&&i.age<2340);for(const i of e)if(Math.random()<.02&&this.agents.filter(s=>s.alive).length<500){const s=new D({x:i.x+(Math.random()-.5)*20,y:i.y+(Math.random()-.5)*20,age:0,skill:h(g(i.skill,.15),.1,1),education:0,wealth:10,parentWealth:i.wealth,bornInYear:Math.floor(this.tick/52)});this.agents.push(s)}}_spawnImmigrants(e,i){for(let s=0;s<e;s++){const o=new D({skill:h(g(.6+i,.15),.3,1),education:h(g(.6,.2),.2,1),wealth:h(g(300,100),50,800),bornInYear:Math.floor(this.tick/52)});this.agents.push(o)}}_processNewBusinesses(e){const i=this.agents.filter(s=>s._wantsToStartBusiness);for(const s of i){if(delete s._wantsToStartBusiness,this.businesses.filter(r=>r.alive).length>=80||s.wealth<300)continue;const{SECTORS:o}={SECTORS:["food","housing","tech","luxury"]},a=o[Math.floor(Math.random()*o.length)],n=new oe({sector:a,capital:s.wealth*.5,ownerId:s.id,productivity:h(g(s.skill,.2),.3,2)});s.wealth*=.5,s.isOwner=!0,s.businessId=n.id,s.employed=!0,s.employerId=n.id,s.wage=20,s.jobSector=a,n.employees.push(s.id),this.businesses.push(n),s.events.push(`Started ${n.name} at age ${Math.floor(s.age/52)}`)}}_cleanup(){this.agents=this.agents.filter(e=>e.alive),this.businesses=this.businesses.filter(e=>e.alive)}_checkInsights(){var s;const e=this.metrics;if(this._lastInsightTick&&this.tick-this._lastInsightTick<100)return null;const i=[{id:"monopoly_forming",condition:()=>this.businesses.some(o=>o.dominance>.6),title:"Monopoly Forming",body:"One business controls over 60% of a market. Competition disappears, prices rise, and innovation stalls.",realWorld:"This mirrors Standard Oil in 1911 or modern big tech. Anti-monopoly policy can break this up â€” but at what cost to efficiency?"},{id:"high_inequality",condition:()=>e.gini>.55,title:"Extreme Inequality",body:`Gini coefficient hit ${(e.gini*100).toFixed(0)}. The top 10% own most of the wealth. Social unrest is rising.`,realWorld:"Research shows high inequality reduces social mobility, increases crime, and can destabilize democracies. Nordic countries maintain ~0.28 Gini through redistribution."},{id:"high_unemployment",condition:()=>e.unemployment>.2,title:"Mass Unemployment",body:`${(e.unemployment*100).toFixed(0)}% unemployment. Businesses can't afford wages; workers can't find jobs.`,realWorld:"The Great Depression peaked at 25% US unemployment. Keynes argued government spending could break the cycle."},{id:"inflation_spiral",condition:()=>e.inflation>8,title:"Inflation Spiral",body:"Prices are rising fast. Your money buys less each tick. Real wages are falling.",realWorld:"Zimbabwe (2008) and Venezuela (2018) experienced hyperinflation from excessive money printing. Central banks fight this with higher interest rates."},{id:"min_wage_tradeoff",condition:()=>this.policies.minWage>15&&e.unemployment>.15,title:"Minimum Wage Tradeoff",body:"Minimum wage is high AND unemployment is rising. Small businesses can't afford to hire.",realWorld:"The minimum wage debate: living wages vs. employment effects. Studies show it depends heavily on local cost of living and business type."},{id:"budget_surplus",condition:()=>e.govBudget>500&&e.govDebt<0,title:"Fiscal Surplus",body:"The government is running a surplus! Tax revenue exceeds spending. Debt is falling.",realWorld:"Budget surpluses allow debt reduction and investment in public goods â€” but may slow demand if taxes are too high."},{id:"stagnation",condition:()=>e.gdpGrowth<0&&e.unemployment>.12,title:"Stagflation Risk",body:"GDP is shrinking and unemployment is rising simultaneously. The classic policy dilemma.",realWorld:"The 1970s oil crisis created stagflation. Cutting interest rates helps unemployment but worsens inflation. Raising them helps inflation but worsens unemployment."}];for(const o of i)if(o.condition()&&((s=this._firedInsights)==null?void 0:s.has(o.id))!==!0)return this._firedInsights||(this._firedInsights=new Set),this._firedInsights.add(o.id),this._lastInsightTick=this.tick,{id:o.id,title:o.title,body:o.body,realWorld:o.realWorld,tick:this.tick,year:Math.floor(this.tick/52)};return null}getSnapshot(){return{tick:this.tick,year:Math.floor(this.tick/52),agents:this.agents.map(e=>e.toSnapshot()),businesses:this.businesses.map(e=>e.toSnapshot()),metrics:Pe(this.metrics),market:{prices:{...this.market.prices},supply:{...this.market.supply},demand:{...this.market.demand},cpi:this.market.cpi,inflation:this.market.inflation},policies:{...this.policies},activeEvents:this.eventsState.activeEvents.map(e=>({id:e.id,name:e.name,icon:e.icon,description:e.description,startTick:e.startTick}))}}}let I=null,R=!1,ae=1,M=null;function Q(t="freeMarket"){const e=se(t);I=new Fe(e),R=!0}function O(t){if(!R||!I)return;const e=ae;let i=null,s=null;for(let a=0;a<e;a++){const n=I.step();n.event&&(i=n.event),n.insight&&(s=n.insight)}const o=I.getSnapshot();self.postMessage({type:"STATE_UPDATE",state:o}),i&&self.postMessage({type:"EVENT",event:i}),s&&self.postMessage({type:"INSIGHT",insight:s}),M=setTimeout(O,1e3/60)}self.addEventListener("message",t=>{const e=t.data;switch(e.type){case"INIT":Q(e.scenarioId||"freeMarket"),O();break;case"SET_POLICY":I&&I.applyMessage(e);break;case"SET_SPEED":ae=e.speed;break;case"PAUSE":R=!1,M&&(clearTimeout(M),M=null);break;case"RESUME":R||(R=!0,O());break;case"RESET":R=!1,M&&(clearTimeout(M),M=null),Q(e.scenarioId||"freeMarket"),O();break;case"GET_SNAPSHOT":I&&self.postMessage({type:"STATE_UPDATE",state:I.getSnapshot()});break}});
